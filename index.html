<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#D97757">
  <title>Bozzone Tasks</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="icon.svg">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <!-- SortableJS â€” touch-friendly drag & drop -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.3/Sortable.min.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --accent: #D97757;
      --accent-light: #fff3ec;
      --accent-dark: #7a3a1e;
      --bg: #faf9f5;
      --card-bg: #fff;
      --card-header-bg: #f5f4ef;
      --border: #e5e4df;
      --text: #141413;
      --text-sec: #888;
      --text-muted: #aaa;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 12px;
      padding-bottom: calc(80px + var(--safe-bottom));
      min-height: 100vh;
      min-height: 100dvh;
      -webkit-tap-highlight-color: transparent;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid var(--accent);
      padding-bottom: 10px;
      margin-bottom: 14px;
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 100;
      padding-top: env(safe-area-inset-top, 4px);
    }
    header h1 {
      font-size: 1.1rem;
      color: var(--accent);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .hdr-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }
    .sync-dot {
      width: 9px; height: 9px;
      border-radius: 50%;
      background: #ccc;
      transition: background .3s;
    }
    .sync-dot.on  { background: #4CAF50; }
    .sync-dot.wait { background: #FFC107; }
    .sync-dot.off  { background: #F44336; }
    .key-label {
      font-size: .7rem;
      color: var(--text-sec);
      cursor: pointer;
    }
    .gear {
      background: none; border: none;
      font-size: 1.15rem; cursor: pointer;
      padding: 4px; opacity: .45;
    }
    .gear:hover, .gear:active { opacity: 1; }

    /* â”€â”€ Focus Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .focus {
      background: var(--accent-light);
      border-left: 4px solid var(--accent);
      padding: 9px 12px;
      border-radius: 4px;
      margin-bottom: 14px;
      font-size: .84rem;
      color: var(--accent-dark);
      line-height: 1.4;
    }

    /* â”€â”€ Overall Progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .overall {
      margin-bottom: 14px;
      padding: 10px 14px;
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,.07);
    }
    .overall-top {
      display: flex;
      justify-content: space-between;
      font-size: .82rem;
      margin-bottom: 5px;
      color: var(--text-sec);
    }
    .bar-wrap {
      background: #eee;
      border-radius: 6px;
      height: 7px;
      overflow: hidden;
    }
    .bar {
      height: 100%;
      background: var(--accent);
      border-radius: 6px;
      transition: width .35s ease;
    }

    /* â”€â”€ Filter Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .filter-bar {
      display: flex;
      gap: 7px;
      margin-bottom: 14px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding: 2px 0;
      scrollbar-width: none;
      align-items: center;
    }
    .filter-bar::-webkit-scrollbar { display: none; }
    .filter-btn {
      flex-shrink: 0;
      padding: 5px 13px;
      border-radius: 18px;
      border: 1.5px solid var(--border);
      background: var(--card-bg);
      font-size: .76rem;
      font-family: inherit;
      cursor: pointer;
      color: var(--text-sec);
      transition: all .2s;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .filter-btn:active { transform: scale(.96); }
    .filter-btn.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .filter-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .filter-count {
      font-size: .68rem;
      opacity: .75;
    }
    .filter-manage-btn {
      flex-shrink: 0;
      width: 28px; height: 28px;
      border-radius: 50%;
      border: 1.5px dashed var(--border);
      background: none;
      font-size: .9rem;
      cursor: pointer;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .filter-manage-btn:active { background: var(--accent-light); }

    /* â”€â”€ Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }
    @media (min-width: 700px)  { .grid { grid-template-columns: repeat(2,1fr); } body { padding: 20px; } header h1 { font-size: 1.35rem; } }
    @media (min-width: 1100px) { .grid { grid-template-columns: repeat(3,1fr); } }

    /* â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,.07);
      overflow: hidden;
    }
    .card-hd {
      background: var(--card-header-bg);
      padding: 11px 14px;
      font-weight: 600;
      font-size: .88rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-hd .badge {
      background: var(--accent);
      color: #fff;
      font-size: .7rem;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 500;
      flex-shrink: 0;
    }
    .card-bd { padding: 10px 14px; }
    .priority .card-hd {
      background: var(--accent-light);
      border-bottom-color: #f8d5c2;
    }

    /* â”€â”€ Section title (editable) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sec-title {
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: pointer;
      border-radius: 4px;
      padding: 1px 4px;
      margin: -1px -4px;
      transition: background .15s;
    }
    .sec-title:hover { background: rgba(0,0,0,.04); }
    .sec-title-input {
      font-size: .88rem;
      font-weight: 600;
      font-family: inherit;
      border: 1.5px solid var(--accent);
      border-radius: 4px;
      padding: 2px 6px;
      outline: none;
      flex: 1;
      min-width: 0;
      background: #fff;
    }

    /* â”€â”€ Section header actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sec-actions {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }
    .sec-del {
      background: none; border: none;
      color: #ccc; font-size: .95rem;
      cursor: pointer; padding: 2px 4px;
      border-radius: 4px; line-height: 1;
      transition: color .15s;
    }
    .sec-del:hover, .sec-del:active { color: #e74c3c; }

    /* â”€â”€ Add Column Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .add-col-card {
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,.04);
      border: 2px dashed var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100px;
      cursor: pointer;
      transition: border-color .2s, background .2s;
      padding: 20px;
    }
    .add-col-card:hover, .add-col-card:active {
      border-color: var(--accent);
      background: var(--accent-light);
    }
    .add-col-card.expanded {
      cursor: default;
      border-color: var(--accent);
      align-items: stretch;
    }
    .add-col-card.expanded:hover { background: var(--card-bg); }
    .add-col-icon { font-size: 1.8rem; color: var(--text-muted); margin-bottom: 4px; }
    .add-col-label { font-size: .82rem; color: var(--text-sec); }
    .add-col-form { width: 100%; }
    .add-col-form input {
      width: 100%; padding: 10px;
      border: 1.5px solid #ddd; border-radius: 6px;
      font-size: .86rem; font-family: inherit;
      margin-bottom: 8px; outline: none;
    }
    .add-col-form input:focus { border-color: var(--accent); }
    .add-col-form label {
      font-size: .75rem; color: var(--text-sec);
      display: block; margin-bottom: 4px;
    }
    .emoji-row {
      display: flex; flex-wrap: wrap;
      gap: 5px; margin-bottom: 10px;
    }
    .emoji-pick {
      width: 32px; height: 32px;
      border: 1.5px solid var(--border); border-radius: 6px;
      background: var(--card-bg); font-size: 1rem;
      cursor: pointer; display: flex;
      align-items: center; justify-content: center;
    }
    .emoji-pick.sel {
      border-color: var(--accent);
      background: var(--accent-light);
    }
    .add-col-btns { display: flex; gap: 8px; }
    .add-col-btns button {
      flex: 1; padding: 10px; border-radius: 6px;
      font-size: .84rem; font-family: inherit;
      cursor: pointer; font-weight: 600;
    }
    .btn-create { background: var(--accent); color: #fff; border: none; }
    .btn-create:active { opacity: .85; }
    .btn-cancel { background: none; border: 1.5px solid var(--border); color: var(--text-sec); }

    /* â”€â”€ Progress per card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .prog-wrap {
      background: #eee; border-radius: 4px;
      height: 4px; margin: 6px 0 3px; overflow: hidden;
    }
    .prog {
      height: 100%; background: var(--accent);
      border-radius: 4px; transition: width .35s ease;
    }
    .prog-lbl {
      font-size: .7rem; color: var(--text-muted);
      text-align: right; margin-bottom: 4px;
    }

    /* â”€â”€ Task list (sortable container) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .task-list { min-height: 8px; }
    .task-empty {
      padding: 12px 0; text-align: center;
      font-size: .8rem; color: var(--text-muted);
      font-style: italic;
    }

    /* â”€â”€ Tasks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .task {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      padding: 8px 0;
      border-bottom: 1px solid #f0efea;
      font-size: .86rem;
      line-height: 1.42;
      background: var(--card-bg);
    }
    .task:last-child { border-bottom: none; }

    .task input[type="checkbox"] {
      margin: 2px 0 0 0;
      accent-color: var(--accent);
      width: 18px; height: 18px;
      flex-shrink: 0;
      cursor: pointer;
    }
    .task-content {
      flex: 1;
      min-width: 0;
    }
    .task-content label {
      cursor: pointer;
      color: #333;
      user-select: none;
      -webkit-user-select: none;
      word-break: break-word;
      display: block;
    }
    .task.done .task-content label {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    /* â”€â”€ Tag badges on tasks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tag-badges {
      display: flex;
      gap: 3px;
      flex-wrap: wrap;
      margin-top: 3px;
    }
    .tag-badge {
      font-size: .58rem;
      padding: 1px 7px;
      border-radius: 8px;
      color: #fff;
      font-weight: 600;
      white-space: nowrap;
      line-height: 1.6;
      letter-spacing: .02em;
    }

    /* â”€â”€ Task action buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .task-actions {
      display: flex;
      align-items: center;
      gap: 2px;
      flex-shrink: 0;
      margin-top: 1px;
    }
    .tag-btn {
      background: none; border: none;
      font-size: .72rem; cursor: pointer;
      padding: 3px 4px; color: #ccc;
      flex-shrink: 0; line-height: 1;
      transition: color .15s;
    }
    .tag-btn:hover, .tag-btn:active { color: var(--accent); }

    /* Drag handle */
    .drag-handle {
      cursor: grab;
      color: #c5c5c5;
      font-size: .95rem;
      padding: 4px 4px 4px 0;
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
      flex-shrink: 0;
      line-height: 1;
      margin-top: 1px;
    }
    .drag-handle:active { cursor: grabbing; color: var(--accent); }

    /* Delete button */
    .del-btn {
      background: none; border: none;
      color: #ccc; font-size: 1.1rem;
      cursor: pointer; padding: 3px 5px;
      border-radius: 4px; flex-shrink: 0;
      line-height: 1; transition: color .15s;
    }
    .del-btn:hover, .del-btn:active { color: #e74c3c; }

    @media (hover: hover) {
      .del-btn, .tag-btn { opacity: 0; transition: opacity .15s, color .15s; }
      .task:hover .del-btn, .task:hover .tag-btn { opacity: 1; }
    }

    /* SortableJS states */
    .task-ghost {
      opacity: .35;
      background: var(--accent-light);
      border-radius: 6px;
    }
    .task-chosen {
      background: #fff;
      box-shadow: 0 4px 16px rgba(0,0,0,.12);
      border-radius: 6px;
    }

    /* â”€â”€ Add-task row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .add-row {
      display: flex;
      gap: 6px;
      padding-top: 8px;
      margin-top: 4px;
      border-top: 1px dashed var(--border);
    }
    .add-input {
      flex: 1;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 8px 10px;
      font-size: .82rem;
      font-family: inherit;
      outline: none;
      min-width: 0;
    }
    .add-input:focus { border-color: var(--accent); }
    .add-input::placeholder { color: #c0c0c0; }
    .add-btn {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      width: 36px;
      font-size: 1.25rem;
      cursor: pointer;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .add-btn:active { opacity: .85; }

    /* â”€â”€ Toast (undo) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .toast {
      position: fixed;
      bottom: calc(20px + var(--safe-bottom));
      left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: #333;
      color: #fff;
      padding: 11px 18px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 14px;
      font-size: .86rem;
      box-shadow: 0 4px 20px rgba(0,0,0,.3);
      transition: transform .3s ease;
      z-index: 500;
      white-space: nowrap;
    }
    .toast.show { transform: translateX(-50%) translateY(0); }
    .toast-undo {
      background: none; border: none;
      color: var(--accent); font-weight: 700;
      font-size: .86rem; cursor: pointer; padding: 0;
    }

    /* â”€â”€ Tag Picker Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tp-ov {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.35);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 900;
      padding: 20px;
    }
    .tp-ov.show { display: flex; }
    @media (min-width: 600px) {
      .tp-ov { align-items: center; }
    }
    .tp-box {
      background: #fff;
      border-radius: 14px 14px 0 0;
      padding: 18px;
      max-width: 340px;
      width: 100%;
      box-shadow: 0 -4px 24px rgba(0,0,0,.12);
      max-height: 60vh;
      overflow-y: auto;
    }
    @media (min-width: 600px) {
      .tp-box { border-radius: 14px; }
    }
    .tp-title {
      font-size: .92rem; font-weight: 600;
      margin-bottom: 10px; color: var(--text);
    }
    .tp-item {
      display: flex; align-items: center;
      gap: 10px; padding: 10px 6px;
      border-radius: 6px; cursor: pointer;
      transition: background .12s;
    }
    .tp-item:hover { background: #f5f5f5; }
    .tp-item:active { background: #eee; }
    .tp-dot {
      width: 14px; height: 14px;
      border-radius: 50%; flex-shrink: 0;
    }
    .tp-name { flex: 1; font-size: .86rem; }
    .tp-check { font-size: 1rem; color: var(--accent); }
    .tp-empty {
      font-size: .82rem; color: var(--text-muted);
      text-align: center; padding: 14px 0;
      font-style: italic;
    }

    /* â”€â”€ Tag Management Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tm-ov {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .tm-ov.show { display: flex; }
    .tm-box {
      background: #fff;
      border-radius: 14px;
      padding: 22px 18px;
      max-width: 380px;
      width: 100%;
      box-shadow: 0 8px 32px rgba(0,0,0,.2);
      max-height: 80vh;
      overflow-y: auto;
    }
    .tm-box h2 {
      color: var(--accent);
      margin-bottom: 14px;
      font-size: 1.05rem;
    }
    .tm-list { margin-bottom: 14px; }
    .tm-item {
      display: flex; align-items: center;
      gap: 8px; padding: 8px 4px;
      border-bottom: 1px solid #f0f0f0;
    }
    .tm-color {
      width: 18px; height: 18px;
      border-radius: 50%; flex-shrink: 0;
    }
    .tm-name { flex: 1; font-size: .86rem; }
    .tm-del {
      background: none; border: none;
      color: #ccc; font-size: 1.05rem;
      cursor: pointer; padding: 2px 6px;
    }
    .tm-del:hover { color: #e74c3c; }
    .tm-divider {
      height: 1px; background: var(--border);
      margin: 10px 0;
    }
    .tm-subtitle {
      font-size: .82rem; font-weight: 600;
      color: var(--text-sec); margin-bottom: 8px;
    }
    .tm-add-row {
      display: flex; gap: 6px; margin-bottom: 8px;
    }
    .tm-add-input {
      flex: 1; padding: 8px 10px;
      border: 1.5px solid #ddd; border-radius: 6px;
      font-size: .84rem; font-family: inherit; outline: none;
    }
    .tm-add-input:focus { border-color: var(--accent); }
    .tm-colors {
      display: flex; gap: 6px;
      flex-wrap: wrap; margin-bottom: 10px;
    }
    .tm-color-opt {
      width: 26px; height: 26px;
      border-radius: 50%;
      border: 2.5px solid transparent;
      cursor: pointer;
      transition: border-color .15s, transform .15s;
    }
    .tm-color-opt:hover { transform: scale(1.12); }
    .tm-color-opt.sel { border-color: var(--text); }
    .tm-add-btn {
      background: var(--accent); color: #fff;
      border: none; border-radius: 6px;
      padding: 8px 16px; font-size: .84rem;
      cursor: pointer; font-weight: 600;
      width: 100%;
    }
    .tm-add-btn:active { opacity: .85; }
    .tm-close {
      width: 100%; padding: 10px;
      background: none; border: 1.5px solid var(--border);
      border-radius: 8px; font-size: .88rem;
      cursor: pointer; color: var(--text-sec);
      margin-top: 8px; font-family: inherit;
    }

    /* â”€â”€ CSV Import Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .csv-ov {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .csv-ov.show { display: flex; }
    .csv-box {
      background: #fff;
      border-radius: 14px;
      padding: 22px 18px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 8px 32px rgba(0,0,0,.2);
      max-height: 80vh;
      overflow-y: auto;
    }
    .csv-box h2 { color: var(--accent); margin-bottom: 6px; font-size: 1.05rem; }
    .csv-box p { font-size: .82rem; color: var(--text-sec); margin-bottom: 12px; line-height: 1.5; }
    .csv-sec-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 10px; border-radius: 6px; margin-bottom: 4px;
      font-size: .84rem;
    }
    .csv-sec-item.new-sec  { background: #f0fff4; }
    .csv-sec-item.exist-sec { background: #f5f4ef; }
    .csv-sec-badge {
      font-size: .68rem; padding: 2px 8px; border-radius: 10px;
      font-weight: 600; white-space: nowrap; flex-shrink: 0; margin-left: 8px;
    }
    .csv-sec-badge.new   { background: #4CAF50; color: #fff; }
    .csv-sec-badge.exist { background: var(--accent); color: #fff; }
    .csv-hint {
      font-size: .76rem; color: var(--text-muted);
      background: #f8f8f8; border-radius: 6px;
      padding: 8px 10px; margin-bottom: 12px; line-height: 1.5;
    }
    .csv-hint code { font-size: .74rem; background: #eee; padding: 1px 4px; border-radius: 3px; }
    .csv-actions { display: flex; gap: 8px; margin-top: 14px; }
    .csv-actions button {
      flex: 1; padding: 10px; border-radius: 6px;
      font-size: .86rem; font-family: inherit;
      cursor: pointer; font-weight: 600;
    }
    .csv-btn-confirm { background: var(--accent); color: #fff; border: none; }
    .csv-btn-confirm:active { opacity: .85; }
    .csv-btn-cancel  { background: none; border: 1.5px solid var(--border); color: var(--text-sec); }

    /* â”€â”€ Search Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .search-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #fff;
      border: 1.5px solid var(--border);
      border-radius: 10px;
      padding: 8px 12px;
      margin-bottom: 12px;
    }
    .search-wrap:focus-within { border-color: var(--accent); }
    .search-icon { font-size: 1rem; color: var(--text-muted); flex-shrink: 0; }
    #searchInput {
      flex: 1; border: none; outline: none;
      font-size: .88rem; font-family: inherit;
      background: transparent; color: var(--text);
      min-width: 0;
    }
    #searchInput::placeholder { color: var(--text-muted); }
    .search-clear {
      background: none; border: none;
      color: var(--text-muted); font-size: 1rem;
      cursor: pointer; padding: 0 2px;
      display: none;
    }
    .search-clear.show { display: block; }

    /* â”€â”€ Status Button (replaces checkbox) â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .status-btn {
      width: 22px; height: 22px;
      border-radius: 50%;
      border: 2px solid #ccc;
      background: none;
      cursor: pointer;
      font-size: .75rem;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      transition: border-color .15s, background .15s, color .15s;
      padding: 0;
      line-height: 1;
      color: transparent;
    }
    .status-btn[data-status="todo"]       { border-color: #bbb; color: transparent; background: #fff; }
    .status-btn[data-status="inprogress"] { border-color: var(--accent); color: var(--accent); background: #fff3ec; font-size: .7rem; }
    .status-btn[data-status="done"]       { border-color: #27AE60; color: #fff; background: #27AE60; }
    .status-btn:hover { opacity: .8; }

    /* Task done-state via status */
    .task.status-done > .task-content > label { text-decoration: line-through; color: var(--text-muted); }
    .task.status-done { opacity: .72; }

    /* â”€â”€ Priority border â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .task[data-priority="high"]   { border-left: 3px solid #e74c3c; padding-left: 7px; }
    .task[data-priority="medium"] { border-left: 3px solid #F39C12; padding-left: 7px; }
    .task[data-priority="low"]    { border-left: 3px solid #27AE60; padding-left: 7px; }

    /* â”€â”€ Due Date Chip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .due-chip {
      display: inline-block;
      font-size: .7rem;
      color: var(--text-sec);
      background: #f0f0ec;
      border-radius: 10px;
      padding: 1px 7px;
      margin-top: 3px;
      white-space: nowrap;
    }
    .due-chip.today   { background: #FFF3CD; color: #856404; font-weight: 600; }
    .due-chip.overdue { background: #fde8e8; color: #c0392b; font-weight: 600; }

    /* â”€â”€ Subtask display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .subtask-summary {
      font-size: .72rem; color: var(--accent);
      cursor: pointer; margin-top: 3px;
      display: inline-block;
      user-select: none;
    }
    .subtask-summary:hover { text-decoration: underline; }
    .subtask-list {
      margin-top: 6px;
      border-top: 1px dashed var(--border);
      padding-top: 6px;
      display: none;
    }
    .subtask-list.open { display: block; }
    .subtask-item {
      display: flex; align-items: center; gap: 6px;
      padding: 3px 0;
      font-size: .8rem;
    }
    .subtask-item input[type="checkbox"] {
      width: 14px; height: 14px;
      cursor: pointer; flex-shrink: 0;
      accent-color: var(--accent);
    }
    .subtask-item label {
      flex: 1; cursor: pointer;
      color: var(--text);
      text-decoration: none;
    }
    .subtask-item.done label { text-decoration: line-through; color: var(--text-muted); }
    .subtask-del {
      background: none; border: none;
      color: #ccc; font-size: .9rem;
      cursor: pointer; padding: 0 3px;
      line-height: 1;
    }
    .subtask-del:hover { color: #e74c3c; }
    .subtask-add-row {
      display: flex; gap: 5px; margin-top: 5px;
    }
    .subtask-add-input {
      flex: 1; border: 1px solid #ddd;
      border-radius: 5px; padding: 4px 8px;
      font-size: .78rem; font-family: inherit;
      outline: none; min-width: 0;
    }
    .subtask-add-input:focus { border-color: var(--accent); }
    .subtask-add-btn {
      background: var(--accent); color: #fff;
      border: none; border-radius: 5px;
      padding: 4px 9px; font-size: .82rem;
      cursor: pointer;
    }

    /* â”€â”€ New Task Row (replaces add-row) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .add-task-row {
      display: flex;
      align-items: center;
      padding-top: 8px;
      margin-top: 4px;
      border-top: 1px dashed var(--border);
    }
    .add-task-btn {
      display: flex; align-items: center; gap: 6px;
      background: none; border: none;
      color: var(--accent); font-size: .84rem;
      cursor: pointer; padding: 4px 2px;
      font-family: inherit; font-weight: 600;
    }
    .add-task-btn:hover { opacity: .8; }

    /* â”€â”€ New Task Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .nt-ov {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1100;
      padding: 20px;
    }
    .nt-ov.show { display: flex; }
    .nt-box {
      background: #fff;
      border-radius: 14px;
      padding: 22px 18px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 8px 32px rgba(0,0,0,.22);
      max-height: 90vh;
      overflow-y: auto;
    }
    .nt-box h2 {
      color: var(--accent); font-size: 1.05rem;
      margin-bottom: 14px;
    }
    .nt-field {
      margin-bottom: 12px;
    }
    .nt-field label {
      display: block; font-size: .78rem;
      font-weight: 600; color: var(--text-sec);
      margin-bottom: 4px; text-transform: uppercase;
      letter-spacing: .04em;
    }
    .nt-field input[type="text"],
    .nt-field input[type="date"],
    .nt-field textarea,
    .nt-field select {
      width: 100%; padding: 9px 11px;
      border: 1.5px solid #ddd; border-radius: 7px;
      font-size: .88rem; font-family: inherit;
      outline: none; background: #fff;
      color: var(--text);
    }
    .nt-field input:focus,
    .nt-field textarea:focus,
    .nt-field select:focus { border-color: var(--accent); }
    .nt-field textarea { min-height: 64px; resize: vertical; }
    .nt-row {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 10px; margin-bottom: 12px;
    }
    .nt-subtask-list { margin-bottom: 8px; }
    .nt-subtask-item {
      display: flex; align-items: center; gap: 6px;
      padding: 4px 0; font-size: .84rem;
      border-bottom: 1px solid #f0f0f0;
    }
    .nt-subtask-item span { flex: 1; }
    .nt-subtask-del {
      background: none; border: none;
      color: #ccc; font-size: .9rem;
      cursor: pointer; padding: 0 4px;
    }
    .nt-subtask-del:hover { color: #e74c3c; }
    .nt-subtask-add {
      display: flex; gap: 6px; margin-top: 6px;
    }
    .nt-subtask-add input {
      flex: 1; padding: 7px 10px;
      border: 1.5px solid #ddd; border-radius: 6px;
      font-size: .82rem; font-family: inherit; outline: none;
    }
    .nt-subtask-add input:focus { border-color: var(--accent); }
    .nt-subtask-add button {
      background: var(--accent); color: #fff;
      border: none; border-radius: 6px;
      padding: 7px 12px; font-size: .82rem;
      cursor: pointer; font-weight: 600;
    }
    .nt-actions {
      display: flex; gap: 8px; margin-top: 16px;
    }
    .nt-actions button {
      flex: 1; padding: 11px; border-radius: 7px;
      font-size: .88rem; font-family: inherit;
      cursor: pointer; font-weight: 600;
    }
    .nt-create { background: var(--accent); color: #fff; border: none; }
    .nt-create:active { opacity: .85; }
    .nt-cancel  { background: none; border: 1.5px solid var(--border); color: var(--text-sec); }

    /* â”€â”€ Overlay (sync-key setup) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .ov {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .ov-box {
      background: #fff;
      border-radius: 14px;
      padding: 28px 22px;
      max-width: 380px;
      width: 100%;
      box-shadow: 0 8px 32px rgba(0,0,0,.2);
    }
    .ov-box h2 {
      color: var(--accent);
      margin-bottom: 10px;
      font-size: 1.15rem;
    }
    .ov-box p {
      font-size: .88rem; color: #555;
      margin-bottom: 14px; line-height: 1.5;
    }
    .ov-box input {
      width: 100%; padding: 12px;
      border: 2px solid #ddd; border-radius: 8px;
      font-size: 1rem; text-align: center;
      font-family: monospace; letter-spacing: 2px;
      margin-bottom: 12px;
    }
    .ov-box input:focus { outline: none; border-color: var(--accent); }
    .ov-box button {
      width: 100%; padding: 12px;
      background: var(--accent); color: #fff;
      border: none; border-radius: 8px;
      font-size: 1rem; font-weight: 600; cursor: pointer;
    }
    .ov-box button:active { opacity: .9; }

    /* â”€â”€ Config banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .cfg-banner {
      background: #FFF3CD;
      border: 1px solid #FFEEBA;
      border-radius: 10px;
      padding: 20px 16px;
      margin-bottom: 16px;
    }
    .cfg-banner h2 { color: #856404; font-size: 1rem; margin-bottom: 6px; }
    .cfg-banner p  { color: #856404; font-size: .85rem; line-height: 1.5; }
    .cfg-banner code {
      background: #f8f0d8; padding: 1px 5px;
      border-radius: 3px; font-size: .82rem;
    }
  </style>
</head>
<body>

<header>
  <h1>Bozzone Tasks</h1>
  <div class="hdr-right">
    <div class="sync-dot" id="dot" title="Sync status"></div>
    <span class="key-label" id="keyLbl" title="Click to change sync key"></span>
    <button class="gear" id="gearBtn" title="Settings">&#9881;</button>
  </div>
</header>

<!-- Search bar -->
<div class="search-wrap">
  <span class="search-icon">ğŸ”</span>
  <input type="text" id="searchInput" placeholder="Search tasksâ€¦" autocomplete="off">
  <button class="search-clear" id="searchClear" title="Clear search">&times;</button>
</div>

<div class="focus">
  <strong>FOCUS:</strong> YourStoryHomeDesign Social Marketing Plan &mdash; Community Connect News article (March)
</div>

<div id="cfgNote"></div>

<div class="overall">
  <div class="overall-top">
    <span id="oLabel">Overall Progress</span>
    <span id="oPct">0%</span>
  </div>
  <div class="bar-wrap">
    <div class="bar" id="oBar" style="width:0%"></div>
  </div>
</div>

<div class="filter-bar" id="filterBar"></div>

<div class="grid" id="board"></div>

<!-- Undo toast -->
<div class="toast" id="toast">
  <span id="toastMsg"></span>
  <button class="toast-undo" id="toastUndo">UNDO</button>
</div>

<!-- Tag picker overlay -->
<div class="tp-ov" id="tpOv">
  <div class="tp-box" id="tpBox"></div>
</div>

<!-- Tag management overlay -->
<div class="tm-ov" id="tmOv">
  <div class="tm-box" id="tmBox"></div>
</div>

<!-- Hidden CSV file input -->
<input type="file" id="csvFileInput" accept=".csv" style="display:none">

<!-- CSV Import preview overlay -->
<div class="csv-ov" id="csvOv">
  <div class="csv-box" id="csvBox"></div>
</div>

<!-- New Task Modal -->
<div class="nt-ov" id="ntOv">
  <div class="nt-box">
    <h2>â• Create New Task</h2>
    <div class="nt-field">
      <label>Title *</label>
      <input type="text" id="ntTitle" placeholder="What needs to be done?" autocomplete="off">
    </div>
    <div class="nt-field">
      <label>Description</label>
      <textarea id="ntDesc" placeholder="Optional detailsâ€¦"></textarea>
    </div>
    <div class="nt-row">
      <div class="nt-field">
        <label>Status</label>
        <select id="ntStatus">
          <option value="todo">To Do</option>
          <option value="inprogress">In Progress</option>
          <option value="done">Done</option>
        </select>
      </div>
      <div class="nt-field">
        <label>Priority</label>
        <select id="ntPriority">
          <option value="">â€” None â€”</option>
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
        </select>
      </div>
    </div>
    <div class="nt-row">
      <div class="nt-field">
        <label>Due Date</label>
        <input type="date" id="ntDueDate">
      </div>
      <div class="nt-field">
        <label>Section</label>
        <select id="ntSection"></select>
      </div>
    </div>
    <div class="nt-field">
      <label>Sub-tasks</label>
      <div class="nt-subtask-list" id="ntSubtaskList"></div>
      <div class="nt-subtask-add">
        <input type="text" id="ntSubInput" placeholder="Add a sub-taskâ€¦">
        <button id="ntSubAdd">Add</button>
      </div>
    </div>
    <div class="nt-actions">
      <button class="nt-cancel" id="ntCancel">Cancel</button>
      <button class="nt-create" id="ntCreate">Create Task</button>
    </div>
  </div>
</div>

<!-- Sync-key overlay -->
<div class="ov" id="ov" style="display:none">
  <div class="ov-box">
    <h2>Sync Setup</h2>
    <p>Enter a sync key below. Use the <strong>same key on every device</strong> to keep tasks in sync.</p>
    <input type="text" id="keyIn" placeholder="e.g. bozzone42" autocomplete="off" autocapitalize="off" spellcheck="false">
    <button id="keyGo">Start Syncing</button>
  </div>
</div>

<script>
/* ================================================================
   FIREBASE CONFIG â€” Replace with YOUR values (see SETUP.md)
   ================================================================ */

var firebaseConfig = {
  apiKey: "AIzaSyCmZWuIQ6NzvS2Lhzo725Wf6Cnro6NKWzI",
  authDomain: "todomyway-185c9.firebaseapp.com",
  databaseURL: "https://todomyway-185c9-default-rtdb.firebaseio.com",
  projectId: "todomyway-185c9",
  storageBucket: "todomyway-185c9.firebasestorage.app",
  messagingSenderId: "213165358695",
  appId: "1:213165358695:web:f166a7cc6772f8a54a1ec2"
};

var configured = firebaseConfig.apiKey !== 'YOUR_API_KEY';

/* ================================================================
   CONSTANTS
   ================================================================ */
var TAG_COLORS = ['#4A90D9','#5CC1A9','#D97757','#9B59B6','#E74C3C','#F39C12','#1ABC9C','#34495E'];

var DEFAULT_TAGS = [
  { id: 'tag-work',     name: 'Work',     color: '#4A90D9' },
  { id: 'tag-shop',     name: 'Shop',     color: '#5CC1A9' },
  { id: 'tag-business', name: 'Business', color: '#D97757' }
];

var EMOJIS = ['\ud83d\udccb','\ud83c\udfaf','\ud83d\udcf1','\ud83d\uded2','\ud83d\udcfa','\ud83c\udfd7\ufe0f','\ud83d\udcb0','\ud83d\udd27','\u2b50','\ud83c\udfe0','\ud83d\ude97','\ud83d\udca1','\ud83c\udfa8','\ud83d\udcdd','\ud83d\udee0\ufe0f','\ud83d\udce6'];

/* ================================================================
   DEFAULT SECTIONS â€” used for first-time setup only.
   After first load, all data lives in Firebase.
   ================================================================ */
var SEED = [
  {
    title: "YourStory \u2014 Pre-Publication",
    icon: "\ud83c\udfaf",
    priority: true,
    tasks: [
      "Verify website contact form is working",
      "Update Google Business profile with fresh photos (before article drops)",
      "Ask Catherine Myers for exact publication date",
      "Confirm if article appears online \u2014 get URL when live",
      "Ask Catherine for permission to use article/excerpts on website and marketing"
    ]
  },
  {
    title: "YourStory \u2014 Post-Publication",
    icon: "\ud83c\udfaf",
    priority: true,
    tasks: [
      "Share article on Facebook page, Instagram, and local groups",
      "Save article as PDF and screenshot for future marketing",
      "Add 'as featured in Community Connect News' to website and bio",
      "Reach out to local interior designers as referral partners (use article as credibility)",
      "Prepare response script for incoming inquiries from article readers",
      "Launch Facebook Ads campaign (once first commission comes in)"
    ]
  },
  {
    title: "Social Marketing Foundation",
    icon: "\ud83d\udcf1",
    priority: false,
    tasks: [
      "Identify target audience demographics",
      "Plan content calendar around article launch",
      "Create brand voice and messaging guidelines"
    ]
  },
  {
    title: "MSS \u2014 Miter Saw Station",
    icon: "\ud83d\udee0\ufe0f",
    priority: false,
    tasks: [
      "Make saw platform with MDF and speed braces",
      "Install floating brackets",
      "Rip 1/2 inch plywood sheet",
      "Take photographs when complete"
    ]
  },
  {
    title: "Z$ Shopping List",
    icon: "\ud83d\uded2",
    priority: false,
    tasks: [
      "Grey paint",
      "1/8 inch hardboard"
    ]
  },
  {
    title: "Retooling for Retirement",
    icon: "\ud83d\udcfa",
    priority: false,
    tasks: [
      "Upper Cabs video",
      "Plan video content calendar",
      "Create first video (pick topic from deck)",
      "Reach out to sponsors: Harvey Tools, Bambu Lab, xTool"
    ]
  },
  {
    title: "Product Ideas and Designs",
    icon: "\ud83c\udfd7\ufe0f",
    priority: false,
    tasks: [
      "Furniture Designs",
      "Retro Game controller",
      "Novel functional nostalgia",
      "Rolling Packout shelf system"
    ]
  },
  {
    title: "Financial and Admin",
    icon: "\ud83d\udcb0",
    priority: false,
    tasks: [
      "Taxes \u2014 $5,106 estimated (need approx $2,426 more)",
      "Set up analog Kanban board to manage projects",
      "Sell tools on eBay"
    ]
  }
];

/* ================================================================
   STATE
   ================================================================ */
var appData      = { sections: [], tags: [] };
var syncKey      = localStorage.getItem('bozzone-sync-key');
var dbRef        = null;
var fbReady      = false;
var isDragging   = false;
var activeFilter = null;       /* null = All, or tag id */
var activeSearch = '';         /* search query string */
var tpTarget     = null;       /* { secId, taskId } for tag picker */
var newTagColor  = TAG_COLORS[0];

/* ================================================================
   HELPERS
   ================================================================ */
function uid() {
  return 't' + Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
}

function dot(cls) {
  document.getElementById('dot').className = 'sync-dot ' + cls;
}

function findSec(id) {
  var secs = appData.sections || [];
  for (var i = 0; i < secs.length; i++) {
    if (secs[i].id === id) return secs[i];
  }
  return null;
}

function findTag(id) {
  var tags = appData.tags || [];
  for (var i = 0; i < tags.length; i++) {
    if (tags[i].id === id) return tags[i];
  }
  return null;
}

/* Firebase can turn arrays into objects â€” normalize on read */
function ensureArrays(data) {
  if (!data) return { sections: [], tags: DEFAULT_TAGS.slice() };
  if (!data.sections) data.sections = [];
  if (!Array.isArray(data.sections)) data.sections = Object.values(data.sections);
  /* Seed default tags if tags never set */
  if (!data.tags) data.tags = DEFAULT_TAGS.map(function(t) { return {id:t.id, name:t.name, color:t.color}; });
  if (!Array.isArray(data.tags)) data.tags = Object.values(data.tags);
  data.sections.forEach(function(sec) {
    if (!sec.tasks) sec.tasks = [];
    if (!Array.isArray(sec.tasks)) sec.tasks = Object.values(sec.tasks);
    sec.tasks.forEach(function(task) {
      if (!task.tags) task.tags = [];
      if (!Array.isArray(task.tags)) task.tags = Object.values(task.tags);
      /* â”€â”€ New field migrations â”€â”€ */
      if (!task.status)                   task.status   = task.done ? 'done' : 'todo';
      if (!task.subtasks)                 task.subtasks = [];
      if (!Array.isArray(task.subtasks))  task.subtasks = [];
      if (task.priority === undefined)    task.priority = null;
      if (task.dueDate  === undefined)    task.dueDate  = null;
      if (task.desc     === undefined)    task.desc     = '';
    });
  });
  return data;
}

/* ================================================================
   DATA MODEL â€” build initial data from SEED + old checkbox states
   ================================================================ */
function buildInitialData(oldStates) {
  oldStates = oldStates || {};
  return {
    tags: DEFAULT_TAGS.map(function(t) { return {id:t.id, name:t.name, color:t.color}; }),
    sections: SEED.map(function(sec, si) {
      return {
        id: 'sec-' + si,
        title: sec.title,
        icon: sec.icon,
        priority: !!sec.priority,
        tasks: sec.tasks.map(function(text, ti) {
          var oldId = (sec.title + '-' + ti).toLowerCase().replace(/[^a-z0-9]+/g, '-').slice(0, 60);
          return { id: uid(), text: text, done: !!oldStates[oldId], tags: [] };
        })
      };
    })
  };
}

/* ================================================================
   FIREBASE
   ================================================================ */
function initFB() {
  if (!configured) {
    dot('off');
    document.getElementById('cfgNote').innerHTML =
      '<div class="cfg-banner"><h2>Firebase Not Configured</h2>' +
      '<p>The app works offline with local storage. To enable cross-device sync, ' +
      'add your Firebase config to <code>index.html</code> and redeploy. ' +
      'See <strong>SETUP.md</strong> for instructions.</p></div>';
    loadLS();
    if (!appData.sections.length) appData = buildInitialData();
    render();
    return;
  }

  try {
    firebase.initializeApp(firebaseConfig);
    fbReady = true;
  } catch (e) {
    dot('off');
    loadLS();
    if (!appData.sections.length) appData = buildInitialData();
    render();
    return;
  }

  if (syncKey) startSync();
}

function startSync() {
  if (!fbReady || !syncKey) return;
  dot('wait');

  dbRef = firebase.database().ref('dashboards/' + syncKey + '/v2');

  var firstLoad = true;
  dbRef.on('value', function(snap) {
    if (isDragging) return;
    if (snap.exists()) {
      appData = ensureArrays(snap.val());
      dot('on');
      render();
    } else if (firstLoad) {
      var oldRef = firebase.database().ref('dashboards/' + syncKey + '/tasks');
      oldRef.once('value', function(oldSnap) {
        appData = buildInitialData(oldSnap.val() || {});
        save();
      });
    }
    firstLoad = false;
  }, function() {
    dot('off');
  });

  firebase.database().ref('.info/connected').on('value', function(s) {
    dot(s.val() ? 'on' : 'off');
  });

  document.getElementById('keyLbl').textContent = syncKey;
}

function save() {
  saveLS();
  if (fbReady && dbRef) {
    dbRef.set(appData);
  } else {
    render();
  }
}

/* ================================================================
   LOCAL STORAGE (backup / offline fallback)
   ================================================================ */
function loadLS() {
  try {
    var s = localStorage.getItem('bozzone-app-v2');
    if (s) { appData = ensureArrays(JSON.parse(s)); return; }
    var old = localStorage.getItem('bozzone-states');
    if (old) appData = buildInitialData(JSON.parse(old));
  } catch (e) {}
}

function saveLS() {
  try { localStorage.setItem('bozzone-app-v2', JSON.stringify(appData)); } catch (e) {}
}

/* ================================================================
   TASK CRUD
   ================================================================ */
function addTask(secId, text) {
  var sec = findSec(secId);
  if (!sec) return;
  sec.tasks.push({ id: uid(), text: text.trim(), done: false, tags: [] });
  save();
}

function deleteTask(secId, taskId) {
  var sec = findSec(secId);
  if (!sec) return;
  var idx = -1;
  for (var i = 0; i < sec.tasks.length; i++) {
    if (sec.tasks[i].id === taskId) { idx = i; break; }
  }
  if (idx === -1) return;
  var removed = sec.tasks.splice(idx, 1)[0];
  var savedSecId = secId, savedIdx = idx;
  save();
  showToast('Task deleted', function() {
    var s = findSec(savedSecId);
    if (s) { s.tasks.splice(savedIdx, 0, removed); save(); }
  });
}

function toggleTask(secId, taskId) {
  var sec = findSec(secId);
  if (!sec) return;
  for (var i = 0; i < sec.tasks.length; i++) {
    if (sec.tasks[i].id === taskId) {
      sec.tasks[i].done = !sec.tasks[i].done;
      break;
    }
  }
  save();
}

/* ================================================================
   CYCLE STATUS (replaces toggleTask for the status button)
   ================================================================ */
function cycleStatus(secId, taskId) {
  var sec = findSec(secId);
  if (!sec) return;
  for (var i = 0; i < sec.tasks.length; i++) {
    if (sec.tasks[i].id === taskId) {
      var cur = sec.tasks[i].status || 'todo';
      var next = cur === 'todo' ? 'inprogress' : cur === 'inprogress' ? 'done' : 'todo';
      sec.tasks[i].status = next;
      sec.tasks[i].done   = (next === 'done');
      break;
    }
  }
  save();
}

/* ================================================================
   CREATE TASK (full data model)
   ================================================================ */
function createTask(secId, data) {
  var sec = findSec(secId);
  if (!sec) return;
  var status = data.status || 'todo';
  var task = {
    id:       uid(),
    text:     (data.text || '').trim(),
    desc:     (data.desc || '').trim(),
    status:   status,
    done:     status === 'done',
    priority: data.priority || null,
    dueDate:  data.dueDate  || null,
    subtasks: (data.subtasks || []).map(function(s) {
      return { id: uid(), text: s.text, done: false };
    }),
    tags: []
  };
  if (!task.text) return;
  sec.tasks.push(task);
  save();
  showToast('Task created');
}

/* ================================================================
   SUBTASK CRUD
   ================================================================ */
function toggleSubtask(secId, taskId, subId) {
  var sec = findSec(secId);
  if (!sec) return;
  var task = sec.tasks.filter(function(t) { return t.id === taskId; })[0];
  if (!task) return;
  var sub = (task.subtasks || []).filter(function(s) { return s.id === subId; })[0];
  if (sub) { sub.done = !sub.done; save(); }
}

function addSubtask(secId, taskId, text) {
  var sec = findSec(secId);
  if (!sec) return;
  var task = sec.tasks.filter(function(t) { return t.id === taskId; })[0];
  if (!task) return;
  if (!task.subtasks) task.subtasks = [];
  task.subtasks.push({ id: uid(), text: text.trim(), done: false });
  save();
}

function deleteSubtask(secId, taskId, subId) {
  var sec = findSec(secId);
  if (!sec) return;
  var task = sec.tasks.filter(function(t) { return t.id === taskId; })[0];
  if (!task || !task.subtasks) return;
  task.subtasks = task.subtasks.filter(function(s) { return s.id !== subId; });
  save();
}

/* ================================================================
   NEW TASK MODAL
   ================================================================ */
var ntPendingSubtasks = [];  /* subtasks built up in modal before save */

function showNewTaskModal(secId) {
  ntPendingSubtasks = [];
  /* Populate section select */
  var sel = document.getElementById('ntSection');
  sel.innerHTML = '';
  (appData.sections || []).forEach(function(s) {
    var opt = document.createElement('option');
    opt.value = s.id;
    opt.textContent = s.title;
    if (s.id === secId) opt.selected = true;
    sel.appendChild(opt);
  });
  /* Reset fields */
  document.getElementById('ntTitle').value   = '';
  document.getElementById('ntDesc').value    = '';
  document.getElementById('ntStatus').value  = 'todo';
  document.getElementById('ntPriority').value = '';
  document.getElementById('ntDueDate').value  = '';
  document.getElementById('ntSubInput').value = '';
  renderNtSubtasks();
  document.getElementById('ntOv').classList.add('show');
  document.getElementById('ntTitle').focus();
}

function hideNewTaskModal() {
  document.getElementById('ntOv').classList.remove('show');
}

function renderNtSubtasks() {
  var list = document.getElementById('ntSubtaskList');
  list.innerHTML = '';
  ntPendingSubtasks.forEach(function(s, idx) {
    var item = document.createElement('div');
    item.className = 'nt-subtask-item';
    var sp = document.createElement('span');
    sp.textContent = s.text;
    var del = document.createElement('button');
    del.className = 'nt-subtask-del';
    del.innerHTML = '&times;';
    (function(i) {
      del.addEventListener('click', function() {
        ntPendingSubtasks.splice(i, 1);
        renderNtSubtasks();
      });
    })(idx);
    item.appendChild(sp);
    item.appendChild(del);
    list.appendChild(item);
  });
}

function handleMove(fromSecId, toSecId, taskId, newIndex) {
  var fromSec = findSec(fromSecId);
  var toSec   = findSec(toSecId);
  if (!fromSec || !toSec) return;
  var taskIdx = -1;
  for (var i = 0; i < fromSec.tasks.length; i++) {
    if (fromSec.tasks[i].id === taskId) { taskIdx = i; break; }
  }
  if (taskIdx === -1) return;
  var task = fromSec.tasks.splice(taskIdx, 1)[0];
  toSec.tasks.splice(newIndex, 0, task);
  save();
}

/* ================================================================
   SECTION CRUD
   ================================================================ */
function addSection(title, icon) {
  appData.sections.push({
    id: uid(),
    title: title.trim(),
    icon: icon || '\ud83d\udccb',
    priority: false,
    tasks: []
  });
  save();
}

function deleteSection(secId) {
  var secs = appData.sections || [];
  var idx = -1;
  for (var i = 0; i < secs.length; i++) {
    if (secs[i].id === secId) { idx = i; break; }
  }
  if (idx === -1) return;
  var removed = secs.splice(idx, 1)[0];
  var savedIdx = idx;
  save();
  var msg = 'Column deleted' + (removed.tasks.length ? ' (' + removed.tasks.length + ' tasks)' : '');
  showToast(msg, function() {
    appData.sections.splice(savedIdx, 0, removed);
    save();
  });
}

function renameSection(secId, newTitle) {
  var sec = findSec(secId);
  if (!sec || !newTitle.trim()) return;
  sec.title = newTitle.trim();
  save();
}

/* ================================================================
   TAG CRUD
   ================================================================ */
function addTag(name, color) {
  if (!appData.tags) appData.tags = [];
  appData.tags.push({ id: uid(), name: name.trim(), color: color });
  save();
}

function deleteTag(tagId) {
  var tags = appData.tags || [];
  var idx = -1;
  for (var i = 0; i < tags.length; i++) {
    if (tags[i].id === tagId) { idx = i; break; }
  }
  if (idx === -1) return;
  tags.splice(idx, 1);
  /* Remove tag from all tasks */
  (appData.sections || []).forEach(function(sec) {
    (sec.tasks || []).forEach(function(task) {
      if (task.tags) {
        var ti = task.tags.indexOf(tagId);
        if (ti !== -1) task.tags.splice(ti, 1);
      }
    });
  });
  if (activeFilter === tagId) activeFilter = null;
  save();
}

function toggleTaskTag(secId, taskId, tagId) {
  var sec = findSec(secId);
  if (!sec) return;
  for (var i = 0; i < sec.tasks.length; i++) {
    if (sec.tasks[i].id === taskId) {
      var t = sec.tasks[i];
      if (!t.tags) t.tags = [];
      var ti = t.tags.indexOf(tagId);
      if (ti === -1) t.tags.push(tagId);
      else t.tags.splice(ti, 1);
      break;
    }
  }
  save();
}

/* ================================================================
   FILTER LOGIC
   ================================================================ */
function setFilter(tagId) {
  activeFilter = tagId;
  render();
}

function setSearch(text) {
  activeSearch = (text || '').trim().toLowerCase();
  render();
}

function getFilteredSections() {
  var secs = appData.sections || [];
  var needsFilter = activeFilter || activeSearch;
  if (!needsFilter) return secs;
  return secs.map(function(sec) {
    var tasks = (sec.tasks || []).filter(function(t) {
      /* Tag filter */
      if (activeFilter && !(t.tags && t.tags.indexOf(activeFilter) !== -1)) return false;
      /* Search filter */
      if (activeSearch) {
        var q = activeSearch;
        var inTitle = (t.text || '').toLowerCase().indexOf(q) !== -1;
        var inDesc  = (t.desc || '').toLowerCase().indexOf(q) !== -1;
        var inSubs  = (t.subtasks || []).some(function(s) {
          return (s.text || '').toLowerCase().indexOf(q) !== -1;
        });
        if (!inTitle && !inDesc && !inSubs) return false;
      }
      return true;
    });
    return {
      id: sec.id,
      title: sec.title,
      icon: sec.icon,
      priority: sec.priority,
      tasks: tasks
    };
  }).filter(function(sec) {
    return sec.tasks.length > 0;
  });
}

function getTagCounts() {
  var counts = {};
  var total = 0;
  (appData.sections || []).forEach(function(sec) {
    (sec.tasks || []).forEach(function(task) {
      total++;
      (task.tags || []).forEach(function(tid) {
        counts[tid] = (counts[tid] || 0) + 1;
      });
    });
  });
  counts._total = total;
  return counts;
}

/* ================================================================
   RENDER â€” FILTER BAR
   ================================================================ */
function renderFilterBar() {
  var bar = document.getElementById('filterBar');
  bar.innerHTML = '';
  var tags = appData.tags || [];
  var counts = getTagCounts();

  /* "All" button */
  var allBtn = document.createElement('button');
  allBtn.className = 'filter-btn' + (!activeFilter ? ' active' : '');
  allBtn.innerHTML = 'All <span class="filter-count">' + (counts._total || 0) + '</span>';
  allBtn.addEventListener('click', function() { setFilter(null); });
  bar.appendChild(allBtn);

  /* Tag buttons */
  tags.forEach(function(tag) {
    var btn = document.createElement('button');
    var isActive = activeFilter === tag.id;
    btn.className = 'filter-btn' + (isActive ? ' active' : '');
    if (isActive) {
      btn.style.background = tag.color;
      btn.style.borderColor = tag.color;
    }
    btn.innerHTML =
      '<span class="filter-dot" style="background:' + tag.color + '"></span>' +
      tag.name +
      ' <span class="filter-count">' + (counts[tag.id] || 0) + '</span>';
    (function(tid) {
      btn.addEventListener('click', function() { setFilter(tid); });
    })(tag.id);
    bar.appendChild(btn);
  });

  /* Manage tags button */
  var mgmt = document.createElement('button');
  mgmt.className = 'filter-manage-btn';
  mgmt.innerHTML = '&#9881;';
  mgmt.title = 'Manage tags';
  mgmt.addEventListener('click', function() { showTagMgmt(); });
  bar.appendChild(mgmt);
}

/* ================================================================
   RENDER â€” MAIN BOARD
   ================================================================ */
function render() {
  if (isDragging) return;

  renderFilterBar();

  var board = document.getElementById('board');
  board.innerHTML = '';

  var filteredSecs = getFilteredSections();
  var totalAll = 0, doneAll = 0;

  filteredSecs.forEach(function(sec) {
    var tasks = sec.tasks || [];
    var done = 0;
    tasks.forEach(function(t) { if (t.done) done++; });
    totalAll += tasks.length;
    doneAll  += done;
    var pct = tasks.length ? Math.round(done / tasks.length * 100) : 0;

    /* â”€â”€ Card â”€â”€ */
    var card = document.createElement('div');
    card.className = 'card' + (sec.priority ? ' priority' : '');

    /* â”€â”€ Header â”€â”€ */
    var hd = document.createElement('div');
    hd.className = 'card-hd';

    /* Editable title */
    var titleSpan = document.createElement('span');
    titleSpan.className = 'sec-title';
    titleSpan.textContent = (sec.icon || '') + ' ' + sec.title;
    (function(secId, currentTitle, icon) {
      titleSpan.addEventListener('click', function() {
        /* Replace span with input */
        var input = document.createElement('input');
        input.type = 'text';
        input.className = 'sec-title-input';
        input.value = currentTitle;
        titleSpan.style.display = 'none';
        hd.insertBefore(input, titleSpan.nextSibling);
        input.focus();
        input.select();

        function commitEdit() {
          var val = input.value.trim();
          if (val && val !== currentTitle) {
            renameSection(secId, val);
          } else {
            /* Cancelled or no change â€” restore */
            input.remove();
            titleSpan.style.display = '';
          }
        }

        input.addEventListener('blur', commitEdit);
        input.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
          if (e.key === 'Escape') {
            input.removeEventListener('blur', commitEdit);
            input.remove();
            titleSpan.style.display = '';
          }
        });
      });
    })(sec.id, sec.title, sec.icon);
    hd.appendChild(titleSpan);

    /* Actions: badge + delete */
    var actions = document.createElement('span');
    actions.className = 'sec-actions';

    var badge = document.createElement('span');
    badge.className = 'badge';
    badge.textContent = done + '/' + tasks.length;
    actions.appendChild(badge);

    var delBtn = document.createElement('button');
    delBtn.className = 'sec-del';
    delBtn.innerHTML = '&times;';
    delBtn.title = 'Delete column';
    (function(sid) {
      delBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        deleteSection(sid);
      });
    })(sec.id);
    actions.appendChild(delBtn);

    hd.appendChild(actions);
    card.appendChild(hd);

    /* â”€â”€ Body â”€â”€ */
    var bd = document.createElement('div');
    bd.className = 'card-bd';

    /* Progress */
    var pw = document.createElement('div'); pw.className = 'prog-wrap';
    var pb = document.createElement('div'); pb.className = 'prog'; pb.style.width = pct + '%';
    pw.appendChild(pb); bd.appendChild(pw);
    var pl = document.createElement('div'); pl.className = 'prog-lbl';
    pl.textContent = pct + '% complete';
    bd.appendChild(pl);

    /* Task list */
    var tl = document.createElement('div');
    tl.className = 'task-list';
    tl.dataset.sectionId = sec.id;

    if (!tasks.length) {
      var em = document.createElement('div');
      em.className = 'task-empty';
      em.textContent = activeFilter ? 'No matching tasks' : 'No tasks \u2014 add one below';
      tl.appendChild(em);
    }

    tasks.forEach(function(task) {
      var status = task.status || (task.done ? 'done' : 'todo');

      var row = document.createElement('div');
      row.className = 'task status-' + status;
      row.dataset.taskId    = task.id;
      row.dataset.sectionId = sec.id;
      if (task.priority) row.dataset.priority = task.priority;

      /* Drag handle */
      var grip = document.createElement('span');
      grip.className = 'drag-handle';
      grip.innerHTML = '&#9776;';
      row.appendChild(grip);

      /* Status button (3-state, replaces checkbox) */
      var statusBtn = document.createElement('button');
      statusBtn.className = 'status-btn';
      statusBtn.dataset.status = status;
      statusBtn.title = 'Click to cycle status';
      statusBtn.innerHTML = status === 'done' ? '&#10003;' : status === 'inprogress' ? '&#9680;' : '';
      (function(sid, tid) {
        statusBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          cycleStatus(sid, tid);
        });
      })(sec.id, task.id);
      row.appendChild(statusBtn);

      /* Content wrapper */
      var content = document.createElement('div');
      content.className = 'task-content';

      var lb = document.createElement('label');
      lb.textContent = task.text;
      content.appendChild(lb);

      /* Due date chip */
      if (task.dueDate) {
        var today = new Date(); today.setHours(0,0,0,0);
        var due   = new Date(task.dueDate + 'T00:00:00');
        var chip  = document.createElement('span');
        chip.className = 'due-chip';
        var diff = due - today;
        if (diff < 0)      chip.className += ' overdue';
        else if (diff === 0) chip.className += ' today';
        var mo = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        chip.textContent = '\ud83d\udcc5 ' + mo[due.getMonth()] + ' ' + due.getDate();
        content.appendChild(chip);
      }

      /* Tag badges */
      var taskTags = task.tags || [];
      if (taskTags.length) {
        var badges = document.createElement('div');
        badges.className = 'tag-badges';
        taskTags.forEach(function(tid) {
          var tag = findTag(tid);
          if (tag) {
            var b = document.createElement('span');
            b.className = 'tag-badge';
            b.style.background = tag.color;
            b.textContent = tag.name;
            badges.appendChild(b);
          }
        });
        content.appendChild(badges);
      }

      /* Subtask summary + list */
      var subs = task.subtasks || [];
      if (subs.length > 0) {
        var doneSubs = subs.filter(function(s) { return s.done; }).length;
        var summary  = document.createElement('span');
        summary.className = 'subtask-summary';
        summary.textContent = '\u25b8 ' + doneSubs + '/' + subs.length + ' subtasks';

        var subList = document.createElement('div');
        subList.className = 'subtask-list';

        subs.forEach(function(sub) {
          var si = document.createElement('div');
          si.className = 'subtask-item' + (sub.done ? ' done' : '');

          var scb = document.createElement('input');
          scb.type = 'checkbox';
          scb.checked = sub.done;
          (function(sid, tid, subid) {
            scb.addEventListener('change', function() { toggleSubtask(sid, tid, subid); });
          })(sec.id, task.id, sub.id);

          var slb = document.createElement('label');
          slb.textContent = sub.text;

          var sdel = document.createElement('button');
          sdel.className = 'subtask-del';
          sdel.innerHTML = '&times;';
          (function(sid, tid, subid) {
            sdel.addEventListener('click', function(e) {
              e.stopPropagation();
              deleteSubtask(sid, tid, subid);
            });
          })(sec.id, task.id, sub.id);

          si.appendChild(scb);
          si.appendChild(slb);
          si.appendChild(sdel);
          subList.appendChild(si);
        });

        /* Inline add-subtask row inside the expanded list */
        var subAddRow = document.createElement('div');
        subAddRow.className = 'subtask-add-row';
        var subInp = document.createElement('input');
        subInp.type = 'text';
        subInp.className = 'subtask-add-input';
        subInp.placeholder = 'Add sub-task\u2026';
        var subAddBtn = document.createElement('button');
        subAddBtn.className = 'subtask-add-btn';
        subAddBtn.textContent = '+';
        (function(sid, tid, inp) {
          function doAddSub() {
            var v = inp.value.trim();
            if (v) { addSubtask(sid, tid, v); inp.value = ''; }
          }
          subAddBtn.addEventListener('click', doAddSub);
          inp.addEventListener('keydown', function(e) { if (e.key === 'Enter') doAddSub(); });
        })(sec.id, task.id, subInp);
        subAddRow.appendChild(subInp);
        subAddRow.appendChild(subAddBtn);
        subList.appendChild(subAddRow);

        /* Toggle expand on summary click */
        summary.addEventListener('click', function(e) {
          e.stopPropagation();
          var open = subList.classList.toggle('open');
          summary.textContent = (open ? '\u25be ' : '\u25b8 ') + doneSubs + '/' + subs.length + ' subtasks';
        });

        content.appendChild(summary);
        content.appendChild(subList);
      }

      row.appendChild(content);

      /* Action buttons */
      var actionsDiv = document.createElement('div');
      actionsDiv.className = 'task-actions';

      /* Tag toggle button */
      var tagBtn = document.createElement('button');
      tagBtn.className = 'tag-btn';
      tagBtn.innerHTML = '\ud83c\udff7\ufe0f';
      tagBtn.title = 'Tags';
      (function(sid, tid) {
        tagBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          showTagPicker(sid, tid);
        });
      })(sec.id, task.id);
      actionsDiv.appendChild(tagBtn);

      /* Delete button */
      var del = document.createElement('button');
      del.className = 'del-btn';
      del.innerHTML = '&times;';
      del.title = 'Delete task';
      (function(sid, tid) {
        del.addEventListener('click', function(e) {
          e.stopPropagation();
          deleteTask(sid, tid);
        });
      })(sec.id, task.id);
      actionsDiv.appendChild(del);

      row.appendChild(actionsDiv);
      tl.appendChild(row);
    });

    bd.appendChild(tl);

    /* â”€â”€ + New Task button (replaces old add-row) â”€â”€ */
    var ar = document.createElement('div');
    ar.className = 'add-task-row';
    var ntBtn = document.createElement('button');
    ntBtn.className = 'add-task-btn';
    ntBtn.innerHTML = '+ New Task';
    (function(sid) {
      ntBtn.addEventListener('click', function() { showNewTaskModal(sid); });
    })(sec.id);
    ar.appendChild(ntBtn);
    bd.appendChild(ar);

    card.appendChild(bd);
    board.appendChild(card);
  });

  /* â”€â”€ Add Column Card â”€â”€ */
  var addCard = document.createElement('div');
  addCard.className = 'add-col-card';
  addCard.id = 'addColCard';
  addCard.innerHTML =
    '<div class="add-col-icon">+</div>' +
    '<div class="add-col-label">Add Column</div>';
  addCard.addEventListener('click', function() { expandAddCol(addCard); });
  board.appendChild(addCard);

  /* â”€â”€ Import CSV Card â”€â”€ */
  var importCard = document.createElement('div');
  importCard.className = 'add-col-card';
  importCard.innerHTML =
    '<div class="add-col-icon" style="font-size:1.6rem">\ud83d\udce5</div>' +
    '<div class="add-col-label">Import CSV</div>';
  importCard.addEventListener('click', function() {
    document.getElementById('csvFileInput').value = '';
    document.getElementById('csvFileInput').click();
  });
  board.appendChild(importCard);

  /* â”€â”€ Download CSV Card â”€â”€ */
  var dlCard = document.createElement('div');
  dlCard.className = 'add-col-card';
  dlCard.innerHTML =
    '<div class="add-col-icon" style="font-size:1.6rem">\ud83d\udcc4</div>' +
    '<div class="add-col-label">Download CSV</div>';
  dlCard.addEventListener('click', exportCSV);
  board.appendChild(dlCard);

  /* Overall progress */
  var op = totalAll ? Math.round(doneAll / totalAll * 100) : 0;
  var filterTag = activeFilter ? findTag(activeFilter) : null;
  document.getElementById('oLabel').textContent =
    filterTag ? (filterTag.name + ' Progress') : 'Overall Progress';
  document.getElementById('oPct').textContent = doneAll + '/' + totalAll + ' (' + op + '%)';
  document.getElementById('oBar').style.width  = op + '%';

  initSortables();
}

/* ================================================================
   ADD COLUMN â€” expand card into form
   ================================================================ */
var selectedEmoji = '\ud83d\udccb';

function expandAddCol(card) {
  if (card.classList.contains('expanded')) return;
  card.classList.add('expanded');
  card.removeEventListener('click', arguments.callee);
  selectedEmoji = '\ud83d\udccb';

  card.innerHTML =
    '<div class="add-col-form">' +
      '<input type="text" id="newColName" placeholder="Column name\u2026" autofocus>' +
      '<label>Icon</label>' +
      '<div class="emoji-row" id="emojiRow"></div>' +
      '<div class="add-col-btns">' +
        '<button class="btn-cancel" id="colCancelBtn">Cancel</button>' +
        '<button class="btn-create" id="colCreateBtn">Create</button>' +
      '</div>' +
    '</div>';

  var row = document.getElementById('emojiRow');
  EMOJIS.forEach(function(em) {
    var btn = document.createElement('button');
    btn.className = 'emoji-pick' + (em === selectedEmoji ? ' sel' : '');
    btn.textContent = em;
    btn.type = 'button';
    btn.addEventListener('click', function() {
      row.querySelectorAll('.emoji-pick').forEach(function(b) { b.classList.remove('sel'); });
      btn.classList.add('sel');
      selectedEmoji = em;
    });
    row.appendChild(btn);
  });

  var nameInput = document.getElementById('newColName');
  nameInput.focus();

  document.getElementById('colCreateBtn').addEventListener('click', function() {
    var name = nameInput.value.trim();
    if (name) { addSection(name, selectedEmoji); }
  });
  document.getElementById('colCancelBtn').addEventListener('click', function() {
    render();
  });
  nameInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      var name = nameInput.value.trim();
      if (name) addSection(name, selectedEmoji);
    }
    if (e.key === 'Escape') render();
  });
}

/* ================================================================
   TAG PICKER
   ================================================================ */
function showTagPicker(secId, taskId) {
  tpTarget = { secId: secId, taskId: taskId };
  renderTagPicker();
  document.getElementById('tpOv').classList.add('show');
}

function hideTagPicker() {
  document.getElementById('tpOv').classList.remove('show');
  tpTarget = null;
}

function renderTagPicker() {
  if (!tpTarget) return;
  var sec = findSec(tpTarget.secId);
  if (!sec) return;
  var task = null;
  for (var i = 0; i < sec.tasks.length; i++) {
    if (sec.tasks[i].id === tpTarget.taskId) { task = sec.tasks[i]; break; }
  }
  if (!task) return;

  var box = document.getElementById('tpBox');
  var tags = appData.tags || [];
  var taskTags = task.tags || [];
  var html = '<div class="tp-title">Tags for: ' + escHtml(task.text.slice(0, 40)) + (task.text.length > 40 ? '\u2026' : '') + '</div>';

  if (!tags.length) {
    html += '<div class="tp-empty">No tags yet. Create tags from the filter bar.</div>';
  } else {
    tags.forEach(function(tag) {
      var checked = taskTags.indexOf(tag.id) !== -1;
      html +=
        '<div class="tp-item" data-tag-id="' + tag.id + '">' +
          '<span class="tp-dot" style="background:' + tag.color + '"></span>' +
          '<span class="tp-name">' + escHtml(tag.name) + '</span>' +
          (checked ? '<span class="tp-check">\u2713</span>' : '') +
        '</div>';
    });
  }

  box.innerHTML = html;

  /* Attach click handlers */
  box.querySelectorAll('.tp-item').forEach(function(el) {
    el.addEventListener('click', function() {
      var tid = el.dataset.tagId;
      toggleTaskTag(tpTarget.secId, tpTarget.taskId, tid);
      /* Re-render picker to update checkmarks (save triggers full render, picker stays open) */
      setTimeout(function() { renderTagPicker(); }, 50);
    });
  });
}

/* Close tag picker on overlay click */
document.getElementById('tpOv').addEventListener('click', function(e) {
  if (e.target === this) hideTagPicker();
});

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* ================================================================
   CSV IMPORT
   ================================================================ */
function parseCSV(text) {
  var rows = [];
  var lines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
  lines.forEach(function(line) {
    if (!line.trim()) return;
    var cols = [];
    var cur = '';
    var inQ = false;
    for (var i = 0; i < line.length; i++) {
      var c = line[i];
      if (c === '"') {
        if (inQ && line[i + 1] === '"') { cur += '"'; i++; }
        else inQ = !inQ;
      } else if (c === ',' && !inQ) {
        cols.push(cur.trim());
        cur = '';
      } else {
        cur += c;
      }
    }
    cols.push(cur.trim());
    rows.push(cols);
  });
  return rows;
}

function hideImportModal() {
  document.getElementById('csvOv').classList.remove('show');
}

function showImportPreview(rows) {
  if (rows.length < 2) {
    showToast('CSV must have a header row and at least one data row');
    return;
  }

  /* Skip header row, group tasks by section */
  var sectionMap = {};  /* lowercase title -> { displayTitle, tasks[] } */
  var skipped = 0;
  var totalTasks = 0;

  rows.slice(1).forEach(function(row) {
    if (row.length < 2 || !row[0] || !row[1]) { skipped++; return; }
    if (totalTasks >= 200) { skipped++; return; }
    var key = row[0].toLowerCase();
    if (!sectionMap[key]) sectionMap[key] = { displayTitle: row[0], tasks: [] };
    sectionMap[key].tasks.push(row[1]);
    totalTasks++;
  });

  if (totalTasks === 0) {
    showToast('No valid rows found â€” check CSV format (section, task)');
    return;
  }

  /* Determine new vs existing sections */
  var existingTitles = {};
  (appData.sections || []).forEach(function(sec) {
    existingTitles[sec.title.toLowerCase()] = sec;
  });

  var previewItems = Object.keys(sectionMap).map(function(key) {
    return {
      title: sectionMap[key].displayTitle,
      tasks: sectionMap[key].tasks,
      isNew: !existingTitles[key]
    };
  });

  var newCount = previewItems.filter(function(i) { return i.isNew; }).length;

  /* Build modal */
  var box = document.getElementById('csvBox');
  var html = '<h2>\ud83d\udce5 Import Preview</h2>';
  html += '<p><strong>' + totalTasks + '</strong> task' + (totalTasks !== 1 ? 's' : '') +
          ' across <strong>' + previewItems.length + '</strong> section' +
          (previewItems.length !== 1 ? 's' : '') +
          (newCount ? ' &mdash; <strong>' + newCount + '</strong> new section' + (newCount !== 1 ? 's' : '') + ' will be created' : '') +
          '.</p>';

  html += '<div class="csv-hint">Expected format: <code>section, task</code> (first row is header)</div>';

  previewItems.forEach(function(item) {
    html +=
      '<div class="csv-sec-item ' + (item.isNew ? 'new-sec' : 'exist-sec') + '">' +
        '<span>' + escHtml(item.title) +
          ' <span style="color:var(--text-muted);font-size:.76rem">(' + item.tasks.length + ')</span>' +
        '</span>' +
        '<span class="csv-sec-badge ' + (item.isNew ? 'new' : 'exist') + '">' +
          (item.isNew ? 'New' : 'Existing') +
        '</span>' +
      '</div>';
  });

  if (skipped > 0) {
    html += '<div style="font-size:.76rem;color:var(--text-muted);margin-top:8px">' +
            skipped + ' row(s) skipped (blank section/task or over 200-row limit)</div>';
  }

  html +=
    '<div class="csv-actions">' +
      '<button class="csv-btn-cancel" id="csvCancelBtn">Cancel</button>' +
      '<button class="csv-btn-confirm" id="csvConfirmBtn">Import All</button>' +
    '</div>';

  box.innerHTML = html;

  document.getElementById('csvCancelBtn').addEventListener('click', hideImportModal);
  document.getElementById('csvConfirmBtn').addEventListener('click', function() {
    executeImport(previewItems, existingTitles);
    hideImportModal();
  });

  document.getElementById('csvOv').classList.add('show');
}

function executeImport(previewItems, existingTitles) {
  var totalAdded = 0;
  var sectionsCreated = 0;

  previewItems.forEach(function(item) {
    var key = item.title.toLowerCase();
    var sec = existingTitles[key];
    if (!sec) {
      sec = { id: uid(), title: item.title, icon: '\ud83d\udccb', priority: false, tasks: [] };
      appData.sections.push(sec);
      sectionsCreated++;
    }
    item.tasks.forEach(function(text) {
      if (text.trim()) {
        sec.tasks.push({ id: uid(), text: text.trim(), done: false, tags: [] });
        totalAdded++;
      }
    });
  });

  save();
  showToast(
    'Imported ' + totalAdded + ' task' + (totalAdded !== 1 ? 's' : '') +
    (sectionsCreated ? ' (+' + sectionsCreated + ' new section' + (sectionsCreated !== 1 ? 's' : '') + ')' : '')
  );
}

/* ================================================================
   CSV EXPORT
   ================================================================ */
function exportCSV() {
  var rows = ['section,task,done,tags'];
  (appData.sections || []).forEach(function(sec) {
    (sec.tasks || []).forEach(function(task) {
      var tagNames = (task.tags || []).map(function(tid) {
        var tag = findTag(tid);
        return tag ? tag.name : '';
      }).filter(Boolean).join('|');
      rows.push(
        '"' + sec.title.replace(/"/g, '""') + '",' +
        '"' + task.text.replace(/"/g, '""') + '",' +
        (task.done ? 'true' : 'false') + ',' +
        '"' + tagNames + '"'
      );
    });
  });
  var csv = rows.join('\n');
  var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'bozzone-tasks-' + new Date().toISOString().slice(0, 10) + '.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast('Downloaded ' + (rows.length - 1) + ' task' + (rows.length - 1 !== 1 ? 's' : ''));
}

/* ================================================================
   TAG MANAGEMENT MODAL
   ================================================================ */
function showTagMgmt() {
  renderTagMgmt();
  document.getElementById('tmOv').classList.add('show');
}

function hideTagMgmt() {
  document.getElementById('tmOv').classList.remove('show');
}

function renderTagMgmt() {
  var box = document.getElementById('tmBox');
  var tags = appData.tags || [];

  var html = '<h2>Manage Tags</h2>';
  html += '<div class="tm-list">';
  if (!tags.length) {
    html += '<div style="padding:10px 0;color:var(--text-muted);font-size:.84rem;font-style:italic">No tags yet</div>';
  }
  tags.forEach(function(tag) {
    html +=
      '<div class="tm-item">' +
        '<span class="tm-color" style="background:' + tag.color + '"></span>' +
        '<span class="tm-name">' + escHtml(tag.name) + '</span>' +
        '<button class="tm-del" data-tag-id="' + tag.id + '" title="Delete tag">&times;</button>' +
      '</div>';
  });
  html += '</div>';

  html += '<div class="tm-divider"></div>';
  html += '<div class="tm-subtitle">Add new tag</div>';
  html += '<div class="tm-add-row"><input class="tm-add-input" id="tmNewName" placeholder="Tag name\u2026"></div>';
  html += '<div class="tm-colors" id="tmColors"></div>';
  html += '<button class="tm-add-btn" id="tmAddBtn">Add Tag</button>';
  html += '<button class="tm-close" id="tmCloseBtn">Done</button>';

  box.innerHTML = html;

  /* Color swatches */
  var colorRow = document.getElementById('tmColors');
  newTagColor = TAG_COLORS[0];
  TAG_COLORS.forEach(function(c) {
    var sw = document.createElement('span');
    sw.className = 'tm-color-opt' + (c === newTagColor ? ' sel' : '');
    sw.style.background = c;
    sw.addEventListener('click', function() {
      colorRow.querySelectorAll('.tm-color-opt').forEach(function(s) { s.classList.remove('sel'); });
      sw.classList.add('sel');
      newTagColor = c;
    });
    colorRow.appendChild(sw);
  });

  /* Delete tag handlers */
  box.querySelectorAll('.tm-del').forEach(function(btn) {
    btn.addEventListener('click', function() {
      deleteTag(btn.dataset.tagId);
      renderTagMgmt();
    });
  });

  /* Add tag */
  document.getElementById('tmAddBtn').addEventListener('click', function() {
    var name = document.getElementById('tmNewName').value.trim();
    if (name) {
      addTag(name, newTagColor);
      renderTagMgmt();
    }
  });
  document.getElementById('tmNewName').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      var name = this.value.trim();
      if (name) { addTag(name, newTagColor); renderTagMgmt(); }
    }
  });

  /* Close */
  document.getElementById('tmCloseBtn').addEventListener('click', hideTagMgmt);
}

/* Close tag mgmt on overlay click */
document.getElementById('tmOv').addEventListener('click', function(e) {
  if (e.target === this) hideTagMgmt();
});

/* ================================================================
   SORTABLEJS â€” touch-friendly drag & drop
   ================================================================ */
function initSortables() {
  if (typeof Sortable === 'undefined') return;

  document.querySelectorAll('.task-list').forEach(function(el) {
    Sortable.create(el, {
      group: 'tasks',
      handle: '.drag-handle',
      animation: 180,
      ghostClass: 'task-ghost',
      chosenClass: 'task-chosen',
      fallbackOnBody: true,
      swapThreshold: 0.65,
      onStart: function() { isDragging = true; },
      onEnd: function(evt) {
        isDragging = false;
        var taskId    = evt.item.dataset.taskId;
        var fromSecId = evt.from.dataset.sectionId;
        var toSecId   = evt.to.dataset.sectionId;
        handleMove(fromSecId, toSecId, taskId, evt.newIndex);
      }
    });
  });
}

/* ================================================================
   TOAST / UNDO
   ================================================================ */
var toastTimer  = null;
var toastUndoFn = null;

function showToast(msg, undoFn) {
  var t = document.getElementById('toast');
  document.getElementById('toastMsg').textContent = msg;
  toastUndoFn = undoFn || null;
  document.getElementById('toastUndo').style.display = undoFn ? '' : 'none';
  t.classList.add('show');
  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(hideToast, 5000);
}

function hideToast() {
  document.getElementById('toast').classList.remove('show');
  toastUndoFn = null;
  if (toastTimer) { clearTimeout(toastTimer); toastTimer = null; }
}

document.getElementById('toastUndo').addEventListener('click', function() {
  if (toastUndoFn) toastUndoFn();
  hideToast();
});

/* ================================================================
   SYNC-KEY UI
   ================================================================ */
function showOv() {
  document.getElementById('ov').style.display = 'flex';
  var inp = document.getElementById('keyIn');
  inp.value = syncKey || '';
  inp.focus();
}
function hideOv() {
  document.getElementById('ov').style.display = 'none';
}

document.getElementById('keyGo').addEventListener('click', function() {
  var v = document.getElementById('keyIn').value.trim().toLowerCase().replace(/[^a-z0-9\-]/g, '');
  if (!v) { document.getElementById('keyIn').style.borderColor = '#F44336'; return; }
  syncKey = v;
  localStorage.setItem('bozzone-sync-key', syncKey);
  hideOv();
  if (fbReady) startSync();
  else document.getElementById('keyLbl').textContent = syncKey;
});

document.getElementById('keyIn').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') document.getElementById('keyGo').click();
});

document.getElementById('gearBtn').addEventListener('click', showOv);
document.getElementById('keyLbl').addEventListener('click', showOv);

/* ================================================================
   INIT
   ================================================================ */
if (!syncKey) showOv();

loadLS();
if (!appData.sections || !appData.sections.length) {
  appData = buildInitialData();
}
render();
initFB();

/* Service worker */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(function() {});
}

/* CSV file input handler */
document.getElementById('csvFileInput').addEventListener('change', function() {
  var file = this.files[0];
  if (!file) return;
  if (!file.name.toLowerCase().endsWith('.csv')) {
    showToast('Please select a .csv file');
    return;
  }
  var reader = new FileReader();
  reader.onload = function(e) {
    var rows = parseCSV(e.target.result);
    showImportPreview(rows);
  };
  reader.readAsText(file);
});

/* Close CSV modal on overlay click */
document.getElementById('csvOv').addEventListener('click', function(e) {
  if (e.target === this) hideImportModal();
});

/* â”€â”€ Search bar â”€â”€ */
(function() {
  var inp   = document.getElementById('searchInput');
  var clear = document.getElementById('searchClear');
  inp.addEventListener('input', function() {
    setSearch(inp.value);
    clear.classList.toggle('show', inp.value.length > 0);
  });
  clear.addEventListener('click', function() {
    inp.value = '';
    clear.classList.remove('show');
    setSearch('');
  });
})();

/* â”€â”€ New Task Modal â”€â”€ */
document.getElementById('ntOv').addEventListener('click', function(e) {
  if (e.target === this) hideNewTaskModal();
});
document.getElementById('ntCancel').addEventListener('click', hideNewTaskModal);
document.getElementById('ntCreate').addEventListener('click', function() {
  var title = document.getElementById('ntTitle').value.trim();
  if (!title) { document.getElementById('ntTitle').focus(); return; }
  var secId = document.getElementById('ntSection').value;
  createTask(secId, {
    text:     title,
    desc:     document.getElementById('ntDesc').value,
    status:   document.getElementById('ntStatus').value,
    priority: document.getElementById('ntPriority').value || null,
    dueDate:  document.getElementById('ntDueDate').value  || null,
    subtasks: ntPendingSubtasks.slice()
  });
  hideNewTaskModal();
});

/* Sub-task add button in modal */
document.getElementById('ntSubAdd').addEventListener('click', function() {
  var inp = document.getElementById('ntSubInput');
  var v   = inp.value.trim();
  if (v) {
    ntPendingSubtasks.push({ text: v, done: false });
    renderNtSubtasks();
    inp.value = '';
    inp.focus();
  }
});
document.getElementById('ntSubInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('ntSubAdd').click();
  }
});
document.getElementById('ntTitle').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('ntCreate').click();
  }
});
</script>
</body>
</html>
