<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#D97757">
  <title>Bozzone Tasks</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="icon.svg">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <!-- SortableJS — touch-friendly drag & drop -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.3/Sortable.min.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --accent: #D97757;
      --accent-light: #fff3ec;
      --accent-dark: #7a3a1e;
      --bg: #faf9f5;
      --card-bg: #fff;
      --card-header-bg: #f5f4ef;
      --border: #e5e4df;
      --text: #141413;
      --text-sec: #888;
      --text-muted: #aaa;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 12px;
      padding-bottom: calc(80px + var(--safe-bottom));
      min-height: 100vh;
      min-height: 100dvh;
      -webkit-tap-highlight-color: transparent;
    }

    /* ── Header ─────────────────────────────────── */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid var(--accent);
      padding-bottom: 10px;
      margin-bottom: 14px;
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 100;
      padding-top: env(safe-area-inset-top, 4px);
    }
    header h1 {
      font-size: 1.1rem;
      color: var(--accent);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .hdr-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }
    .sync-dot {
      width: 9px; height: 9px;
      border-radius: 50%;
      background: #ccc;
      transition: background .3s;
    }
    .sync-dot.on  { background: #4CAF50; }
    .sync-dot.wait { background: #FFC107; }
    .sync-dot.off  { background: #F44336; }
    .key-label {
      font-size: .7rem;
      color: var(--text-sec);
      cursor: pointer;
    }
    .gear {
      background: none; border: none;
      font-size: 1.15rem; cursor: pointer;
      padding: 4px; opacity: .45;
    }
    .gear:hover, .gear:active { opacity: 1; }

    /* ── Focus Banner ───────────────────────────── */
    .focus {
      background: var(--accent-light);
      border-left: 4px solid var(--accent);
      padding: 9px 12px;
      border-radius: 4px;
      margin-bottom: 14px;
      font-size: .84rem;
      color: var(--accent-dark);
      line-height: 1.4;
    }

    /* ── Overall Progress ───────────────────────── */
    .overall {
      margin-bottom: 14px;
      padding: 10px 14px;
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,.07);
    }
    .overall-top {
      display: flex;
      justify-content: space-between;
      font-size: .82rem;
      margin-bottom: 5px;
      color: var(--text-sec);
    }
    .bar-wrap {
      background: #eee;
      border-radius: 6px;
      height: 7px;
      overflow: hidden;
    }
    .bar {
      height: 100%;
      background: var(--accent);
      border-radius: 6px;
      transition: width .35s ease;
    }

    /* ── Filter Bar ─────────────────────────────── */
    .filter-bar {
      display: flex;
      gap: 7px;
      margin-bottom: 14px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding: 2px 0;
      scrollbar-width: none;
      align-items: center;
    }
    .filter-bar::-webkit-scrollbar { display: none; }
    .filter-btn {
      flex-shrink: 0;
      padding: 5px 13px;
      border-radius: 18px;
      border: 1.5px solid var(--border);
      background: var(--card-bg);
      font-size: .76rem;
      font-family: inherit;
      cursor: pointer;
      color: var(--text-sec);
      transition: all .2s;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .filter-btn:active { transform: scale(.96); }
    .filter-btn.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .filter-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .filter-count {
      font-size: .68rem;
      opacity: .75;
    }
    .filter-manage-btn {
      flex-shrink: 0;
      width: 28px; height: 28px;
      border-radius: 50%;
      border: 1.5px dashed var(--border);
      background: none;
      font-size: .9rem;
      cursor: pointer;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .filter-manage-btn:active { background: var(--accent-light); }

    /* ── Grid ────────────────────────────────────── */
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }
    @media (min-width: 700px)  { .grid { grid-template-columns: repeat(2,1fr); } body { padding: 20px; } header h1 { font-size: 1.35rem; } }
    @media (min-width: 1100px) { .grid { grid-template-columns: repeat(3,1fr); } }

    /* ── Cards ───────────────────────────────────── */
    .card {
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,.07);
      overflow: hidden;
    }
    .card-hd {
      background: var(--card-header-bg);
      padding: 11px 14px;
      font-weight: 600;
      font-size: .88rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-hd .badge {
      background: var(--accent);
      color: #fff;
      font-size: .7rem;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 500;
      flex-shrink: 0;
    }
    .card-bd { padding: 10px 14px; }
    .priority .card-hd {
      background: var(--accent-light);
      border-bottom-color: #f8d5c2;
    }

    /* ── Section title (editable) ────────────────── */
    .sec-title {
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: pointer;
      border-radius: 4px;
      padding: 1px 4px;
      margin: -1px -4px;
      transition: background .15s;
    }
    .sec-title:hover { background: rgba(0,0,0,.04); }
    .sec-title-input {
      font-size: .88rem;
      font-weight: 600;
      font-family: inherit;
      border: 1.5px solid var(--accent);
      border-radius: 4px;
      padding: 2px 6px;
      outline: none;
      flex: 1;
      min-width: 0;
      background: #fff;
    }

    /* ── Section header actions ──────────────────── */
    .sec-actions {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }
    .sec-del {
      background: none; border: none;
      color: #ccc; font-size: .95rem;
      cursor: pointer; padding: 2px 4px;
      border-radius: 4px; line-height: 1;
      transition: color .15s;
    }
    .sec-del:hover, .sec-del:active { color: #e74c3c; }

    /* ── Add Column Card ────────────────────────── */
    .add-col-card {
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,.04);
      border: 2px dashed var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100px;
      cursor: pointer;
      transition: border-color .2s, background .2s;
      padding: 20px;
    }
    .add-col-card:hover, .add-col-card:active {
      border-color: var(--accent);
      background: var(--accent-light);
    }
    .add-col-card.expanded {
      cursor: default;
      border-color: var(--accent);
      align-items: stretch;
    }
    .add-col-card.expanded:hover { background: var(--card-bg); }
    .add-col-icon { font-size: 1.8rem; color: var(--text-muted); margin-bottom: 4px; }
    .add-col-label { font-size: .82rem; color: var(--text-sec); }
    .add-col-form { width: 100%; }
    .add-col-form input {
      width: 100%; padding: 10px;
      border: 1.5px solid #ddd; border-radius: 6px;
      font-size: .86rem; font-family: inherit;
      margin-bottom: 8px; outline: none;
    }
    .add-col-form input:focus { border-color: var(--accent); }
    .add-col-form label {
      font-size: .75rem; color: var(--text-sec);
      display: block; margin-bottom: 4px;
    }
    .emoji-row {
      display: flex; flex-wrap: wrap;
      gap: 5px; margin-bottom: 10px;
    }
    .emoji-pick {
      width: 32px; height: 32px;
      border: 1.5px solid var(--border); border-radius: 6px;
      background: var(--card-bg); font-size: 1rem;
      cursor: pointer; display: flex;
      align-items: center; justify-content: center;
    }
    .emoji-pick.sel {
      border-color: var(--accent);
      background: var(--accent-light);
    }
    .add-col-btns { display: flex; gap: 8px; }
    .add-col-btns button {
      flex: 1; padding: 10px; border-radius: 6px;
      font-size: .84rem; font-family: inherit;
      cursor: pointer; font-weight: 600;
    }
    .btn-create { background: var(--accent); color: #fff; border: none; }
    .btn-create:active { opacity: .85; }
    .btn-cancel { background: none; border: 1.5px solid var(--border); color: var(--text-sec); }

    /* ── Progress per card ───────────────────────── */
    .prog-wrap {
      background: #eee; border-radius: 4px;
      height: 4px; margin: 6px 0 3px; overflow: hidden;
    }
    .prog {
      height: 100%; background: var(--accent);
      border-radius: 4px; transition: width .35s ease;
    }
    .prog-lbl {
      font-size: .7rem; color: var(--text-muted);
      text-align: right; margin-bottom: 4px;
    }

    /* ── Task list (sortable container) ──────────── */
    .task-list { min-height: 8px; }
    .task-empty {
      padding: 12px 0; text-align: center;
      font-size: .8rem; color: var(--text-muted);
      font-style: italic;
    }

    /* ── Tasks ───────────────────────────────────── */
    .task {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      padding: 8px 0;
      border-bottom: 1px solid #f0efea;
      font-size: .86rem;
      line-height: 1.42;
      background: var(--card-bg);
    }
    .task:last-child { border-bottom: none; }

    .task input[type="checkbox"] {
      margin: 2px 0 0 0;
      accent-color: var(--accent);
      width: 18px; height: 18px;
      flex-shrink: 0;
      cursor: pointer;
    }
    .task-content {
      flex: 1;
      min-width: 0;
    }
    .task-content label {
      cursor: pointer;
      color: #333;
      user-select: none;
      -webkit-user-select: none;
      word-break: break-word;
      display: block;
    }
    .task.done .task-content label {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    /* ── Tag badges on tasks ────────────────────── */
    .tag-badges {
      display: flex;
      gap: 3px;
      flex-wrap: wrap;
      margin-top: 3px;
    }
    .tag-badge {
      font-size: .58rem;
      padding: 1px 7px;
      border-radius: 8px;
      color: #fff;
      font-weight: 600;
      white-space: nowrap;
      line-height: 1.6;
      letter-spacing: .02em;
    }

    /* ── Task action buttons ─────────────────────── */
    .task-actions {
      display: flex;
      align-items: center;
      gap: 2px;
      flex-shrink: 0;
      margin-top: 1px;
    }
    .tag-btn {
      background: none; border: none;
      font-size: .72rem; cursor: pointer;
      padding: 3px 4px; color: #ccc;
      flex-shrink: 0; line-height: 1;
      transition: color .15s;
    }
    .tag-btn:hover, .tag-btn:active { color: var(--accent); }

    /* Drag handle */
    .drag-handle {
      cursor: grab;
      color: #c5c5c5;
      font-size: .95rem;
      padding: 4px 4px 4px 0;
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
      flex-shrink: 0;
      line-height: 1;
      margin-top: 1px;
    }
    .drag-handle:active { cursor: grabbing; color: var(--accent); }

    /* Delete button */
    .del-btn {
      background: none; border: none;
      color: #ccc; font-size: 1.1rem;
      cursor: pointer; padding: 3px 5px;
      border-radius: 4px; flex-shrink: 0;
      line-height: 1; transition: color .15s;
    }
    .del-btn:hover, .del-btn:active { color: #e74c3c; }

    @media (hover: hover) {
      .del-btn, .tag-btn { opacity: 0; transition: opacity .15s, color .15s; }
      .task:hover .del-btn, .task:hover .tag-btn { opacity: 1; }
    }

    /* SortableJS states */
    .task-ghost {
      opacity: .35;
      background: var(--accent-light);
      border-radius: 6px;
    }
    .task-chosen {
      background: #fff;
      box-shadow: 0 4px 16px rgba(0,0,0,.12);
      border-radius: 6px;
    }

    /* ── Add-task row ────────────────────────────── */
    .add-row {
      display: flex;
      gap: 6px;
      padding-top: 8px;
      margin-top: 4px;
      border-top: 1px dashed var(--border);
    }
    .add-input {
      flex: 1;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 8px 10px;
      font-size: .82rem;
      font-family: inherit;
      outline: none;
      min-width: 0;
    }
    .add-input:focus { border-color: var(--accent); }
    .add-input::placeholder { color: #c0c0c0; }
    .add-btn {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      width: 36px;
      font-size: 1.25rem;
      cursor: pointer;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .add-btn:active { opacity: .85; }

    /* ── Toast (undo) ────────────────────────────── */
    .toast {
      position: fixed;
      bottom: calc(20px + var(--safe-bottom));
      left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: #333;
      color: #fff;
      padding: 11px 18px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 14px;
      font-size: .86rem;
      box-shadow: 0 4px 20px rgba(0,0,0,.3);
      transition: transform .3s ease;
      z-index: 500;
      white-space: nowrap;
    }
    .toast.show { transform: translateX(-50%) translateY(0); }
    .toast-undo {
      background: none; border: none;
      color: var(--accent); font-weight: 700;
      font-size: .86rem; cursor: pointer; padding: 0;
    }

    /* ── Tag Picker Modal ────────────────────────── */
    .tp-ov {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.35);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 900;
      padding: 20px;
    }
    .tp-ov.show { display: flex; }
    @media (min-width: 600px) {
      .tp-ov { align-items: center; }
    }
    .tp-box {
      background: #fff;
      border-radius: 14px 14px 0 0;
      padding: 18px;
      max-width: 340px;
      width: 100%;
      box-shadow: 0 -4px 24px rgba(0,0,0,.12);
      max-height: 60vh;
      overflow-y: auto;
    }
    @media (min-width: 600px) {
      .tp-box { border-radius: 14px; }
    }
    .tp-title {
      font-size: .92rem; font-weight: 600;
      margin-bottom: 10px; color: var(--text);
    }
    .tp-item {
      display: flex; align-items: center;
      gap: 10px; padding: 10px 6px;
      border-radius: 6px; cursor: pointer;
      transition: background .12s;
    }
    .tp-item:hover { background: #f5f5f5; }
    .tp-item:active { background: #eee; }
    .tp-dot {
      width: 14px; height: 14px;
      border-radius: 50%; flex-shrink: 0;
    }
    .tp-name { flex: 1; font-size: .86rem; }
    .tp-check { font-size: 1rem; color: var(--accent); }
    .tp-empty {
      font-size: .82rem; color: var(--text-muted);
      text-align: center; padding: 14px 0;
      font-style: italic;
    }

    /* ── Tag Management Modal ────────────────────── */
    .tm-ov {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .tm-ov.show { display: flex; }
    .tm-box {
      background: #fff;
      border-radius: 14px;
      padding: 22px 18px;
      max-width: 380px;
      width: 100%;
      box-shadow: 0 8px 32px rgba(0,0,0,.2);
      max-height: 80vh;
      overflow-y: auto;
    }
    .tm-box h2 {
      color: var(--accent);
      margin-bottom: 14px;
      font-size: 1.05rem;
    }
    .tm-list { margin-bottom: 14px; }
    .tm-item {
      display: flex; align-items: center;
      gap: 8px; padding: 8px 4px;
      border-bottom: 1px solid #f0f0f0;
    }
    .tm-color {
      width: 18px; height: 18px;
      border-radius: 50%; flex-shrink: 0;
    }
    .tm-name { flex: 1; font-size: .86rem; }
    .tm-del {
      background: none; border: none;
      color: #ccc; font-size: 1.05rem;
      cursor: pointer; padding: 2px 6px;
    }
    .tm-del:hover { color: #e74c3c; }
    .tm-divider {
      height: 1px; background: var(--border);
      margin: 10px 0;
    }
    .tm-subtitle {
      font-size: .82rem; font-weight: 600;
      color: var(--text-sec); margin-bottom: 8px;
    }
    .tm-add-row {
      display: flex; gap: 6px; margin-bottom: 8px;
    }
    .tm-add-input {
      flex: 1; padding: 8px 10px;
      border: 1.5px solid #ddd; border-radius: 6px;
      font-size: .84rem; font-family: inherit; outline: none;
    }
    .tm-add-input:focus { border-color: var(--accent); }
    .tm-colors {
      display: flex; gap: 6px;
      flex-wrap: wrap; margin-bottom: 10px;
    }
    .tm-color-opt {
      width: 26px; height: 26px;
      border-radius: 50%;
      border: 2.5px solid transparent;
      cursor: pointer;
      transition: border-color .15s, transform .15s;
    }
    .tm-color-opt:hover { transform: scale(1.12); }
    .tm-color-opt.sel { border-color: var(--text); }
    .tm-add-btn {
      background: var(--accent); color: #fff;
      border: none; border-radius: 6px;
      padding: 8px 16px; font-size: .84rem;
      cursor: pointer; font-weight: 600;
      width: 100%;
    }
    .tm-add-btn:active { opacity: .85; }
    .tm-close {
      width: 100%; padding: 10px;
      background: none; border: 1.5px solid var(--border);
      border-radius: 8px; font-size: .88rem;
      cursor: pointer; color: var(--text-sec);
      margin-top: 8px; font-family: inherit;
    }

    /* ── CSV Import Modal ────────────────────────── */
    .csv-ov {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .csv-ov.show { display: flex; }
    .csv-box {
      background: #fff;
      border-radius: 14px;
      padding: 22px 18px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 8px 32px rgba(0,0,0,.2);
      max-height: 80vh;
      overflow-y: auto;
    }
    .csv-box h2 { color: var(--accent); margin-bottom: 6px; font-size: 1.05rem; }
    .csv-box p { font-size: .82rem; color: var(--text-sec); margin-bottom: 12px; line-height: 1.5; }
    .csv-sec-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 10px; border-radius: 6px; margin-bottom: 4px;
      font-size: .84rem;
    }
    .csv-sec-item.new-sec  { background: #f0fff4; }
    .csv-sec-item.exist-sec { background: #f5f4ef; }
    .csv-sec-badge {
      font-size: .68rem; padding: 2px 8px; border-radius: 10px;
      font-weight: 600; white-space: nowrap; flex-shrink: 0; margin-left: 8px;
    }
    .csv-sec-badge.new   { background: #4CAF50; color: #fff; }
    .csv-sec-badge.exist { background: var(--accent); color: #fff; }
    .csv-hint {
      font-size: .76rem; color: var(--text-muted);
      background: #f8f8f8; border-radius: 6px;
      padding: 8px 10px; margin-bottom: 12px; line-height: 1.5;
    }
    .csv-hint code { font-size: .74rem; background: #eee; padding: 1px 4px; border-radius: 3px; }
    .csv-actions { display: flex; gap: 8px; margin-top: 14px; }
    .csv-actions button {
      flex: 1; padding: 10px; border-radius: 6px;
      font-size: .86rem; font-family: inherit;
      cursor: pointer; font-weight: 600;
    }
    .csv-btn-confirm { background: var(--accent); color: #fff; border: none; }
    .csv-btn-confirm:active { opacity: .85; }
    .csv-btn-cancel  { background: none; border: 1.5px solid var(--border); color: var(--text-sec); }

    /* ── Search Bar ──────────────────────────────── */
    .search-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #fff;
      border: 1.5px solid var(--border);
      border-radius: 10px;
      padding: 8px 12px;
      margin-bottom: 12px;
    }
    .search-wrap:focus-within { border-color: var(--accent); }
    .search-icon { font-size: 1rem; color: var(--text-muted); flex-shrink: 0; }
    #searchInput {
      flex: 1; border: none; outline: none;
      font-size: .88rem; font-family: inherit;
      background: transparent; color: var(--text);
      min-width: 0;
    }
    #searchInput::placeholder { color: var(--text-muted); }
    .search-clear {
      background: none; border: none;
      color: var(--text-muted); font-size: 1rem;
      cursor: pointer; padding: 0 2px;
      display: none;
    }
    .search-clear.show { display: block; }

    /* ── Status Button (replaces checkbox) ───────── */
    .status-btn {
      width: 22px; height: 22px;
      border-radius: 50%;
      border: 2px solid #ccc;
      background: none;
      cursor: pointer;
      font-size: .75rem;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      transition: border-color .15s, background .15s, color .15s;
      padding: 0;
      line-height: 1;
      color: transparent;
    }
    .status-btn[data-status="todo"]       { border-color: #bbb; color: transparent; background: #fff; }
    .status-btn[data-status="inprogress"] { border-color: var(--accent); color: var(--accent); background: #fff3ec; font-size: .7rem; }
    .status-btn[data-status="done"]       { border-color: #27AE60; color: #fff; background: #27AE60; }
    .status-btn:hover { opacity: .8; }

    /* Task done-state via status */
    .task.status-done > .task-content > label { text-decoration: line-through; color: var(--text-muted); }
    .task.status-done { opacity: .72; }

    /* ── Priority border ─────────────────────────── */
    .task[data-priority="high"]   { border-left: 3px solid #e74c3c; padding-left: 7px; }
    .task[data-priority="medium"] { border-left: 3px solid #F39C12; padding-left: 7px; }
    .task[data-priority="low"]    { border-left: 3px solid #27AE60; padding-left: 7px; }

    /* ── Due Date Chip ───────────────────────────── */
    .due-chip {
      display: inline-block;
      font-size: .7rem;
      color: var(--text-sec);
      background: #f0f0ec;
      border-radius: 10px;
      padding: 1px 7px;
      margin-top: 3px;
      white-space: nowrap;
    }
    .due-chip.today   { background: #FFF3CD; color: #856404; font-weight: 600; }
    .due-chip.overdue { background: #fde8e8; color: #c0392b; font-weight: 600; }

    /* ── Subtask display ─────────────────────────── */
    .subtask-summary {
      font-size: .72rem; color: var(--accent);
      cursor: pointer; margin-top: 3px;
      display: inline-block;
      user-select: none;
    }
    .subtask-summary:hover { text-decoration: underline; }
    .subtask-list {
      margin-top: 6px;
      border-top: 1px dashed var(--border);
      padding-top: 6px;
      display: none;
    }
    .subtask-list.open { display: block; }
    .subtask-item {
      display: flex; align-items: center; gap: 6px;
      padding: 3px 0;
      font-size: .8rem;
    }
    .subtask-item input[type="checkbox"] {
      width: 14px; height: 14px;
      cursor: pointer; flex-shrink: 0;
      accent-color: var(--accent);
    }
    .subtask-item label {
      flex: 1; cursor: pointer;
      color: var(--text);
      text-decoration: none;
    }
    .subtask-item.done label { text-decoration: line-through; color: var(--text-muted); }
    .subtask-del {
      background: none; border: none;
      color: #ccc; font-size: .9rem;
      cursor: pointer; padding: 0 3px;
      line-height: 1;
    }
    .subtask-del:hover { color: #e74c3c; }
    .subtask-add-row {
      display: flex; gap: 5px; margin-top: 5px;
    }
    .subtask-add-input {
      flex: 1; border: 1px solid #ddd;
      border-radius: 5px; padding: 4px 8px;
      font-size: .78rem; font-family: inherit;
      outline: none; min-width: 0;
    }
    .subtask-add-input:focus { border-color: var(--accent); }
    .subtask-add-btn {
      background: var(--accent); color: #fff;
      border: none; border-radius: 5px;
      padding: 4px 9px; font-size: .82rem;
      cursor: pointer;
    }

    /* ── New Task Row (replaces add-row) ─────────── */
    .add-task-row {
      display: flex;
      align-items: center;
      padding-top: 8px;
      margin-top: 4px;
      border-top: 1px dashed var(--border);
    }
    .add-task-btn {
      display: flex; align-items: center; gap: 6px;
      background: none; border: none;
      color: var(--accent); font-size: .84rem;
      cursor: pointer; padding: 4px 2px;
      font-family: inherit; font-weight: 600;
    }
    .add-task-btn:hover { opacity: .8; }

    /* ── New Task Modal ───────────────────────────── */
    .nt-ov {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1100;
      padding: 20px;
    }
    .nt-ov.show { display: flex; }
    .nt-box {
      background: #fff;
      border-radius: 14px;
      padding: 22px 18px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 8px 32px rgba(0,0,0,.22);
      max-height: 90vh;
      overflow-y: auto;
    }
    .nt-box h2 {
      color: var(--accent); font-size: 1.05rem;
      margin-bottom: 14px;
    }
    .nt-field {
      margin-bottom: 12px;
    }
    .nt-field label {
      display: block; font-size: .78rem;
      font-weight: 600; color: var(--text-sec);
      margin-bottom: 4px; text-transform: uppercase;
      letter-spacing: .04em;
    }
    .nt-field input[type="text"],
    .nt-field input[type="date"],
    .nt-field textarea,
    .nt-field select {
      width: 100%; padding: 9px 11px;
      border: 1.5px solid #ddd; border-radius: 7px;
      font-size: .88rem; font-family: inherit;
      outline: none; background: #fff;
      color: var(--text);
    }
    .nt-field input:focus,
    .nt-field textarea:focus,
    .nt-field select:focus { border-color: var(--accent); }
    .nt-field textarea { min-height: 64px; resize: vertical; }
    .nt-row {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 10px; margin-bottom: 12px;
    }
    .nt-subtask-list { margin-bottom: 8px; }
    .nt-subtask-item {
      display: flex; align-items: center; gap: 6px;
      padding: 4px 0; font-size: .84rem;
      border-bottom: 1px solid #f0f0f0;
    }
    .nt-subtask-item span { flex: 1; }
    .nt-subtask-del {
      background: none; border: none;
      color: #ccc; font-size: .9rem;
      cursor: pointer; padding: 0 4px;
    }
    .nt-subtask-del:hover { color: #e74c3c; }
    .nt-subtask-add {
      display: flex; gap: 6px; margin-top: 6px;
    }
    .nt-subtask-add input {
      flex: 1; padding: 7px 10px;
      border: 1.5px solid #ddd; border-radius: 6px;
      font-size: .82rem; font-family: inherit; outline: none;
    }
    .nt-subtask-add input:focus { border-color: var(--accent); }
    .nt-subtask-add button {
      background: var(--accent); color: #fff;
      border: none; border-radius: 6px;
      padding: 7px 12px; font-size: .82rem;
      cursor: pointer; font-weight: 600;
    }
    .nt-actions {
      display: flex; gap: 8px; margin-top: 16px;
    }
    .nt-actions button {
      flex: 1; padding: 11px; border-radius: 7px;
      font-size: .88rem; font-family: inherit;
      cursor: pointer; font-weight: 600;
    }
    .nt-create { background: var(--accent); color: #fff; border: none; }
    .nt-create:active { opacity: .85; }
    .nt-cancel  { background: none; border: 1.5px solid var(--border); color: var(--text-sec); }

    /* ── Overlay (sync-key setup) ────────────────── */
    .ov {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .ov-box {
      background: #fff;
      border-radius: 14px;
      padding: 28px 22px;
      max-width: 380px;
      width: 100%;
      box-shadow: 0 8px 32px rgba(0,0,0,.2);
    }
    .ov-box h2 {
      color: var(--accent);
      margin-bottom: 10px;
      font-size: 1.15rem;
    }
    .ov-box p {
      font-size: .88rem; color: #555;
      margin-bottom: 14px; line-height: 1.5;
    }
    .ov-box input {
      width: 100%; padding: 12px;
      border: 2px solid #ddd; border-radius: 8px;
      font-size: 1rem; text-align: center;
      font-family: monospace; letter-spacing: 2px;
      margin-bottom: 12px;
    }
    .ov-box input:focus { outline: none; border-color: var(--accent); }
    .ov-box button {
      width: 100%; padding: 12px;
      background: var(--accent); color: #fff;
      border: none; border-radius: 8px;
      font-size: 1rem; font-weight: 600; cursor: pointer;
    }
    .ov-box button:active { opacity: .9; }

    /* ── Config banner ───────────────────────────── */
    .cfg-banner {
      background: #FFF3CD;
      border: 1px solid #FFEEBA;
      border-radius: 10px;
      padding: 20px 16px;
      margin-bottom: 16px;
    }
    .cfg-banner h2 { color: #856404; font-size: 1rem; margin-bottom: 6px; }
    .cfg-banner p  { color: #856404; font-size: .85rem; line-height: 1.5; }
    .cfg-banner code {
      background: #f8f0d8; padding: 1px 5px;
      border-radius: 3px; font-size: .82rem;
    }

    /* ══════════════════════════════════════════════
       DARK MODE
       ══════════════════════════════════════════════ */
    [data-theme="dark"] {
      --bg: #1a1918;
      --card-bg: #242320;
      --card-header-bg: #2e2c28;
      --border: #3d3c38;
      --text: #f0efe9;
      --text-sec: #a09f9a;
      --text-muted: #6a6a66;
      --accent-light: #3d2010;
      --accent-dark: #ffb899;
    }
    [data-theme="dark"] .bar-wrap  { background: #3a3835; }
    [data-theme="dark"] .prog-wrap { background: #3a3835; }
    [data-theme="dark"] .filter-btn { background: var(--card-bg); color: var(--text-sec); }
    [data-theme="dark"] .search-wrap { background: var(--card-bg); border-color: var(--border); }
    [data-theme="dark"] .task { background: var(--card-bg); }
    [data-theme="dark"] .add-col-card { background: var(--card-bg); border-color: var(--border); }
    [data-theme="dark"] .add-col-form input { background: #111110; color: var(--text); border-color: var(--border); }
    [data-theme="dark"] .ov-box,
    [data-theme="dark"] .nt-box,
    [data-theme="dark"] .tm-box,
    [data-theme="dark"] .tp-box,
    [data-theme="dark"] .csv-box  { background: var(--card-bg); color: var(--text); }
    [data-theme="dark"] .nt-field input,
    [data-theme="dark"] .nt-field textarea,
    [data-theme="dark"] .nt-field select { background: #111110; color: var(--text); border-color: var(--border); }
    [data-theme="dark"] .tm-add-input { background: #111110; color: var(--text); border-color: var(--border); }
    [data-theme="dark"] .tp-item:hover { background: #333; }
    [data-theme="dark"] .cfg-banner { background: #3d3000; border-color: #554400; }
    [data-theme="dark"] .cfg-banner h2,
    [data-theme="dark"] .cfg-banner p { color: #ffd080; }
    [data-theme="dark"] .ov-box input { background: #111110; color: var(--text); border-color: var(--border); }
    [data-theme="dark"] .task-empty { color: var(--text-muted); }
    [data-theme="dark"] .tm-item { border-color: var(--border); }
    [data-theme="dark"] .nt-subtask-add input { background: #111110; color: var(--text); border-color: var(--border); }

    .dark-toggle {
      background: none; border: none;
      font-size: 1.05rem; cursor: pointer;
      padding: 4px; opacity: .5;
      transition: opacity .15s;
      line-height: 1;
    }
    .dark-toggle:hover { opacity: 1; }

    /* ══════════════════════════════════════════════
       UNDO / REDO BUTTONS
       ══════════════════════════════════════════════ */
    .ur-btn {
      background: none; border: none;
      font-size: .95rem; cursor: pointer;
      padding: 4px 5px; opacity: .38;
      border-radius: 5px; line-height: 1;
      transition: opacity .15s, background .15s;
    }
    .ur-btn:not([disabled]):hover { opacity: 1; background: rgba(0,0,0,.06); }
    .ur-btn[disabled] { opacity: .15; cursor: default; }
    [data-theme="dark"] .ur-btn:not([disabled]):hover { background: rgba(255,255,255,.09); }

    /* ══════════════════════════════════════════════
       SMART VIEW BAR (Overdue / High Pri / In-Progress / My Week)
       ══════════════════════════════════════════════ */
    .view-bar {
      display: flex; gap: 6px;
      margin-bottom: 8px;
      overflow-x: auto; -webkit-overflow-scrolling: touch;
      scrollbar-width: none; padding: 2px 0;
    }
    .view-bar::-webkit-scrollbar { display: none; }
    .view-chip {
      flex-shrink: 0;
      padding: 4px 11px; border-radius: 14px;
      border: 1.5px solid var(--border);
      background: var(--card-bg);
      font-size: .72rem; font-family: inherit;
      cursor: pointer; color: var(--text-sec);
      transition: all .2s; white-space: nowrap;
      display: flex; align-items: center; gap: 4px;
    }
    .view-chip:active { transform: scale(.95); }
    .view-chip.active                { color:#fff; border-color:#555; background:#555; }
    .view-chip.active.vc-overdue     { background:#c0392b; border-color:#c0392b; }
    .view-chip.active.vc-high        { background:#e74c3c; border-color:#e74c3c; }
    .view-chip.active.vc-progress    { background:#D97757; border-color:#D97757; }
    .view-chip.active.vc-week        { background:#27AE60; border-color:#27AE60; }

    /* ══════════════════════════════════════════════
       OVERDUE URGENCY PULSE
       ══════════════════════════════════════════════ */
    @keyframes overdue-pulse {
      0%   { box-shadow: 0 0 0 0 rgba(192,57,43,.5); }
      70%  { box-shadow: 0 0 0 5px rgba(192,57,43,0); }
      100% { box-shadow: 0 0 0 0 rgba(192,57,43,0); }
    }
    .task.overdue-urgent {
      border-left: 3px solid #c0392b !important;
      padding-left: 7px;
      animation: overdue-pulse 2.8s ease-out infinite;
      border-radius: 4px;
    }

    /* ══════════════════════════════════════════════
       TASK NOTES
       ══════════════════════════════════════════════ */
    .task-notes {
      font-size: .75rem; color: var(--text-sec);
      margin-top: 5px; line-height: 1.5;
      white-space: pre-wrap; word-break: break-word;
      border-left: 2px solid var(--border);
      padding-left: 7px; display: none;
    }
    .task-notes.visible { display: block; }
    .notes-toggle {
      font-size: .68rem; color: var(--text-muted);
      cursor: pointer; margin-top: 3px;
      display: inline-block; user-select: none;
      -webkit-user-select: none;
    }
    .notes-toggle:hover { color: var(--accent); text-decoration: underline; }
    [data-theme="dark"] .task-notes { border-left-color: var(--border); }

    /* ══════════════════════════════════════════════
       BULK SELECTION
       ══════════════════════════════════════════════ */
    .task-select-cb {
      display: none; margin: 3px 0 0 0;
      width: 16px; height: 16px;
      accent-color: var(--accent);
      cursor: pointer; flex-shrink: 0;
    }
    body.bulk-mode .task-select-cb  { display: block; }
    body.bulk-mode .drag-handle     { display: none; }
    body.bulk-mode .task            { cursor: default; }
    .task.bulk-selected             { background: var(--accent-light) !important; border-radius: 5px; }
    [data-theme="dark"] .task.bulk-selected { background: #3d2010 !important; }

    .bulk-bar {
      position: fixed;
      bottom: calc(18px + var(--safe-bottom)); left: 50%;
      transform: translateX(-50%) translateY(110px);
      background: #1f1f1e; color: #fff;
      border-radius: 14px; padding: 10px 14px;
      display: flex; align-items: center; gap: 9px;
      box-shadow: 0 6px 28px rgba(0,0,0,.45);
      transition: transform .3s ease; z-index: 600;
      font-size: .81rem; white-space: nowrap;
    }
    .bulk-bar.show { transform: translateX(-50%) translateY(0); }
    [data-theme="dark"] .bulk-bar { background: #2e2c28; }
    .bulk-count { font-weight: 700; color: var(--accent); }
    .bulk-sep   { width: 1px; height: 20px; background: #444; flex-shrink: 0; }
    .bulk-action-btn {
      background: none; border: none; color: #ccc;
      font-size: .79rem; cursor: pointer;
      padding: 4px 8px; border-radius: 6px;
      font-family: inherit; transition: background .15s, color .15s;
    }
    .bulk-action-btn:hover        { background: rgba(255,255,255,.12); color: #fff; }
    .bulk-action-btn.danger:hover { background: rgba(231,76,60,.2); color: #ff8070; }
    .bulk-move-sel {
      background: #2a2a28; border: 1px solid #555;
      color: #ddd; border-radius: 6px; padding: 4px 8px;
      font-size: .76rem; font-family: inherit;
      cursor: pointer; outline: none; max-width: 120px;
    }
    .bulk-cancel-btn {
      background: none; border: none; color: #666;
      font-size: 1.1rem; cursor: pointer; padding: 0 3px; line-height: 1;
    }
    .bulk-cancel-btn:hover { color: #aaa; }

    /* ══════════════════════════════════════════════
       TASK TEMPLATES MODAL
       ══════════════════════════════════════════════ */
    .tpl-ov {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.5);
      display: none; align-items: center;
      justify-content: center; z-index: 1100; padding: 20px;
    }
    .tpl-ov.show { display: flex; }
    .tpl-box {
      background: #fff; border-radius: 14px;
      padding: 22px 18px; max-width: 420px; width: 100%;
      box-shadow: 0 8px 32px rgba(0,0,0,.22);
      max-height: 88vh; overflow-y: auto;
    }
    [data-theme="dark"] .tpl-box { background: var(--card-bg); color: var(--text); }
    .tpl-box h2 { color: var(--accent); font-size: 1.05rem; margin-bottom: 14px; }
    .tpl-item {
      display: flex; align-items: flex-start; gap: 8px;
      padding: 10px 10px; border-radius: 8px;
      border: 1.5px solid var(--border); margin-bottom: 8px;
      transition: border-color .15s, background .15s;
    }
    .tpl-item:hover { border-color: var(--accent); background: var(--accent-light); }
    .tpl-item-body { flex: 1; cursor: pointer; }
    .tpl-item-title { font-size: .88rem; font-weight: 600; margin-bottom: 2px; }
    .tpl-item-meta  { font-size: .72rem; color: var(--text-muted); }
    .tpl-item-del {
      background: none; border: none; color: #ccc;
      font-size: 1rem; cursor: pointer; padding: 0 4px; flex-shrink: 0;
    }
    .tpl-item-del:hover { color: #e74c3c; }
    .tpl-empty { font-size: .84rem; color: var(--text-muted); font-style: italic;
                 padding: 14px 0; text-align: center; }
    .tpl-section-lbl {
      font-size: .76rem; font-weight: 600; color: var(--text-sec);
      text-transform: uppercase; letter-spacing: .04em; margin-bottom: 8px;
    }
    .tpl-divider { height: 1px; background: var(--border); margin: 14px 0; }
    .tpl-save-row { display: flex; gap: 6px; margin-bottom: 8px; }
    .tpl-save-input {
      flex: 1; padding: 9px 11px; border: 1.5px solid #ddd;
      border-radius: 7px; font-size: .86rem; font-family: inherit;
      outline: none; background: #fff; color: var(--text);
    }
    [data-theme="dark"] .tpl-save-input { background: #111110; border-color: var(--border); color: var(--text); }
    .tpl-save-input:focus { border-color: var(--accent); }
    .tpl-save-btn {
      background: var(--accent); color: #fff; border: none;
      border-radius: 7px; padding: 9px 15px; font-size: .86rem;
      cursor: pointer; font-weight: 600; font-family: inherit;
    }
    .tpl-save-btn:active { opacity: .85; }
    .tpl-pick-hint { font-size: .78rem; color: var(--text-sec); margin-bottom: 6px; }
    .tpl-close {
      width: 100%; padding: 10px; background: none;
      border: 1.5px solid var(--border); border-radius: 8px;
      font-size: .88rem; cursor: pointer; color: var(--text-sec);
      margin-top: 8px; font-family: inherit;
    }

    /* ══════════════════════════════════════════════
       KEYBOARD SHORTCUTS HINT PANEL
       ══════════════════════════════════════════════ */
    .kbd-btn {
      background: none; border: none; font-size: .9rem;
      cursor: pointer; padding: 4px; opacity: .38;
      transition: opacity .15s; line-height: 1;
    }
    .kbd-btn:hover { opacity: 1; }
    .kbd-panel {
      position: fixed; bottom: calc(60px + var(--safe-bottom)); right: 14px;
      background: rgba(25,24,22,.92); color: #e8e7e2;
      border-radius: 12px; padding: 12px 15px;
      font-size: .75rem; z-index: 700;
      display: none; line-height: 1.8;
      min-width: 195px; backdrop-filter: blur(6px);
      box-shadow: 0 4px 20px rgba(0,0,0,.4);
    }
    .kbd-panel.show { display: block; }
    .kbd-panel-title { font-weight: 700; color: var(--accent); margin-bottom: 6px; font-size: .78rem; }
    .kbd-panel kbd {
      background: rgba(255,255,255,.15); border-radius: 4px;
      padding: 1px 6px; font-family: monospace; font-size: .7rem;
      margin-right: 5px; display: inline-block; min-width: 22px; text-align: center;
    }

    /* ═══════════════════════════════════════════════════
       ENHANCE v2 — editable FOCUS, collapse, sort, inline edit
       ═══════════════════════════════════════════════════ */

    /* Editable FOCUS header */
    .focus { cursor: pointer; transition: background .15s; }
    .focus:hover { background: rgba(0,0,0,.04); }
    [data-theme="dark"] .focus:hover { background: rgba(255,255,255,.06); }
    .focus-input {
      width: 100%; border: none; background: transparent; font-size: inherit;
      color: inherit; font-family: inherit; padding: 0 2px;
      outline: 1px solid var(--accent); border-radius: 2px;
    }

    /* Show/hide completed button */
    .hide-done-btn {
      background: none; border: 1px solid var(--border); border-radius: 6px;
      padding: 3px 9px; font-size: .74rem; cursor: pointer;
      color: var(--text-muted); white-space: nowrap; transition: all .15s;
    }
    .hide-done-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    .hide-done-btn:hover:not(.active) { background: var(--hover); }

    /* Collapse column */
    .sec-collapse-btn {
      background: none; border: none; cursor: pointer; padding: 1px 4px;
      font-size: .75rem; color: var(--text-muted); line-height: 1; flex-shrink: 0;
      transition: transform .2s; border-radius: 3px;
    }
    .sec-collapse-btn:hover { background: var(--hover); }
    .sec-collapsed .card-bd { display: none; }
    .sec-collapsed .sec-collapse-btn { transform: rotate(-90deg) !important; }

    /* Section icon button */
    .sec-icon-btn {
      background: none; border: none; cursor: pointer; font-size: 1rem;
      padding: 1px 3px; border-radius: 3px; line-height: 1; flex-shrink: 0;
      transition: background .15s;
    }
    .sec-icon-btn:hover { background: var(--hover); }
    .sec-icon-input {
      width: 2.8em; text-align: center; border: 1px solid var(--border);
      border-radius: 4px; font-size: 1rem; padding: 1px 2px;
      background: var(--card-bg); color: var(--text);
    }

    /* Sort dropdown */
    .sec-sort-btn {
      background: none; border: none; cursor: pointer; padding: 2px 5px;
      font-size: .68rem; color: var(--text-muted); border-radius: 4px;
      transition: background .15s; line-height: 1;
    }
    .sec-sort-btn:hover, .sec-sort-btn.sorted { background: var(--hover); color: var(--accent); }
    .sort-menu {
      position: absolute; right: 0; top: 100%; background: var(--card-bg);
      border: 1px solid var(--border); border-radius: 6px; z-index: 300;
      box-shadow: 0 4px 14px rgba(0,0,0,.15); min-width: 150px; overflow: hidden;
    }
    .sort-menu button {
      display: block; width: 100%; text-align: left; padding: 8px 13px;
      background: none; border: none; cursor: pointer; font-size: .82rem;
      color: var(--text); white-space: nowrap;
    }
    .sort-menu button:hover { background: var(--hover); }
    .sort-menu button.active { color: var(--accent); font-weight: 600; }

    /* Inline task name edit */
    .task-edit-input {
      width: 100%; border: none; background: transparent; font-size: .88rem;
      color: var(--text); font-family: inherit; padding: 0;
      outline: 1px solid var(--accent); border-radius: 2px;
    }

    /* Inline subtask edit */
    .subtask-edit-input {
      flex: 1; border: none; background: transparent; font-size: .82rem;
      color: var(--text); font-family: inherit; padding: 0;
      outline: 1px solid var(--accent); border-radius: 2px;
    }

    /* Tag inline edit */
    .tm-edit-name {
      border: 1px solid var(--border); border-radius: 4px; padding: 2px 6px;
      font-size: .82rem; background: var(--card-bg); color: var(--text); width: 110px;
    }

    /* My Day Column */
    .my-day-col { border-left: 3px solid #F5A623 !important; }
    .my-day-col .card-hd { background: linear-gradient(135deg, #fff9f0, var(--card-header-bg)); }
    [data-theme="dark"] .my-day-col .card-hd { background: linear-gradient(135deg, rgba(245,166,35,.08), var(--card-header-bg)); }
    .my-day-source { font-size: .68rem; color: var(--text-muted); margin-top: 2px; display: block; }
    .my-day-empty { text-align: center; padding: 24px 10px; color: var(--text-muted); font-size: .82rem; line-height: 1.8; }
    /* My Day toggle button on each task */
    .my-day-btn { background: none; border: none; cursor: pointer; font-size: .78rem; padding: 2px 4px; border-radius: 3px; opacity: .35; transition: all .15s; line-height: 1; }
    .my-day-btn:hover { opacity: 1; background: var(--hover); }
    .my-day-btn.in-my-day { opacity: 1; }

    /* ── Column Groups ─────────────────────────── */
    .group-header {
      grid-column: 1 / -1;
      display: flex; align-items: center; gap: 8px;
      padding: 6px 4px 4px; margin-top: 10px;
      border-bottom: 2px solid var(--accent);
      font-weight: 600; font-size: .85rem; color: var(--accent);
      user-select: none;
    }
    .group-header:first-child { margin-top: 0; }
    .group-collapse-btn {
      background: none; border: none; cursor: pointer;
      font-size: .9rem; padding: 0 2px; color: var(--accent);
      line-height: 1; transition: transform .2s;
    }
    .group-collapse-btn.collapsed { transform: rotate(-90deg); }
    .group-name {
      flex: 1; cursor: pointer; padding: 1px 4px; border-radius: 3px;
    }
    .group-name:hover { background: var(--hover); }
    .group-name-input {
      flex: 1; font: inherit; font-weight: 600; font-size: .85rem;
      color: var(--accent); background: var(--bg); border: 1px solid var(--accent);
      border-radius: 3px; padding: 1px 4px; outline: none;
    }
    .group-count {
      font-size: .72rem; font-weight: 400; color: var(--text-muted); margin-left: 2px;
    }
    .group-del {
      background: none; border: none; cursor: pointer;
      font-size: .8rem; color: var(--text-muted); padding: 0 4px;
      opacity: 0; transition: opacity .15s; line-height: 1;
    }
    .group-header:hover .group-del { opacity: 1; }
    .group-del:hover { color: var(--danger, #e53935); }
    .group-add-btn {
      grid-column: 1 / -1;
      width: 100%; padding: 8px; margin-top: 10px;
      background: none; border: 2px dashed var(--border);
      border-radius: 8px; cursor: pointer; color: var(--text-muted);
      font-size: .82rem; transition: all .15s;
    }
    .group-add-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }
    /* Group pill on column header */
    .sec-group-pill {
      font-size: .65rem; padding: 1px 6px; border-radius: 10px;
      background: var(--hover); border: 1px solid var(--border);
      color: var(--text-muted); cursor: pointer;
      white-space: nowrap; transition: all .15s;
      position: relative; line-height: 1.6;
    }
    .sec-group-pill:hover { background: var(--accent); color: #fff; border-color: var(--accent); }
    .group-assign-menu {
      position: absolute; z-index: 300; top: calc(100% + 2px); left: 0;
      background: var(--card-bg); border: 1px solid var(--border);
      border-radius: 6px; box-shadow: 0 4px 16px rgba(0,0,0,.15);
      min-width: 140px; padding: 4px 0; font-size: .82rem;
    }
    .group-assign-menu button {
      display: block; width: 100%; text-align: left;
      padding: 5px 12px; background: none; border: none;
      cursor: pointer; color: var(--text);
    }
    .group-assign-menu button:hover { background: var(--hover); }
    .group-assign-menu button.active { font-weight: 600; color: var(--accent); }
    .group-assign-sep { height: 1px; background: var(--border); margin: 3px 0; }

  </style>
</head>
<body>

<header>
  <h1>Bozzone Tasks</h1>
  <div class="hdr-right">
    <button class="ur-btn" id="undoBtn" title="Undo (Ctrl+Z)" disabled>&#8617;</button>
    <button class="ur-btn" id="redoBtn" title="Redo (Ctrl+Y)" disabled>&#8618;</button>
    <div class="sync-dot" id="dot" title="Sync status"></div>
    <span class="key-label" id="keyLbl" title="Click to change sync key"></span>
    <button class="dark-toggle" id="darkToggle" title="Toggle dark mode">🌙</button>
    <button class="kbd-btn"  id="kbdBtn"  title="Keyboard shortcuts">⌨️</button>
    <button class="gear" id="gearBtn" title="Settings">&#9881;</button>
  </div>
</header>

<!-- Search bar -->
<div class="search-wrap">
  <span class="search-icon">🔍</span>
  <input type="text" id="searchInput" placeholder="Search tasks…" autocomplete="off">
  <button class="search-clear" id="searchClear" title="Clear search">&times;</button>
</div>

<div class="focus" id="focusDiv">
  <strong>FOCUS:</strong> <span id="focusText">YourStoryHomeDesign Social Marketing Plan &mdash; Community Connect News article (March)</span>
</div>

<div id="cfgNote"></div>

<div class="overall">
  <div class="overall-top">
    <span id="oLabel">Overall Progress</span>
    <span id="oPct">0%</span>
  </div>
  <div class="bar-wrap">
    <div class="bar" id="oBar" style="width:0%"></div>
  </div>
</div>

<div class="view-bar" id="viewBar"></div>
<div style="display:flex;align-items:center;gap:6px;padding:0 4px 6px;">
  <div class="filter-bar" id="filterBar" style="flex:1;margin-bottom:0;padding-bottom:0;border-bottom:none;"></div>
  <button class="hide-done-btn" id="hideDoneBtn" title="Toggle visibility of completed tasks">✓ Hide Done</button>
</div>

<div class="grid" id="board"></div>

<!-- Bulk action floating bar -->
<div class="bulk-bar" id="bulkBar">
  <span class="bulk-count" id="bulkCount">0 selected</span>
  <span class="bulk-sep"></span>
  <select class="bulk-move-sel" id="bulkMoveSel" title="Move to section"></select>
  <button class="bulk-action-btn" id="bulkMoveBtn">Move</button>
  <span class="bulk-sep"></span>
  <button class="bulk-action-btn" id="bulkHighBtn" title="Set High priority">🔴 High</button>
  <button class="bulk-action-btn" id="bulkMedBtn"  title="Set Medium priority">🟡 Med</button>
  <button class="bulk-action-btn" id="bulkDoneBtn" title="Mark done">✓ Done</button>
  <span class="bulk-sep"></span>
  <button class="bulk-action-btn danger" id="bulkDelBtn">🗑 Delete</button>
  <button class="bulk-cancel-btn" id="bulkCancelBtn" title="Exit bulk mode">&times;</button>
</div>

<!-- Keyboard shortcuts panel -->
<div class="kbd-panel" id="kbdPanel">
  <div class="kbd-panel-title">⌨️ Shortcuts</div>
  <div><kbd>N</kbd> New task</div>
  <div><kbd>/</kbd> Search</div>
  <div><kbd>D</kbd> Dark mode</div>
  <div><kbd>T</kbd> Templates</div>
  <div><kbd>B</kbd> Bulk select</div>
  <div><kbd>Ctrl</kbd><kbd>Z</kbd> Undo</div>
  <div><kbd>Ctrl</kbd><kbd>Y</kbd> Redo</div>
  <div><kbd>Esc</kbd> Close / cancel</div>
</div>

<!-- Undo toast -->
<div class="toast" id="toast">
  <span id="toastMsg"></span>
  <button class="toast-undo" id="toastUndo">UNDO</button>
</div>

<!-- Tag picker overlay -->
<div class="tp-ov" id="tpOv">
  <div class="tp-box" id="tpBox"></div>
</div>

<!-- Tag management overlay -->
<div class="tm-ov" id="tmOv">
  <div class="tm-box" id="tmBox"></div>
</div>

<!-- Hidden CSV file input -->
<input type="file" id="csvFileInput" accept=".csv" style="display:none">

<!-- CSV Import preview overlay -->
<div class="csv-ov" id="csvOv">
  <div class="csv-box" id="csvBox"></div>
</div>

<!-- New Task Modal -->
<div class="nt-ov" id="ntOv">
  <div class="nt-box">
    <h2>➕ Create New Task</h2>
    <div class="nt-field">
      <label>Title *</label>
      <input type="text" id="ntTitle" placeholder="What needs to be done?" autocomplete="off">
    </div>
    <div class="nt-field">
      <label>Description</label>
      <textarea id="ntDesc" placeholder="Optional details…"></textarea>
    </div>
    <div class="nt-row">
      <div class="nt-field">
        <label>Status</label>
        <select id="ntStatus">
          <option value="todo">To Do</option>
          <option value="inprogress">In Progress</option>
          <option value="done">Done</option>
        </select>
      </div>
      <div class="nt-field">
        <label>Priority</label>
        <select id="ntPriority">
          <option value="">— None —</option>
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
        </select>
      </div>
    </div>
    <div class="nt-row">
      <div class="nt-field">
        <label>Due Date</label>
        <input type="date" id="ntDueDate">
      </div>
      <div class="nt-field">
        <label>Section</label>
        <select id="ntSection"></select>
      </div>
    </div>
    <div class="nt-field">
      <label>Notes</label>
      <textarea id="ntNotes" placeholder="Additional context, links, references…" style="min-height:54px"></textarea>
    </div>
    <div class="nt-field">
      <label>Sub-tasks</label>
      <div class="nt-subtask-list" id="ntSubtaskList"></div>
      <div class="nt-subtask-add">
        <input type="text" id="ntSubInput" placeholder="Add a sub-task…">
        <button id="ntSubAdd">Add</button>
      </div>
    </div>
    <div class="nt-actions">
      <button class="nt-cancel" id="ntCancel">Cancel</button>
      <button class="nt-create" id="ntCreate">Create Task</button>
    </div>
  </div>
</div>

<!-- Task Templates Modal -->
<div class="tpl-ov" id="tplOv">
  <div class="tpl-box" id="tplBox"></div>
</div>

<!-- Sync-key overlay -->
<div class="ov" id="ov" style="display:none">
  <div class="ov-box">
    <h2>Sync Setup</h2>
    <p>Enter a sync key below. Use the <strong>same key on every device</strong> to keep tasks in sync.</p>
    <input type="text" id="keyIn" placeholder="e.g. bozzone42" autocomplete="off" autocapitalize="off" spellcheck="false">
    <button id="keyGo">Start Syncing</button>
  </div>
</div>

<script>
/* ================================================================
   FIREBASE CONFIG — Replace with YOUR values (see SETUP.md)
   ================================================================ */

var firebaseConfig = {
  apiKey: "AIzaSyCmZWuIQ6NzvS2Lhzo725Wf6Cnro6NKWzI",
  authDomain: "todomyway-185c9.firebaseapp.com",
  databaseURL: "https://todomyway-185c9-default-rtdb.firebaseio.com",
  projectId: "todomyway-185c9",
  storageBucket: "todomyway-185c9.firebasestorage.app",
  messagingSenderId: "213165358695",
  appId: "1:213165358695:web:f166a7cc6772f8a54a1ec2"
};

var configured = firebaseConfig.apiKey !== 'YOUR_API_KEY';

/* ================================================================
   CONSTANTS
   ================================================================ */
var TAG_COLORS = ['#4A90D9','#5CC1A9','#D97757','#9B59B6','#E74C3C','#F39C12','#1ABC9C','#34495E'];

var DEFAULT_TAGS = [
  { id: 'tag-work',     name: 'Work',     color: '#4A90D9' },
  { id: 'tag-shop',     name: 'Shop',     color: '#5CC1A9' },
  { id: 'tag-business', name: 'Business', color: '#D97757' }
];

var EMOJIS = ['\ud83d\udccb','\ud83c\udfaf','\ud83d\udcf1','\ud83d\uded2','\ud83d\udcfa','\ud83c\udfd7\ufe0f','\ud83d\udcb0','\ud83d\udd27','\u2b50','\ud83c\udfe0','\ud83d\ude97','\ud83d\udca1','\ud83c\udfa8','\ud83d\udcdd','\ud83d\udee0\ufe0f','\ud83d\udce6'];

/* ================================================================
   DEFAULT SECTIONS — used for first-time setup only.
   After first load, all data lives in Firebase.
   ================================================================ */
var SEED = [
  {
    title: "YourStory \u2014 Pre-Publication",
    icon: "\ud83c\udfaf",
    priority: true,
    tasks: [
      "Verify website contact form is working",
      "Update Google Business profile with fresh photos (before article drops)",
      "Ask Catherine Myers for exact publication date",
      "Confirm if article appears online \u2014 get URL when live",
      "Ask Catherine for permission to use article/excerpts on website and marketing"
    ]
  },
  {
    title: "YourStory \u2014 Post-Publication",
    icon: "\ud83c\udfaf",
    priority: true,
    tasks: [
      "Share article on Facebook page, Instagram, and local groups",
      "Save article as PDF and screenshot for future marketing",
      "Add 'as featured in Community Connect News' to website and bio",
      "Reach out to local interior designers as referral partners (use article as credibility)",
      "Prepare response script for incoming inquiries from article readers",
      "Launch Facebook Ads campaign (once first commission comes in)"
    ]
  },
  {
    title: "Social Marketing Foundation",
    icon: "\ud83d\udcf1",
    priority: false,
    tasks: [
      "Identify target audience demographics",
      "Plan content calendar around article launch",
      "Create brand voice and messaging guidelines"
    ]
  },
  {
    title: "MSS \u2014 Miter Saw Station",
    icon: "\ud83d\udee0\ufe0f",
    priority: false,
    tasks: [
      "Make saw platform with MDF and speed braces",
      "Install floating brackets",
      "Rip 1/2 inch plywood sheet",
      "Take photographs when complete"
    ]
  },
  {
    title: "Z$ Shopping List",
    icon: "\ud83d\uded2",
    priority: false,
    tasks: [
      "Grey paint",
      "1/8 inch hardboard"
    ]
  },
  {
    title: "Retooling for Retirement",
    icon: "\ud83d\udcfa",
    priority: false,
    tasks: [
      "Upper Cabs video",
      "Plan video content calendar",
      "Create first video (pick topic from deck)",
      "Reach out to sponsors: Harvey Tools, Bambu Lab, xTool"
    ]
  },
  {
    title: "Product Ideas and Designs",
    icon: "\ud83c\udfd7\ufe0f",
    priority: false,
    tasks: [
      "Furniture Designs",
      "Retro Game controller",
      "Novel functional nostalgia",
      "Rolling Packout shelf system"
    ]
  },
  {
    title: "Financial and Admin",
    icon: "\ud83d\udcb0",
    priority: false,
    tasks: [
      "Taxes \u2014 $5,106 estimated (need approx $2,426 more)",
      "Set up analog Kanban board to manage projects",
      "Sell tools on eBay"
    ]
  }
];

/* ================================================================
   STATE
   ================================================================ */
var appData      = { sections: [], tags: [] };
var syncKey      = localStorage.getItem('bozzone-sync-key');
var dbRef        = null;
var fbReady      = false;
var isDragging   = false;
var activeFilter = null;       /* null = All, or tag id */
var activeSearch = '';         /* search query string */
var activeView   = null;       /* null | 'overdue' | 'high' | 'inprogress' | 'week' */
var tpTarget     = null;       /* { secId, taskId } for tag picker */
var newTagColor  = TAG_COLORS[0];
var bulkSelected  = {};        /* taskId → true */
var bulkMode      = false;
var hideCompleted = false;     /* toggle: show/hide done tasks */
var collapsedSecs    = {};     /* secId → bool: collapsed column */
var collapsedGroups  = {};     /* groupId → bool: collapsed group */
var sectionSort      = {};     /* secId → 'manual'|'priority'|'due'|'alpha'|'created' */

/* ================================================================
   HELPERS
   ================================================================ */
function uid() {
  return 't' + Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
}

function dot(cls) {
  document.getElementById('dot').className = 'sync-dot ' + cls;
}

function findSec(id) {
  var secs = appData.sections || [];
  for (var i = 0; i < secs.length; i++) {
    if (secs[i].id === id) return secs[i];
  }
  return null;
}

function findTag(id) {
  var tags = appData.tags || [];
  for (var i = 0; i < tags.length; i++) {
    if (tags[i].id === id) return tags[i];
  }
  return null;
}

/* ── Group CRUD helpers ── */
function findGroup(id) {
  if (!id) return null;
  var groups = appData.groups || [];
  for (var i = 0; i < groups.length; i++) {
    if (groups[i].id === id) return groups[i];
  }
  return null;
}

function addGroup(name) {
  if (!appData.groups) appData.groups = [];
  var g = { id: uid(), name: (name || 'New Group').trim() };
  appData.groups.push(g);
  save();
  return g;
}

function deleteGroup(groupId) {
  if (!appData.groups) return;
  var idx = -1;
  for (var i = 0; i < appData.groups.length; i++) {
    if (appData.groups[i].id === groupId) { idx = i; break; }
  }
  if (idx === -1) return;
  appData.groups.splice(idx, 1);
  /* Unassign sections that belonged to this group */
  (appData.sections || []).forEach(function(sec) {
    if (sec.groupId === groupId) sec.groupId = null;
  });
  save();
}

function renameGroup(groupId, name) {
  var g = findGroup(groupId);
  if (g && name && name.trim()) { g.name = name.trim(); save(); }
}

function assignSectionToGroup(secId, groupId) {
  var sec = findSec(secId);
  if (sec) { sec.groupId = groupId || null; save(); }
}

/* Firebase can turn arrays into objects — normalize on read */
function ensureArrays(data) {
  if (!data) return { sections: [], tags: DEFAULT_TAGS.slice() };
  if (!data.sections) data.sections = [];
  if (!Array.isArray(data.sections)) data.sections = Object.values(data.sections);
  /* Seed default tags if tags never set */
  if (!data.tags) data.tags = DEFAULT_TAGS.map(function(t) { return {id:t.id, name:t.name, color:t.color}; });
  if (!Array.isArray(data.tags)) data.tags = Object.values(data.tags);
  /* Groups array */
  if (!data.groups) data.groups = [];
  if (!Array.isArray(data.groups)) data.groups = Object.values(data.groups);
  data.sections.forEach(function(sec) {
    if (sec.groupId === undefined) sec.groupId = null;
  });
  data.sections.forEach(function(sec) {
    if (!sec.tasks) sec.tasks = [];
    if (!Array.isArray(sec.tasks)) sec.tasks = Object.values(sec.tasks);
    sec.tasks.forEach(function(task) {
      if (!task.tags) task.tags = [];
      if (!Array.isArray(task.tags)) task.tags = Object.values(task.tags);
      /* ── New field migrations ── */
      if (!task.status)                   task.status   = task.done ? 'done' : 'todo';
      if (!task.subtasks)                 task.subtasks = [];
      if (!Array.isArray(task.subtasks))  task.subtasks = [];
      if (task.priority === undefined)    task.priority = null;
      if (task.dueDate  === undefined)    task.dueDate  = null;
      if (task.desc     === undefined)    task.desc     = '';
      if (task.notes    === undefined)    task.notes    = '';
    });
  });
  return data;
}

/* ================================================================
   DATA MODEL — build initial data from SEED + old checkbox states
   ================================================================ */
function buildInitialData(oldStates) {
  oldStates = oldStates || {};
  return {
    tags: DEFAULT_TAGS.map(function(t) { return {id:t.id, name:t.name, color:t.color}; }),
    sections: SEED.map(function(sec, si) {
      return {
        id: 'sec-' + si,
        title: sec.title,
        icon: sec.icon,
        priority: !!sec.priority,
        tasks: sec.tasks.map(function(text, ti) {
          var oldId = (sec.title + '-' + ti).toLowerCase().replace(/[^a-z0-9]+/g, '-').slice(0, 60);
          return { id: uid(), text: text, done: !!oldStates[oldId], tags: [] };
        })
      };
    })
  };
}

/* ================================================================
   FIREBASE
   ================================================================ */
function initFB() {
  if (!configured) {
    dot('off');
    document.getElementById('cfgNote').innerHTML =
      '<div class="cfg-banner"><h2>Firebase Not Configured</h2>' +
      '<p>The app works offline with local storage. To enable cross-device sync, ' +
      'add your Firebase config to <code>index.html</code> and redeploy. ' +
      'See <strong>SETUP.md</strong> for instructions.</p></div>';
    loadLS();
    if (!appData.sections.length) appData = buildInitialData();
    appData = ensureArrays(appData);
    render();
    return;
  }

  try {
    firebase.initializeApp(firebaseConfig);
    fbReady = true;
  } catch (e) {
    dot('off');
    loadLS();
    if (!appData.sections.length) appData = buildInitialData();
    appData = ensureArrays(appData);
    render();
    return;
  }

  if (syncKey) startSync();
}

function startSync() {
  if (!fbReady || !syncKey) return;
  dot('wait');

  dbRef = firebase.database().ref('dashboards/' + syncKey + '/v2');

  var firstLoad = true;
  dbRef.on('value', function(snap) {
    if (isDragging) return;
    if (snap.exists()) {
      appData = ensureArrays(snap.val());
      dot('on');
      render();
    } else if (firstLoad) {
      var oldRef = firebase.database().ref('dashboards/' + syncKey + '/tasks');
      oldRef.once('value', function(oldSnap) {
        appData = buildInitialData(oldSnap.val() || {});
        save();
      });
    }
    firstLoad = false;
  }, function() {
    dot('off');
  });

  firebase.database().ref('.info/connected').on('value', function(s) {
    dot(s.val() ? 'on' : 'off');
  });

  document.getElementById('keyLbl').textContent = syncKey;
}

function save() {
  saveLS();
  if (fbReady && dbRef) {
    dbRef.set(appData);
  } else {
    render();
  }
}

/* ================================================================
   LOCAL STORAGE (backup / offline fallback)
   ================================================================ */
function loadLS() {
  try {
    var s = localStorage.getItem('bozzone-app-v2');
    if (s) { appData = ensureArrays(JSON.parse(s)); return; }
    var old = localStorage.getItem('bozzone-states');
    if (old) appData = buildInitialData(JSON.parse(old));
  } catch (e) {}
}

function saveLS() {
  try { localStorage.setItem('bozzone-app-v2', JSON.stringify(appData)); } catch (e) {}
}

/* ================================================================
   TASK CRUD
   ================================================================ */
function addTask(secId, text) {
  var sec = findSec(secId);
  if (!sec) return;
  sec.tasks.push({ id: uid(), text: text.trim(), done: false, tags: [] });
  save();
}

function deleteTask(secId, taskId) {
  var sec = findSec(secId);
  if (!sec) return;
  var idx = -1;
  for (var i = 0; i < sec.tasks.length; i++) {
    if (sec.tasks[i].id === taskId) { idx = i; break; }
  }
  if (idx === -1) return;
  var removed = sec.tasks.splice(idx, 1)[0];
  var savedSecId = secId, savedIdx = idx;
  save();
  showToast('Task deleted', function() {
    var s = findSec(savedSecId);
    if (s) { s.tasks.splice(savedIdx, 0, removed); save(); }
  });
}

function toggleTask(secId, taskId) {
  var sec = findSec(secId);
  if (!sec) return;
  for (var i = 0; i < sec.tasks.length; i++) {
    if (sec.tasks[i].id === taskId) {
      sec.tasks[i].done = !sec.tasks[i].done;
      break;
    }
  }
  save();
}

/* ================================================================
   CYCLE STATUS (replaces toggleTask for the status button)
   ================================================================ */
function cycleStatus(secId, taskId) {
  var sec = findSec(secId);
  if (!sec) return;
  for (var i = 0; i < sec.tasks.length; i++) {
    if (sec.tasks[i].id === taskId) {
      var cur = sec.tasks[i].status || 'todo';
      var next = cur === 'todo' ? 'inprogress' : cur === 'inprogress' ? 'done' : 'todo';
      sec.tasks[i].status = next;
      sec.tasks[i].done   = (next === 'done');
      break;
    }
  }
  save();
}

/* ================================================================
   CREATE TASK (full data model)
   ================================================================ */
function createTask(secId, data) {
  var sec = findSec(secId);
  if (!sec) return;
  var status = data.status || 'todo';
  var task = {
    id:       uid(),
    text:     (data.text || '').trim(),
    desc:     (data.desc || '').trim(),
    notes:    (data.notes || '').trim(),
    status:   status,
    done:     status === 'done',
    priority: data.priority || null,
    dueDate:  data.dueDate  || null,
    subtasks: (data.subtasks || []).map(function(s) {
      return { id: uid(), text: s.text, done: false };
    }),
    tags: []
  };
  if (!task.text) return;
  sec.tasks.push(task);
  save();
  showToast('Task created');
}

/* ================================================================
   SUBTASK CRUD
   ================================================================ */
function toggleSubtask(secId, taskId, subId) {
  var sec = findSec(secId);
  if (!sec) return;
  var task = sec.tasks.filter(function(t) { return t.id === taskId; })[0];
  if (!task) return;
  var sub = (task.subtasks || []).filter(function(s) { return s.id === subId; })[0];
  if (sub) { sub.done = !sub.done; save(); }
}

function addSubtask(secId, taskId, text) {
  var sec = findSec(secId);
  if (!sec) return;
  var task = sec.tasks.filter(function(t) { return t.id === taskId; })[0];
  if (!task) return;
  if (!task.subtasks) task.subtasks = [];
  task.subtasks.push({ id: uid(), text: text.trim(), done: false });
  save();
}

function deleteSubtask(secId, taskId, subId) {
  var sec = findSec(secId);
  if (!sec) return;
  var task = sec.tasks.filter(function(t) { return t.id === taskId; })[0];
  if (!task || !task.subtasks) return;
  task.subtasks = task.subtasks.filter(function(s) { return s.id !== subId; });
  save();
}

/* ================================================================
   NEW TASK MODAL
   ================================================================ */
var ntPendingSubtasks = [];  /* subtasks built up in modal before save */

function showNewTaskModal(secId) {
  ntPendingSubtasks = [];
  /* Populate section select */
  var sel = document.getElementById('ntSection');
  sel.innerHTML = '';
  (appData.sections || []).forEach(function(s) {
    var opt = document.createElement('option');
    opt.value = s.id;
    opt.textContent = s.title;
    if (s.id === secId) opt.selected = true;
    sel.appendChild(opt);
  });
  /* Reset fields */
  document.getElementById('ntTitle').value    = '';
  document.getElementById('ntDesc').value     = '';
  document.getElementById('ntNotes').value    = '';
  document.getElementById('ntStatus').value   = 'todo';
  document.getElementById('ntPriority').value = '';
  document.getElementById('ntDueDate').value  = '';
  document.getElementById('ntSubInput').value = '';
  renderNtSubtasks();
  document.getElementById('ntOv').classList.add('show');
  document.getElementById('ntTitle').focus();
}

function hideNewTaskModal() {
  document.getElementById('ntOv').classList.remove('show');
}

function renderNtSubtasks() {
  var list = document.getElementById('ntSubtaskList');
  list.innerHTML = '';
  ntPendingSubtasks.forEach(function(s, idx) {
    var item = document.createElement('div');
    item.className = 'nt-subtask-item';
    var sp = document.createElement('span');
    sp.textContent = s.text;
    var del = document.createElement('button');
    del.className = 'nt-subtask-del';
    del.innerHTML = '&times;';
    (function(i) {
      del.addEventListener('click', function() {
        ntPendingSubtasks.splice(i, 1);
        renderNtSubtasks();
      });
    })(idx);
    item.appendChild(sp);
    item.appendChild(del);
    list.appendChild(item);
  });
}

function handleMove(fromSecId, toSecId, taskId, newIndex) {
  var fromSec = findSec(fromSecId);
  var toSec   = findSec(toSecId);
  if (!fromSec || !toSec) return;
  var taskIdx = -1;
  for (var i = 0; i < fromSec.tasks.length; i++) {
    if (fromSec.tasks[i].id === taskId) { taskIdx = i; break; }
  }
  if (taskIdx === -1) return;
  var task = fromSec.tasks.splice(taskIdx, 1)[0];
  toSec.tasks.splice(newIndex, 0, task);
  save();
}

/* ================================================================
   SECTION CRUD
   ================================================================ */
function addSection(title, icon) {
  appData.sections.push({
    id: uid(),
    title: title.trim(),
    icon: icon || '\ud83d\udccb',
    priority: false,
    tasks: []
  });
  save();
}

function deleteSection(secId) {
  var secs = appData.sections || [];
  var idx = -1;
  for (var i = 0; i < secs.length; i++) {
    if (secs[i].id === secId) { idx = i; break; }
  }
  if (idx === -1) return;
  var removed = secs.splice(idx, 1)[0];
  var savedIdx = idx;
  save();
  var msg = 'Column deleted' + (removed.tasks.length ? ' (' + removed.tasks.length + ' tasks)' : '');
  showToast(msg, function() {
    appData.sections.splice(savedIdx, 0, removed);
    save();
  });
}

function renameSection(secId, newTitle) {
  var sec = findSec(secId);
  if (!sec || !newTitle.trim()) return;
  sec.title = newTitle.trim();
  save();
}

/* ================================================================
   TAG CRUD
   ================================================================ */
function addTag(name, color) {
  if (!appData.tags) appData.tags = [];
  appData.tags.push({ id: uid(), name: name.trim(), color: color });
  save();
}

function deleteTag(tagId) {
  var tags = appData.tags || [];
  var idx = -1;
  for (var i = 0; i < tags.length; i++) {
    if (tags[i].id === tagId) { idx = i; break; }
  }
  if (idx === -1) return;
  tags.splice(idx, 1);
  /* Remove tag from all tasks */
  (appData.sections || []).forEach(function(sec) {
    (sec.tasks || []).forEach(function(task) {
      if (task.tags) {
        var ti = task.tags.indexOf(tagId);
        if (ti !== -1) task.tags.splice(ti, 1);
      }
    });
  });
  if (activeFilter === tagId) activeFilter = null;
  save();
}

function toggleTaskTag(secId, taskId, tagId) {
  var sec = findSec(secId);
  if (!sec) return;
  for (var i = 0; i < sec.tasks.length; i++) {
    if (sec.tasks[i].id === taskId) {
      var t = sec.tasks[i];
      if (!t.tags) t.tags = [];
      var ti = t.tags.indexOf(tagId);
      if (ti === -1) t.tags.push(tagId);
      else t.tags.splice(ti, 1);
      break;
    }
  }
  save();
}

/* ================================================================
   FILTER LOGIC
   ================================================================ */
function setFilter(tagId) {
  activeFilter = tagId;
  render();
}

function setSearch(text) {
  activeSearch = (text || '').trim().toLowerCase();
  render();
}

function getFilteredSections() {
  var secs = appData.sections || [];
  var needsFilter = activeFilter || activeSearch || activeView || hideCompleted;
  if (!needsFilter) return secs;

  /* Pre-compute date ranges for view filters */
  var today = new Date(); today.setHours(0,0,0,0);
  var weekEnd = new Date(today); weekEnd.setDate(weekEnd.getDate() + 7);

  return secs.map(function(sec) {
    var tasks = (sec.tasks || []).filter(function(t) {
      /* Hide completed */
      if (hideCompleted && (t.status === 'done' || t.done)) return false;
      /* Tag filter */
      if (activeFilter && !(t.tags && t.tags.indexOf(activeFilter) !== -1)) return false;
      /* Smart view filter */
      if (activeView) {
        if (activeView === 'overdue') {
          if (t.status === 'done' || !t.dueDate) return false;
          var d = new Date(t.dueDate + 'T00:00:00');
          if (d >= today) return false;
        } else if (activeView === 'high') {
          if (t.priority !== 'high') return false;
        } else if (activeView === 'inprogress') {
          if (t.status !== 'inprogress') return false;
        } else if (activeView === 'week') {
          if (t.status === 'done' || !t.dueDate) return false;
          var dw = new Date(t.dueDate + 'T00:00:00');
          if (dw < today || dw > weekEnd) return false;
        }
      }
      /* Search filter */
      if (activeSearch) {
        var q = activeSearch;
        var inTitle = (t.text || '').toLowerCase().indexOf(q) !== -1;
        var inDesc  = (t.desc || '').toLowerCase().indexOf(q) !== -1;
        var inNotes = (t.notes|| '').toLowerCase().indexOf(q) !== -1;
        var inSubs  = (t.subtasks || []).some(function(s) {
          return (s.text || '').toLowerCase().indexOf(q) !== -1;
        });
        if (!inTitle && !inDesc && !inNotes && !inSubs) return false;
      }
      return true;
    });
    return {
      id: sec.id,
      title: sec.title,
      icon: sec.icon,
      priority: sec.priority,
      groupId: sec.groupId,
      tasks: tasks
    };
  }).filter(function(sec) {
    return sec.tasks.length > 0;
  });
}

function getTagCounts() {
  var counts = {};
  var total = 0;
  (appData.sections || []).forEach(function(sec) {
    (sec.tasks || []).forEach(function(task) {
      total++;
      (task.tags || []).forEach(function(tid) {
        counts[tid] = (counts[tid] || 0) + 1;
      });
    });
  });
  counts._total = total;
  return counts;
}

/* ================================================================
   RENDER — SMART VIEW BAR
   ================================================================ */
function renderViewBar() {
  var bar = document.getElementById('viewBar');
  if (!bar) return;
  bar.innerHTML = '';

  var views = [
    { id: 'overdue',    label: '🔴 Overdue',    cls: 'vc-overdue'  },
    { id: 'high',       label: '⬆ High Pri',    cls: 'vc-high'     },
    { id: 'inprogress', label: '⏳ In Progress', cls: 'vc-progress' },
    { id: 'week',       label: '📅 My Week',     cls: 'vc-week'     }
  ];

  /* Count tasks per view for badge */
  var today = new Date(); today.setHours(0,0,0,0);
  var weekEnd = new Date(today); weekEnd.setDate(weekEnd.getDate() + 7);
  var vc = { overdue:0, high:0, inprogress:0, week:0 };
  (appData.sections || []).forEach(function(sec) {
    (sec.tasks || []).forEach(function(t) {
      if (t.status !== 'done') {
        if (t.dueDate) {
          var d = new Date(t.dueDate + 'T00:00:00');
          if (d < today)  vc.overdue++;
          if (d >= today && d <= weekEnd) vc.week++;
        }
        if (t.priority === 'high')      vc.high++;
        if (t.status === 'inprogress')  vc.inprogress++;
      }
    });
  });

  views.forEach(function(v) {
    if (vc[v.id] === 0 && activeView !== v.id) return; /* hide empty views unless active */
    var chip = document.createElement('button');
    chip.className = 'view-chip ' + v.cls + (activeView === v.id ? ' active' : '');
    chip.innerHTML = v.label + ' <span style="opacity:.7;font-size:.68rem">(' + vc[v.id] + ')</span>';
    (function(vid) {
      chip.addEventListener('click', function() {
        activeView = (activeView === vid) ? null : vid;
        render();
      });
    })(v.id);
    bar.appendChild(chip);
  });
}

/* ================================================================
   RENDER — FILTER BAR
   ================================================================ */
function renderFilterBar() {
  var bar = document.getElementById('filterBar');
  bar.innerHTML = '';
  var tags = appData.tags || [];
  var counts = getTagCounts();

  /* "All" button */
  var allBtn = document.createElement('button');
  allBtn.className = 'filter-btn' + (!activeFilter ? ' active' : '');
  allBtn.innerHTML = 'All <span class="filter-count">' + (counts._total || 0) + '</span>';
  allBtn.addEventListener('click', function() { setFilter(null); });
  bar.appendChild(allBtn);

  /* Tag buttons */
  tags.forEach(function(tag) {
    var btn = document.createElement('button');
    var isActive = activeFilter === tag.id;
    btn.className = 'filter-btn' + (isActive ? ' active' : '');
    if (isActive) {
      btn.style.background = tag.color;
      btn.style.borderColor = tag.color;
    }
    btn.innerHTML =
      '<span class="filter-dot" style="background:' + tag.color + '"></span>' +
      tag.name +
      ' <span class="filter-count">' + (counts[tag.id] || 0) + '</span>';
    (function(tid) {
      btn.addEventListener('click', function() { setFilter(tid); });
    })(tag.id);
    bar.appendChild(btn);
  });

  /* Manage tags button */
  var mgmt = document.createElement('button');
  mgmt.className = 'filter-manage-btn';
  mgmt.innerHTML = '&#9881;';
  mgmt.title = 'Manage tags';
  mgmt.addEventListener('click', function() { showTagMgmt(); });
  bar.appendChild(mgmt);
}

/* ================================================================
   GROUP HEADER — full-width row that spans the board grid
   ================================================================ */
function buildGroupHeader(g, count) {
  var hdr = document.createElement('div');
  hdr.className = 'group-header';
  hdr.dataset.groupId = g.id;

  /* Collapse toggle */
  var colBtn = document.createElement('button');
  colBtn.className = 'group-collapse-btn' + (collapsedGroups[g.id] ? ' collapsed' : '');
  colBtn.textContent = '\u25be';
  colBtn.title = collapsedGroups[g.id] ? 'Expand group' : 'Collapse group';
  (function(gid) {
    colBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      collapsedGroups[gid] = !collapsedGroups[gid];
      render();
    });
  })(g.id);

  /* Inline-editable name */
  var nameSpan = document.createElement('span');
  nameSpan.className = 'group-name';
  nameSpan.textContent = g.name;
  nameSpan.title = 'Double-click to rename';
  (function(gid) {
    nameSpan.addEventListener('dblclick', function() {
      var inp = document.createElement('input');
      inp.className = 'group-name-input';
      inp.value = g.name;
      hdr.replaceChild(inp, nameSpan);
      inp.focus(); inp.select();
      function commit() {
        var v = inp.value.trim();
        if (v) renameGroup(gid, v);
        else render();
      }
      inp.addEventListener('blur', commit);
      inp.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); inp.blur(); }
        if (e.key === 'Escape') { inp.removeEventListener('blur', commit); render(); }
      });
    });
  })(g.id);

  /* Count badge */
  var countSpan = document.createElement('span');
  countSpan.className = 'group-count';
  countSpan.textContent = '(' + count + ')';

  /* Delete button */
  var delBtn = document.createElement('button');
  delBtn.className = 'group-del';
  delBtn.textContent = '\u2715';
  delBtn.title = 'Delete group (columns stay, become ungrouped)';
  (function(gid, gname) {
    delBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      if (confirm('Delete group \u201c' + gname + '\u201d? Columns will become ungrouped.')) {
        deleteGroup(gid);
      }
    });
  })(g.id, g.name);

  hdr.appendChild(colBtn);
  hdr.appendChild(nameSpan);
  hdr.appendChild(countSpan);
  hdr.appendChild(delBtn);
  return hdr;
}

/* ================================================================
   RENDER — MAIN BOARD
   ================================================================ */
function render() {
  if (isDragging) return;

  renderViewBar();
  renderFilterBar();

  var board = document.getElementById('board');
  board.innerHTML = '';

  /* ── My Day virtual column ── */
  (function() {
    var mdTasks = [];
    (appData.sections || []).forEach(function(sec) {
      (sec.tasks || []).forEach(function(task) {
        if (!task.myDay) return;
        if (hideCompleted && (task.status === 'done' || task.done)) return;
        mdTasks.push({ task: task, secTitle: sec.title, secId: sec.id });
      });
    });

    var mdCard = document.createElement('div');
    mdCard.className = 'card my-day-col';
    mdCard.id = 'myDayCard';

    /* Header */
    var hd = document.createElement('div');
    hd.className = 'card-hd';
    var hdLeft = document.createElement('div');
    hdLeft.style.cssText = 'display:flex;align-items:center;gap:6px;min-width:0;flex:1;';
    var hdIcon = document.createElement('span');
    hdIcon.textContent = '☀️';
    hdIcon.style.cssText = 'font-size:1rem;flex-shrink:0;';
    var hdTitle = document.createElement('span');
    hdTitle.className = 'sec-title';
    hdTitle.textContent = 'My Day';
    var hdBadge = document.createElement('span');
    hdBadge.className = 'badge';
    hdBadge.textContent = '0/' + mdTasks.length;
    hdLeft.appendChild(hdIcon);
    hdLeft.appendChild(hdTitle);
    hdLeft.appendChild(hdBadge);
    hd.appendChild(hdLeft);
    mdCard.appendChild(hd);

    /* Body */
    var bd = document.createElement('div');
    bd.className = 'card-bd';

    if (mdTasks.length === 0) {
      var empty = document.createElement('div');
      empty.className = 'my-day-empty';
      empty.innerHTML = '☀️<br>No tasks for today<br><small>Click ☀️ on any task to add it here</small>';
      bd.appendChild(empty);
    } else {
      var tl = document.createElement('div');
      tl.className = 'task-list';
      mdTasks.forEach(function(item) {
        var task = item.task;
        var secId = item.secId;
        var status = task.status || (task.done ? 'done' : 'todo');

        var row = document.createElement('div');
        row.className = 'task status-' + status;
        row.dataset.taskId = task.id;
        row.dataset.sectionId = secId;

        /* Status button */
        var statusBtn = document.createElement('button');
        statusBtn.className = 'status-btn';
        statusBtn.dataset.status = status;
        statusBtn.title = 'Click to cycle status';
        statusBtn.innerHTML = status === 'done' ? '&#10003;' : status === 'inprogress' ? '&#9680;' : '';
        (function(sid, tid) {
          statusBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            cycleStatus(sid, tid);
          });
        })(secId, task.id);
        row.appendChild(statusBtn);

        /* Content */
        var content = document.createElement('div');
        content.className = 'task-content';

        var lb = document.createElement('label');
        lb.textContent = task.text;
        content.appendChild(lb);

        /* Due chip */
        if (task.dueDate) {
          var today2 = new Date(); today2.setHours(0,0,0,0);
          var due2 = new Date(task.dueDate + 'T00:00:00');
          var dChip = document.createElement('span');
          dChip.className = 'due-chip' + (due2 < today2 && status !== 'done' ? ' overdue' : due2.getTime() === today2.getTime() ? ' today' : '');
          dChip.textContent = '\uD83D\uDCC5 ' + task.dueDate.slice(5).replace('-', '/');
          content.appendChild(dChip);
        }

        /* Source section label */
        var src = document.createElement('span');
        src.className = 'my-day-source';
        src.textContent = '\u21b3 ' + item.secTitle;
        content.appendChild(src);

        row.appendChild(content);

        /* Remove from My Day button */
        var removeBtn = document.createElement('button');
        removeBtn.className = 'my-day-btn in-my-day tag-btn';
        removeBtn.title = 'Remove from My Day';
        removeBtn.textContent = '☀️';
        (function(sid, tid) {
          removeBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            var s2 = findSec(sid);
            if (s2) {
              var t2 = (s2.tasks || []).filter(function(t) { return t.id === tid; })[0];
              if (t2) { t2.myDay = false; save(); }
            }
          });
        })(secId, task.id);
        row.appendChild(removeBtn);

        tl.appendChild(row);
      });
      bd.appendChild(tl);
    }

    mdCard.appendChild(bd);
    board.appendChild(mdCard);
  })();

  var filteredSecs = getFilteredSections();
  var totalAll = 0, doneAll = 0;

  /* ── buildSectionCard: renders one column card, returns the DOM element ── */
  function buildSectionCard(filtSec) {
    var sec = filtSec;
    var tasks = sec.tasks || [];

    /* ── Per-column sort ── */
    var sortMode = sectionSort[sec.id] || 'manual';
    if (sortMode !== 'manual') {
      var priOrder = { high: 0, medium: 1, low: 2 };
      tasks = tasks.slice().sort(function(a, b) {
        if (sortMode === 'priority') {
          return (priOrder[a.priority] !== undefined ? priOrder[a.priority] : 3) -
                 (priOrder[b.priority] !== undefined ? priOrder[b.priority] : 3);
        }
        if (sortMode === 'due') {
          var da = a.dueDate ? new Date(a.dueDate + 'T00:00:00').getTime() : Infinity;
          var db = b.dueDate ? new Date(b.dueDate + 'T00:00:00').getTime() : Infinity;
          return da - db;
        }
        if (sortMode === 'alpha') {
          return (a.text || '').toLowerCase().localeCompare((b.text || '').toLowerCase());
        }
        if (sortMode === 'created') {
          return (a.id || '').localeCompare(b.id || '');
        }
        if (sortMode === 'myday') {
          return (b.myDay ? 1 : 0) - (a.myDay ? 1 : 0);
        }
        return 0;
      });
    }

    var done = 0;
    tasks.forEach(function(t) { if (t.done) done++; });
    totalAll += tasks.length;
    doneAll  += done;
    var pct = tasks.length ? Math.round(done / tasks.length * 100) : 0;

    /* ── Card ── */
    var card = document.createElement('div');
    card.className = 'card' + (sec.priority ? ' priority' : '');

    /* ── Header ── */
    var hd = document.createElement('div');
    hd.className = 'card-hd';

    /* Collapse button */
    var collapseBtn = document.createElement('button');
    collapseBtn.className = 'sec-collapse-btn';
    collapseBtn.innerHTML = '&#9660;';
    collapseBtn.title = 'Collapse/expand column';
    if (collapsedSecs[sec.id]) collapseBtn.style.transform = 'rotate(-90deg)';
    (function(sid, cardEl) {
      collapseBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        collapsedSecs[sid] = !collapsedSecs[sid];
        cardEl.classList.toggle('sec-collapsed', !!collapsedSecs[sid]);
        collapseBtn.style.transform = collapsedSecs[sid] ? 'rotate(-90deg)' : '';
      });
    })(sec.id, card);
    hd.appendChild(collapseBtn);

    /* Icon button (editable) */
    var iconBtn = document.createElement('button');
    iconBtn.className = 'sec-icon-btn';
    iconBtn.textContent = sec.icon || '📋';
    iconBtn.title = 'Click to change icon/emoji';
    (function(secId, currentIcon) {
      iconBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        var iconInp = document.createElement('input');
        iconInp.type = 'text';
        iconInp.className = 'sec-icon-input';
        iconInp.value = currentIcon;
        iconInp.maxLength = 4;
        iconBtn.style.display = 'none';
        hd.insertBefore(iconInp, iconBtn.nextSibling);
        iconInp.focus(); iconInp.select();
        function commitIcon() {
          var v = iconInp.value.trim();
          if (v !== currentIcon) {
            var s2 = findSec(secId);
            if (s2) { s2.icon = v; save(); } else { iconInp.remove(); iconBtn.style.display = ''; }
          } else { iconInp.remove(); iconBtn.style.display = ''; }
        }
        iconInp.addEventListener('blur', commitIcon);
        iconInp.addEventListener('keydown', function(e2) {
          if (e2.key === 'Enter') { e2.preventDefault(); iconInp.blur(); }
          if (e2.key === 'Escape') {
            iconInp.removeEventListener('blur', commitIcon);
            iconInp.remove(); iconBtn.style.display = '';
          }
        });
      });
    })(sec.id, sec.icon || '');
    hd.appendChild(iconBtn);

    /* Editable title */
    var titleSpan = document.createElement('span');
    titleSpan.className = 'sec-title';
    titleSpan.textContent = sec.title;
    (function(secId, currentTitle) {
      titleSpan.addEventListener('click', function() {
        var input = document.createElement('input');
        input.type = 'text';
        input.className = 'sec-title-input';
        input.value = currentTitle;
        titleSpan.style.display = 'none';
        hd.insertBefore(input, titleSpan.nextSibling);
        input.focus(); input.select();
        function commitEdit() {
          var val = input.value.trim();
          if (val && val !== currentTitle) { renameSection(secId, val); }
          else { input.remove(); titleSpan.style.display = ''; }
        }
        input.addEventListener('blur', commitEdit);
        input.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
          if (e.key === 'Escape') {
            input.removeEventListener('blur', commitEdit);
            input.remove(); titleSpan.style.display = '';
          }
        });
      });
    })(sec.id, sec.title);
    hd.appendChild(titleSpan);

    /* Actions: sort + badge + delete */
    var actions = document.createElement('span');
    actions.className = 'sec-actions';
    actions.style.position = 'relative';

    /* Sort button */
    var currentSort = sectionSort[sec.id] || 'manual';
    var sortBtnEl = document.createElement('button');
    sortBtnEl.className = 'sec-sort-btn' + (currentSort !== 'manual' ? ' sorted' : '');
    sortBtnEl.title = 'Sort tasks in this column';
    var sortIcons = { manual: '⇅', priority: '⬆', due: '📅', alpha: 'Az', created: '🕐', myday: '☀️' };
    sortBtnEl.textContent = sortIcons[currentSort] || '⇅';
    (function(sid, sBtn) {
      sBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        document.querySelectorAll('.sort-menu').forEach(function(m) { m.remove(); });
        var menu = document.createElement('div');
        menu.className = 'sort-menu';
        [
          { val: 'manual',   label: '⇅ Manual (drag)' },
          { val: 'priority', label: '⬆ Priority' },
          { val: 'due',      label: '📅 Due Date' },
          { val: 'alpha',    label: 'Az Title A→Z' },
          { val: 'created',  label: '🕐 Date Added' },
          { val: 'myday',    label: '☀️ My Day First' }
        ].forEach(function(o) {
          var b = document.createElement('button');
          b.textContent = o.label;
          if ((sectionSort[sid] || 'manual') === o.val) b.classList.add('active');
          b.addEventListener('click', function(e2) {
            e2.stopPropagation();
            sectionSort[sid] = o.val;
            menu.remove();
            render();
          });
          menu.appendChild(b);
        });
        actions.appendChild(menu);
        setTimeout(function() {
          document.addEventListener('click', function closer() {
            menu.remove();
            document.removeEventListener('click', closer);
          });
        }, 0);
      });
    })(sec.id, sortBtnEl);
    actions.appendChild(sortBtnEl);

    var badge = document.createElement('span');
    badge.className = 'badge';
    badge.textContent = done + '/' + tasks.length;
    actions.appendChild(badge);

    var delBtn = document.createElement('button');
    delBtn.className = 'sec-del';
    delBtn.innerHTML = '&times;';
    delBtn.title = 'Delete column';
    (function(sid) {
      delBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        deleteSection(sid);
      });
    })(sec.id);
    actions.appendChild(delBtn);

    hd.appendChild(actions);

    /* Group pill — only shown when at least one group exists */
    if ((appData.groups || []).length > 0) {
      var grpPill = document.createElement('button');
      grpPill.className = 'sec-group-pill';
      var curGrp = sec.groupId ? findGroup(sec.groupId) : null;
      grpPill.textContent = curGrp ? curGrp.name : 'Group\u2026';
      (function(sid, currentGroupId) {
        grpPill.addEventListener('click', function(e) {
          e.stopPropagation();
          document.querySelectorAll('.group-assign-menu').forEach(function(m) { m.remove(); });
          var menu = document.createElement('div');
          menu.className = 'group-assign-menu';
          /* None */
          var noneBtn = document.createElement('button');
          noneBtn.textContent = '\u2014 None \u2014';
          if (!currentGroupId) noneBtn.classList.add('active');
          noneBtn.addEventListener('click', function(e2) { e2.stopPropagation(); assignSectionToGroup(sid, null); menu.remove(); });
          menu.appendChild(noneBtn);
          var sep1 = document.createElement('div'); sep1.className = 'group-assign-sep'; menu.appendChild(sep1);
          /* Existing groups */
          (appData.groups || []).forEach(function(g) {
            var gb = document.createElement('button');
            gb.textContent = g.name;
            if (currentGroupId === g.id) gb.classList.add('active');
            gb.addEventListener('click', function(e2) { e2.stopPropagation(); assignSectionToGroup(sid, g.id); menu.remove(); });
            menu.appendChild(gb);
          });
          var sep2 = document.createElement('div'); sep2.className = 'group-assign-sep'; menu.appendChild(sep2);
          /* New Group */
          var newGrpBtn = document.createElement('button');
          newGrpBtn.textContent = '+ New Group\u2026';
          newGrpBtn.addEventListener('click', function(e2) {
            e2.stopPropagation();
            var gname = prompt('New group name:');
            if (gname && gname.trim()) {
              var g2 = addGroup(gname.trim());
              assignSectionToGroup(sid, g2.id);
            }
            menu.remove();
          });
          menu.appendChild(newGrpBtn);
          grpPill.appendChild(menu);
          setTimeout(function() {
            document.addEventListener('click', function closer() {
              menu.remove();
              document.removeEventListener('click', closer);
            });
          }, 0);
        });
      })(sec.id, sec.groupId);
      hd.appendChild(grpPill);
    }

    card.appendChild(hd);
    if (collapsedSecs[sec.id]) card.classList.add('sec-collapsed');

    /* ── Body ── */
    var bd = document.createElement('div');
    bd.className = 'card-bd';

    /* Progress */
    var pw = document.createElement('div'); pw.className = 'prog-wrap';
    var pb = document.createElement('div'); pb.className = 'prog'; pb.style.width = pct + '%';
    pw.appendChild(pb); bd.appendChild(pw);
    var pl = document.createElement('div'); pl.className = 'prog-lbl';
    pl.textContent = pct + '% complete';
    bd.appendChild(pl);

    /* Task list */
    var tl = document.createElement('div');
    tl.className = 'task-list';
    tl.dataset.sectionId = sec.id;

    if (!tasks.length) {
      var em = document.createElement('div');
      em.className = 'task-empty';
      em.textContent = activeFilter ? 'No matching tasks' : 'No tasks \u2014 add one below';
      tl.appendChild(em);
    }

    tasks.forEach(function(task) {
      var status = task.status || (task.done ? 'done' : 'todo');

      /* Overdue urgency check */
      var isOverdueUrgent = false;
      if (task.dueDate && status !== 'done') {
        var todayCheck = new Date(); todayCheck.setHours(0,0,0,0);
        var dueCheck = new Date(task.dueDate + 'T00:00:00');
        if (dueCheck < todayCheck) isOverdueUrgent = true;
      }

      var row = document.createElement('div');
      row.className = 'task status-' + status + (isOverdueUrgent ? ' overdue-urgent' : '');
      row.dataset.taskId    = task.id;
      row.dataset.sectionId = sec.id;
      if (task.priority) row.dataset.priority = task.priority;

      /* Bulk-select checkbox */
      var selCb = document.createElement('input');
      selCb.type = 'checkbox';
      selCb.className = 'task-select-cb';
      if (bulkSelected[task.id]) { selCb.checked = true; row.classList.add('bulk-selected'); }
      (function(tid, r, cb) {
        cb.addEventListener('change', function() {
          if (cb.checked) { bulkSelected[tid] = true; r.classList.add('bulk-selected'); }
          else            { delete bulkSelected[tid]; r.classList.remove('bulk-selected'); }
          updateBulkBar();
        });
      })(task.id, row, selCb);
      row.appendChild(selCb);

      /* Drag handle */
      var grip = document.createElement('span');
      grip.className = 'drag-handle';
      grip.innerHTML = '&#9776;';
      row.appendChild(grip);

      /* Status button (3-state, replaces checkbox) */
      var statusBtn = document.createElement('button');
      statusBtn.className = 'status-btn';
      statusBtn.dataset.status = status;
      statusBtn.title = 'Click to cycle status';
      statusBtn.innerHTML = status === 'done' ? '&#10003;' : status === 'inprogress' ? '&#9680;' : '';
      (function(sid, tid) {
        statusBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          cycleStatus(sid, tid);
        });
      })(sec.id, task.id);
      row.appendChild(statusBtn);

      /* Content wrapper */
      var content = document.createElement('div');
      content.className = 'task-content';

      var lb = document.createElement('label');
      lb.textContent = task.text;
      lb.title = 'Double-click to edit';
      (function(sid, tid, lbl) {
        lbl.addEventListener('dblclick', function(e) {
          e.stopPropagation();
          var inp = document.createElement('input');
          inp.type = 'text';
          inp.className = 'task-edit-input';
          inp.value = lbl.textContent;
          lbl.style.display = 'none';
          content.insertBefore(inp, lbl.nextSibling);
          inp.focus(); inp.select();
          function commitTask() {
            var v = inp.value.trim();
            if (v && v !== lbl.textContent) {
              var s2 = findSec(sid);
              if (s2) {
                var t2 = (s2.tasks || []).filter(function(t) { return t.id === tid; })[0];
                if (t2) { t2.text = v; save(); return; }
              }
            }
            inp.remove(); lbl.style.display = '';
          }
          inp.addEventListener('blur', commitTask);
          inp.addEventListener('keydown', function(e2) {
            if (e2.key === 'Enter') { e2.preventDefault(); inp.blur(); }
            if (e2.key === 'Escape') {
              inp.removeEventListener('blur', commitTask);
              inp.remove(); lbl.style.display = '';
            }
          });
        });
      })(sec.id, task.id, lb);
      content.appendChild(lb);

      /* Due date chip */
      if (task.dueDate) {
        var today = new Date(); today.setHours(0,0,0,0);
        var due   = new Date(task.dueDate + 'T00:00:00');
        var chip  = document.createElement('span');
        chip.className = 'due-chip';
        var diff = due - today;
        if (diff < 0)      chip.className += ' overdue';
        else if (diff === 0) chip.className += ' today';
        var mo = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        chip.textContent = '\ud83d\udcc5 ' + mo[due.getMonth()] + ' ' + due.getDate();
        content.appendChild(chip);
      }

      /* Tag badges */
      var taskTags = task.tags || [];
      if (taskTags.length) {
        var badges = document.createElement('div');
        badges.className = 'tag-badges';
        taskTags.forEach(function(tid) {
          var tag = findTag(tid);
          if (tag) {
            var b = document.createElement('span');
            b.className = 'tag-badge';
            b.style.background = tag.color;
            b.textContent = tag.name;
            badges.appendChild(b);
          }
        });
        content.appendChild(badges);
      }

      /* Notes */
      if (task.notes && task.notes.trim()) {
        var notesToggle = document.createElement('span');
        notesToggle.className = 'notes-toggle';
        notesToggle.textContent = '📝 Notes';
        var notesDiv = document.createElement('div');
        notesDiv.className = 'task-notes';
        notesDiv.textContent = task.notes;
        notesToggle.addEventListener('click', function(e) {
          e.stopPropagation();
          var open = notesDiv.classList.toggle('visible');
          notesToggle.textContent = open ? '📝 Notes ▴' : '📝 Notes';
        });
        content.appendChild(notesToggle);
        content.appendChild(notesDiv);
      }

      /* Subtask summary + list */
      var subs = task.subtasks || [];
      if (subs.length > 0) {
        var doneSubs = subs.filter(function(s) { return s.done; }).length;
        var summary  = document.createElement('span');
        summary.className = 'subtask-summary';
        summary.textContent = '\u25b8 ' + doneSubs + '/' + subs.length + ' subtasks';

        var subList = document.createElement('div');
        subList.className = 'subtask-list';

        subs.forEach(function(sub) {
          var si = document.createElement('div');
          si.className = 'subtask-item' + (sub.done ? ' done' : '');

          var scb = document.createElement('input');
          scb.type = 'checkbox';
          scb.checked = sub.done;
          (function(sid, tid, subid) {
            scb.addEventListener('change', function() { toggleSubtask(sid, tid, subid); });
          })(sec.id, task.id, sub.id);

          var slb = document.createElement('label');
          slb.textContent = sub.text;
          slb.title = 'Double-click to edit';
          (function(sid2, tid2, subid2, slabel) {
            slabel.addEventListener('dblclick', function(e) {
              e.stopPropagation();
              var sinp = document.createElement('input');
              sinp.type = 'text';
              sinp.className = 'subtask-edit-input';
              sinp.value = slabel.textContent;
              slabel.style.display = 'none';
              si.insertBefore(sinp, slabel.nextSibling);
              sinp.focus(); sinp.select();
              function commitSub() {
                var v = sinp.value.trim();
                if (v && v !== slabel.textContent) {
                  var s2 = findSec(sid2);
                  if (s2) {
                    var t2 = (s2.tasks||[]).filter(function(t){return t.id===tid2;})[0];
                    if (t2) {
                      var sub2 = (t2.subtasks||[]).filter(function(s){return s.id===subid2;})[0];
                      if (sub2) { sub2.text = v; save(); return; }
                    }
                  }
                }
                sinp.remove(); slabel.style.display = '';
              }
              sinp.addEventListener('blur', commitSub);
              sinp.addEventListener('keydown', function(e2) {
                if (e2.key === 'Enter') { e2.preventDefault(); sinp.blur(); }
                if (e2.key === 'Escape') {
                  sinp.removeEventListener('blur', commitSub);
                  sinp.remove(); slabel.style.display = '';
                }
              });
            });
          })(sec.id, task.id, sub.id, slb);

          var sdel = document.createElement('button');
          sdel.className = 'subtask-del';
          sdel.innerHTML = '&times;';
          (function(sid, tid, subid) {
            sdel.addEventListener('click', function(e) {
              e.stopPropagation();
              deleteSubtask(sid, tid, subid);
            });
          })(sec.id, task.id, sub.id);

          si.appendChild(scb);
          si.appendChild(slb);
          si.appendChild(sdel);
          subList.appendChild(si);
        });

        /* Inline add-subtask row inside the expanded list */
        var subAddRow = document.createElement('div');
        subAddRow.className = 'subtask-add-row';
        var subInp = document.createElement('input');
        subInp.type = 'text';
        subInp.className = 'subtask-add-input';
        subInp.placeholder = 'Add sub-task\u2026';
        var subAddBtn = document.createElement('button');
        subAddBtn.className = 'subtask-add-btn';
        subAddBtn.textContent = '+';
        (function(sid, tid, inp) {
          function doAddSub() {
            var v = inp.value.trim();
            if (v) { addSubtask(sid, tid, v); inp.value = ''; }
          }
          subAddBtn.addEventListener('click', doAddSub);
          inp.addEventListener('keydown', function(e) { if (e.key === 'Enter') doAddSub(); });
        })(sec.id, task.id, subInp);
        subAddRow.appendChild(subInp);
        subAddRow.appendChild(subAddBtn);
        subList.appendChild(subAddRow);

        /* Toggle expand on summary click */
        summary.addEventListener('click', function(e) {
          e.stopPropagation();
          var open = subList.classList.toggle('open');
          summary.textContent = (open ? '\u25be ' : '\u25b8 ') + doneSubs + '/' + subs.length + ' subtasks';
        });

        content.appendChild(summary);
        content.appendChild(subList);
      }

      row.appendChild(content);

      /* Action buttons */
      var actionsDiv = document.createElement('div');
      actionsDiv.className = 'task-actions';

      /* My Day toggle button */
      var myDayBtn = document.createElement('button');
      myDayBtn.className = 'my-day-btn' + (task.myDay ? ' in-my-day' : '');
      myDayBtn.title = task.myDay ? 'Remove from My Day' : 'Add to My Day';
      myDayBtn.textContent = '☀️';
      (function(sid, tid) {
        myDayBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          var s2 = findSec(sid);
          if (s2) {
            var t2 = (s2.tasks || []).filter(function(t) { return t.id === tid; })[0];
            if (t2) { t2.myDay = !t2.myDay; save(); }
          }
        });
      })(sec.id, task.id);
      actionsDiv.appendChild(myDayBtn);

      /* Save as template button */
      var tplBtn = document.createElement('button');
      tplBtn.className = 'tag-btn';
      tplBtn.innerHTML = '📋';
      tplBtn.title = 'Save as template';
      (function(t) {
        tplBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          saveTaskAsTemplate(t);
        });
      })(task);
      actionsDiv.appendChild(tplBtn);

      /* Tag toggle button */
      var tagBtn = document.createElement('button');
      tagBtn.className = 'tag-btn';
      tagBtn.innerHTML = '\ud83c\udff7\ufe0f';
      tagBtn.title = 'Tags';
      (function(sid, tid) {
        tagBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          showTagPicker(sid, tid);
        });
      })(sec.id, task.id);
      actionsDiv.appendChild(tagBtn);

      /* Delete button */
      var del = document.createElement('button');
      del.className = 'del-btn';
      del.innerHTML = '&times;';
      del.title = 'Delete task';
      (function(sid, tid) {
        del.addEventListener('click', function(e) {
          e.stopPropagation();
          deleteTask(sid, tid);
        });
      })(sec.id, task.id);
      actionsDiv.appendChild(del);

      row.appendChild(actionsDiv);
      tl.appendChild(row);
    });

    bd.appendChild(tl);

    /* ── + New Task button (replaces old add-row) ── */
    var ar = document.createElement('div');
    ar.className = 'add-task-row';
    var ntBtn = document.createElement('button');
    ntBtn.className = 'add-task-btn';
    ntBtn.innerHTML = '+ New Task';
    (function(sid) {
      ntBtn.addEventListener('click', function() { showNewTaskModal(sid); });
    })(sec.id);
    ar.appendChild(ntBtn);
    bd.appendChild(ar);

    card.appendChild(bd);
    return card;
  } /* end buildSectionCard */

  /* ── Grouped rendering loop ── */
  var groupedSections = {};   /* groupId → [filtSec, ...] */
  var ungrouped = [];
  filteredSecs.forEach(function(fs) {
    if (fs.groupId && findGroup(fs.groupId)) {
      if (!groupedSections[fs.groupId]) groupedSections[fs.groupId] = [];
      groupedSections[fs.groupId].push(fs);
    } else {
      ungrouped.push(fs);
    }
  });

  /* Named groups first (in appData.groups order) */
  (appData.groups || []).forEach(function(g) {
    var members = groupedSections[g.id] || [];
    board.appendChild(buildGroupHeader(g, members.length));
    if (!collapsedGroups[g.id]) {
      members.forEach(function(fs) { board.appendChild(buildSectionCard(fs)); });
    }
  });

  /* Ungrouped sections below */
  ungrouped.forEach(function(fs) { board.appendChild(buildSectionCard(fs)); });

  /* ── Add Group button ── */
  var addGrpBtn = document.createElement('button');
  addGrpBtn.className = 'group-add-btn';
  addGrpBtn.textContent = '\u002b Add Group';
  addGrpBtn.addEventListener('click', function() {
    var gname = prompt('Group name:');
    if (gname && gname.trim()) { addGroup(gname.trim()); }
  });
  board.appendChild(addGrpBtn);

  /* ── Add Column Card ── */
  var addCard = document.createElement('div');
  addCard.className = 'add-col-card';
  addCard.id = 'addColCard';
  addCard.innerHTML =
    '<div class="add-col-icon">+</div>' +
    '<div class="add-col-label">Add Column</div>';
  addCard.addEventListener('click', function() { expandAddCol(addCard); });
  board.appendChild(addCard);

  /* ── Templates Card ── */
  var tplCard = document.createElement('div');
  tplCard.className = 'add-col-card';
  tplCard.innerHTML =
    '<div class="add-col-icon" style="font-size:1.6rem">📋</div>' +
    '<div class="add-col-label">Templates</div>';
  tplCard.addEventListener('click', function() {
    var fs = (appData.sections || [])[0];
    showTemplateModal(fs ? fs.id : null);
  });
  board.appendChild(tplCard);

  /* ── Import CSV Card ── */
  var importCard = document.createElement('div');
  importCard.className = 'add-col-card';
  importCard.innerHTML =
    '<div class="add-col-icon" style="font-size:1.6rem">\ud83d\udce5</div>' +
    '<div class="add-col-label">Import CSV</div>';
  importCard.addEventListener('click', function() {
    document.getElementById('csvFileInput').value = '';
    document.getElementById('csvFileInput').click();
  });
  board.appendChild(importCard);

  /* ── Bulk Select Card ── */
  var bulkCard = document.createElement('div');
  bulkCard.className = 'add-col-card';
  bulkCard.innerHTML =
    '<div class="add-col-icon" style="font-size:1.6rem">☑️</div>' +
    '<div class="add-col-label">' + (bulkMode ? 'Exit Bulk' : 'Bulk Select') + '</div>';
  bulkCard.addEventListener('click', function() {
    if (bulkMode) exitBulkMode();
    else          enterBulkMode();
  });
  board.appendChild(bulkCard);

  /* ── Download CSV Card ── */
  var dlCard = document.createElement('div');
  dlCard.className = 'add-col-card';
  dlCard.innerHTML =
    '<div class="add-col-icon" style="font-size:1.6rem">\ud83d\udcc4</div>' +
    '<div class="add-col-label">Download CSV</div>';
  dlCard.addEventListener('click', exportCSV);
  board.appendChild(dlCard);

  /* Overall progress */
  var op = totalAll ? Math.round(doneAll / totalAll * 100) : 0;
  var filterTag = activeFilter ? findTag(activeFilter) : null;
  document.getElementById('oLabel').textContent =
    filterTag ? (filterTag.name + ' Progress') : 'Overall Progress';
  document.getElementById('oPct').textContent = doneAll + '/' + totalAll + ' (' + op + '%)';
  document.getElementById('oBar').style.width  = op + '%';

  initSortables();
}

/* ================================================================
   ADD COLUMN — expand card into form
   ================================================================ */
var selectedEmoji = '\ud83d\udccb';

function expandAddCol(card) {
  if (card.classList.contains('expanded')) return;
  card.classList.add('expanded');
  card.removeEventListener('click', arguments.callee);
  selectedEmoji = '\ud83d\udccb';

  card.innerHTML =
    '<div class="add-col-form">' +
      '<input type="text" id="newColName" placeholder="Column name\u2026" autofocus>' +
      '<label>Icon</label>' +
      '<div class="emoji-row" id="emojiRow"></div>' +
      '<div class="add-col-btns">' +
        '<button class="btn-cancel" id="colCancelBtn">Cancel</button>' +
        '<button class="btn-create" id="colCreateBtn">Create</button>' +
      '</div>' +
    '</div>';

  var row = document.getElementById('emojiRow');
  EMOJIS.forEach(function(em) {
    var btn = document.createElement('button');
    btn.className = 'emoji-pick' + (em === selectedEmoji ? ' sel' : '');
    btn.textContent = em;
    btn.type = 'button';
    btn.addEventListener('click', function() {
      row.querySelectorAll('.emoji-pick').forEach(function(b) { b.classList.remove('sel'); });
      btn.classList.add('sel');
      selectedEmoji = em;
    });
    row.appendChild(btn);
  });

  var nameInput = document.getElementById('newColName');
  nameInput.focus();

  document.getElementById('colCreateBtn').addEventListener('click', function() {
    var name = nameInput.value.trim();
    if (name) { addSection(name, selectedEmoji); }
  });
  document.getElementById('colCancelBtn').addEventListener('click', function() {
    render();
  });
  nameInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      var name = nameInput.value.trim();
      if (name) addSection(name, selectedEmoji);
    }
    if (e.key === 'Escape') render();
  });
}

/* ================================================================
   TAG PICKER
   ================================================================ */
function showTagPicker(secId, taskId) {
  tpTarget = { secId: secId, taskId: taskId };
  renderTagPicker();
  document.getElementById('tpOv').classList.add('show');
}

function hideTagPicker() {
  document.getElementById('tpOv').classList.remove('show');
  tpTarget = null;
}

function renderTagPicker() {
  if (!tpTarget) return;
  var sec = findSec(tpTarget.secId);
  if (!sec) return;
  var task = null;
  for (var i = 0; i < sec.tasks.length; i++) {
    if (sec.tasks[i].id === tpTarget.taskId) { task = sec.tasks[i]; break; }
  }
  if (!task) return;

  var box = document.getElementById('tpBox');
  var tags = appData.tags || [];
  var taskTags = task.tags || [];
  var html = '<div class="tp-title">Tags for: ' + escHtml(task.text.slice(0, 40)) + (task.text.length > 40 ? '\u2026' : '') + '</div>';

  if (!tags.length) {
    html += '<div class="tp-empty">No tags yet. Create tags from the filter bar.</div>';
  } else {
    tags.forEach(function(tag) {
      var checked = taskTags.indexOf(tag.id) !== -1;
      html +=
        '<div class="tp-item" data-tag-id="' + tag.id + '">' +
          '<span class="tp-dot" style="background:' + tag.color + '"></span>' +
          '<span class="tp-name">' + escHtml(tag.name) + '</span>' +
          (checked ? '<span class="tp-check">\u2713</span>' : '') +
        '</div>';
    });
  }

  box.innerHTML = html;

  /* Attach click handlers */
  box.querySelectorAll('.tp-item').forEach(function(el) {
    el.addEventListener('click', function() {
      var tid = el.dataset.tagId;
      toggleTaskTag(tpTarget.secId, tpTarget.taskId, tid);
      /* Re-render picker to update checkmarks (save triggers full render, picker stays open) */
      setTimeout(function() { renderTagPicker(); }, 50);
    });
  });
}

/* Close tag picker on overlay click */
document.getElementById('tpOv').addEventListener('click', function(e) {
  if (e.target === this) hideTagPicker();
});

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* ================================================================
   CSV IMPORT
   ================================================================ */
function parseCSV(text) {
  var rows = [];
  var lines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
  lines.forEach(function(line) {
    if (!line.trim()) return;
    var cols = [];
    var cur = '';
    var inQ = false;
    for (var i = 0; i < line.length; i++) {
      var c = line[i];
      if (c === '"') {
        if (inQ && line[i + 1] === '"') { cur += '"'; i++; }
        else inQ = !inQ;
      } else if (c === ',' && !inQ) {
        cols.push(cur.trim());
        cur = '';
      } else {
        cur += c;
      }
    }
    cols.push(cur.trim());
    rows.push(cols);
  });
  return rows;
}

function hideImportModal() {
  document.getElementById('csvOv').classList.remove('show');
}

function showImportPreview(rows) {
  if (rows.length < 2) {
    showToast('CSV must have a header row and at least one data row');
    return;
  }

  /* Skip header row, group tasks by section */
  var sectionMap = {};  /* lowercase title -> { displayTitle, tasks[] } */
  var skipped = 0;
  var totalTasks = 0;

  rows.slice(1).forEach(function(row) {
    if (row.length < 2 || !row[0] || !row[1]) { skipped++; return; }
    if (totalTasks >= 200) { skipped++; return; }
    var key = row[0].toLowerCase();
    if (!sectionMap[key]) sectionMap[key] = { displayTitle: row[0], tasks: [] };
    sectionMap[key].tasks.push(row[1]);
    totalTasks++;
  });

  if (totalTasks === 0) {
    showToast('No valid rows found — check CSV format (section, task)');
    return;
  }

  /* Determine new vs existing sections */
  var existingTitles = {};
  (appData.sections || []).forEach(function(sec) {
    existingTitles[sec.title.toLowerCase()] = sec;
  });

  var previewItems = Object.keys(sectionMap).map(function(key) {
    return {
      title: sectionMap[key].displayTitle,
      tasks: sectionMap[key].tasks,
      isNew: !existingTitles[key]
    };
  });

  var newCount = previewItems.filter(function(i) { return i.isNew; }).length;

  /* Build modal */
  var box = document.getElementById('csvBox');
  var html = '<h2>\ud83d\udce5 Import Preview</h2>';
  html += '<p><strong>' + totalTasks + '</strong> task' + (totalTasks !== 1 ? 's' : '') +
          ' across <strong>' + previewItems.length + '</strong> section' +
          (previewItems.length !== 1 ? 's' : '') +
          (newCount ? ' &mdash; <strong>' + newCount + '</strong> new section' + (newCount !== 1 ? 's' : '') + ' will be created' : '') +
          '.</p>';

  html += '<div class="csv-hint">Expected format: <code>section, task</code> (first row is header)</div>';

  previewItems.forEach(function(item) {
    html +=
      '<div class="csv-sec-item ' + (item.isNew ? 'new-sec' : 'exist-sec') + '">' +
        '<span>' + escHtml(item.title) +
          ' <span style="color:var(--text-muted);font-size:.76rem">(' + item.tasks.length + ')</span>' +
        '</span>' +
        '<span class="csv-sec-badge ' + (item.isNew ? 'new' : 'exist') + '">' +
          (item.isNew ? 'New' : 'Existing') +
        '</span>' +
      '</div>';
  });

  if (skipped > 0) {
    html += '<div style="font-size:.76rem;color:var(--text-muted);margin-top:8px">' +
            skipped + ' row(s) skipped (blank section/task or over 200-row limit)</div>';
  }

  html +=
    '<div class="csv-actions">' +
      '<button class="csv-btn-cancel" id="csvCancelBtn">Cancel</button>' +
      '<button class="csv-btn-confirm" id="csvConfirmBtn">Import All</button>' +
    '</div>';

  box.innerHTML = html;

  document.getElementById('csvCancelBtn').addEventListener('click', hideImportModal);
  document.getElementById('csvConfirmBtn').addEventListener('click', function() {
    executeImport(previewItems, existingTitles);
    hideImportModal();
  });

  document.getElementById('csvOv').classList.add('show');
}

function executeImport(previewItems, existingTitles) {
  var totalAdded = 0;
  var sectionsCreated = 0;

  previewItems.forEach(function(item) {
    var key = item.title.toLowerCase();
    var sec = existingTitles[key];
    if (!sec) {
      sec = { id: uid(), title: item.title, icon: '\ud83d\udccb', priority: false, tasks: [], groupId: null };
      appData.sections.push(sec);
      sectionsCreated++;
    }
    item.tasks.forEach(function(text) {
      if (text.trim()) {
        sec.tasks.push({ id: uid(), text: text.trim(), done: false, tags: [] });
        totalAdded++;
      }
    });
  });

  save();
  showToast(
    'Imported ' + totalAdded + ' task' + (totalAdded !== 1 ? 's' : '') +
    (sectionsCreated ? ' (+' + sectionsCreated + ' new section' + (sectionsCreated !== 1 ? 's' : '') + ')' : '')
  );
}

/* ================================================================
   CSV EXPORT
   ================================================================ */
function exportCSV() {
  var q = function(s) { return '"' + String(s || '').replace(/"/g, '""') + '"'; };
  var rows = ['section,task,status,priority,due_date,tags,description,notes,subtasks'];
  (appData.sections || []).forEach(function(sec) {
    (sec.tasks || []).forEach(function(task) {
      var tagNames = (task.tags || []).map(function(tid) {
        var tag = findTag(tid);
        return tag ? tag.name : '';
      }).filter(Boolean).join('|');
      var status = task.status || (task.done ? 'done' : 'todo');
      var subtaskTxt = (task.subtasks || []).map(function(s) {
        return (s.done ? '[x] ' : '[ ] ') + s.text;
      }).join(' | ');
      rows.push(
        q(sec.title) + ',' +
        q(task.text) + ',' +
        q(status) + ',' +
        q(task.priority || '') + ',' +
        q(task.dueDate || '') + ',' +
        q(tagNames) + ',' +
        q(task.desc || '') + ',' +
        q(task.notes || '') + ',' +
        q(subtaskTxt)
      );
    });
  });
  var csv = rows.join('\n');
  var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'bozzone-tasks-' + new Date().toISOString().slice(0, 10) + '.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast('Downloaded ' + (rows.length - 1) + ' task' + (rows.length - 1 !== 1 ? 's' : ''));
}

/* ================================================================
   TAG MANAGEMENT MODAL
   ================================================================ */
function showTagMgmt() {
  renderTagMgmt();
  document.getElementById('tmOv').classList.add('show');
}

function hideTagMgmt() {
  document.getElementById('tmOv').classList.remove('show');
}

function renderTagMgmt() {
  var box = document.getElementById('tmBox');
  var tags = appData.tags || [];

  var html = '<h2>Manage Tags</h2>';
  html += '<div class="tm-list">';
  if (!tags.length) {
    html += '<div style="padding:10px 0;color:var(--text-muted);font-size:.84rem;font-style:italic">No tags yet</div>';
  }
  tags.forEach(function(tag) {
    html +=
      '<div class="tm-item" data-tag-id="' + tag.id + '">' +
        '<span class="tm-color" style="background:' + tag.color + ';cursor:pointer" title="Click to change color" data-action="cycle-color" data-tag-id="' + tag.id + '"></span>' +
        '<input class="tm-edit-name" data-action="edit-name" data-tag-id="' + tag.id + '" value="' + escHtml(tag.name) + '" title="Edit tag name">' +
        '<button class="tm-del" data-tag-id="' + tag.id + '" title="Delete tag">&times;</button>' +
      '</div>';
  });
  html += '</div>';

  html += '<div class="tm-divider"></div>';
  html += '<div class="tm-subtitle">Add new tag</div>';
  html += '<div class="tm-add-row"><input class="tm-add-input" id="tmNewName" placeholder="Tag name\u2026"></div>';
  html += '<div class="tm-colors" id="tmColors"></div>';
  html += '<button class="tm-add-btn" id="tmAddBtn">Add Tag</button>';
  html += '<button class="tm-close" id="tmCloseBtn">Done</button>';

  box.innerHTML = html;

  /* Color swatches */
  var colorRow = document.getElementById('tmColors');
  newTagColor = TAG_COLORS[0];
  TAG_COLORS.forEach(function(c) {
    var sw = document.createElement('span');
    sw.className = 'tm-color-opt' + (c === newTagColor ? ' sel' : '');
    sw.style.background = c;
    sw.addEventListener('click', function() {
      colorRow.querySelectorAll('.tm-color-opt').forEach(function(s) { s.classList.remove('sel'); });
      sw.classList.add('sel');
      newTagColor = c;
    });
    colorRow.appendChild(sw);
  });

  /* Delete tag handlers */
  box.querySelectorAll('.tm-del').forEach(function(btn) {
    btn.addEventListener('click', function() {
      deleteTag(btn.dataset.tagId);
      renderTagMgmt();
    });
  });

  /* Inline name edit */
  box.querySelectorAll('.tm-edit-name').forEach(function(inp) {
    inp.addEventListener('change', function() {
      var v = inp.value.trim();
      if (v) {
        var tag = (appData.tags || []).filter(function(t) { return t.id === inp.dataset.tagId; })[0];
        if (tag) { tag.name = v; save(); renderFilterBar(); }
      }
    });
  });

  /* Color cycle on swatch click */
  box.querySelectorAll('[data-action="cycle-color"]').forEach(function(sw) {
    sw.addEventListener('click', function() {
      var tag = (appData.tags || []).filter(function(t) { return t.id === sw.dataset.tagId; })[0];
      if (!tag) return;
      var idx = TAG_COLORS.indexOf(tag.color);
      tag.color = TAG_COLORS[(idx + 1) % TAG_COLORS.length];
      save();
      renderTagMgmt();
    });
  });

  /* Add tag */
  document.getElementById('tmAddBtn').addEventListener('click', function() {
    var name = document.getElementById('tmNewName').value.trim();
    if (name) {
      addTag(name, newTagColor);
      renderTagMgmt();
    }
  });
  document.getElementById('tmNewName').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      var name = this.value.trim();
      if (name) { addTag(name, newTagColor); renderTagMgmt(); }
    }
  });

  /* Close */
  document.getElementById('tmCloseBtn').addEventListener('click', hideTagMgmt);
}

/* Close tag mgmt on overlay click */
document.getElementById('tmOv').addEventListener('click', function(e) {
  if (e.target === this) hideTagMgmt();
});

/* ================================================================
   SORTABLEJS — touch-friendly drag & drop
   ================================================================ */
function initSortables() {
  if (typeof Sortable === 'undefined') return;

  document.querySelectorAll('.task-list').forEach(function(el) {
    Sortable.create(el, {
      group: 'tasks',
      handle: '.drag-handle',
      animation: 180,
      ghostClass: 'task-ghost',
      chosenClass: 'task-chosen',
      fallbackOnBody: true,
      swapThreshold: 0.65,
      onStart: function() { isDragging = true; },
      onEnd: function(evt) {
        isDragging = false;
        var taskId    = evt.item.dataset.taskId;
        var fromSecId = evt.from.dataset.sectionId;
        var toSecId   = evt.to.dataset.sectionId;
        handleMove(fromSecId, toSecId, taskId, evt.newIndex);
      }
    });
  });
}

/* ================================================================
   TOAST / UNDO
   ================================================================ */
var toastTimer  = null;
var toastUndoFn = null;

function showToast(msg, undoFn) {
  var t = document.getElementById('toast');
  document.getElementById('toastMsg').textContent = msg;
  toastUndoFn = undoFn || null;
  document.getElementById('toastUndo').style.display = undoFn ? '' : 'none';
  t.classList.add('show');
  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(hideToast, 5000);
}

function hideToast() {
  document.getElementById('toast').classList.remove('show');
  toastUndoFn = null;
  if (toastTimer) { clearTimeout(toastTimer); toastTimer = null; }
}

document.getElementById('toastUndo').addEventListener('click', function() {
  if (toastUndoFn) toastUndoFn();
  hideToast();
});

/* ================================================================
   SYNC-KEY UI
   ================================================================ */
function showOv() {
  document.getElementById('ov').style.display = 'flex';
  var inp = document.getElementById('keyIn');
  inp.value = syncKey || '';
  inp.focus();
}
function hideOv() {
  document.getElementById('ov').style.display = 'none';
}

document.getElementById('keyGo').addEventListener('click', function() {
  var v = document.getElementById('keyIn').value.trim().toLowerCase().replace(/[^a-z0-9\-]/g, '');
  if (!v) { document.getElementById('keyIn').style.borderColor = '#F44336'; return; }
  syncKey = v;
  localStorage.setItem('bozzone-sync-key', syncKey);
  hideOv();
  if (fbReady) startSync();
  else document.getElementById('keyLbl').textContent = syncKey;
});

document.getElementById('keyIn').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') document.getElementById('keyGo').click();
});

document.getElementById('gearBtn').addEventListener('click', showOv);
document.getElementById('keyLbl').addEventListener('click', showOv);

/* ================================================================
   INIT
   ================================================================ */
if (!syncKey) showOv();

loadLS();
if (!appData.sections || !appData.sections.length) {
  appData = buildInitialData();
}
appData = ensureArrays(appData);   /* ensure groups[] and groupId fields exist */
render();
initFB();

/* Service worker */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(function() {});
}

/* CSV file input handler */
document.getElementById('csvFileInput').addEventListener('change', function() {
  var file = this.files[0];
  if (!file) return;
  if (!file.name.toLowerCase().endsWith('.csv')) {
    showToast('Please select a .csv file');
    return;
  }
  var reader = new FileReader();
  reader.onload = function(e) {
    var rows = parseCSV(e.target.result);
    showImportPreview(rows);
  };
  reader.readAsText(file);
});

/* Close CSV modal on overlay click */
document.getElementById('csvOv').addEventListener('click', function(e) {
  if (e.target === this) hideImportModal();
});

/* ── Search bar ── */
(function() {
  var inp   = document.getElementById('searchInput');
  var clear = document.getElementById('searchClear');
  inp.addEventListener('input', function() {
    setSearch(inp.value);
    clear.classList.toggle('show', inp.value.length > 0);
  });
  clear.addEventListener('click', function() {
    inp.value = '';
    clear.classList.remove('show');
    setSearch('');
  });
})();

/* ── New Task Modal ── */
document.getElementById('ntOv').addEventListener('click', function(e) {
  if (e.target === this) hideNewTaskModal();
});
document.getElementById('ntCancel').addEventListener('click', hideNewTaskModal);
document.getElementById('ntCreate').addEventListener('click', function() {
  var title = document.getElementById('ntTitle').value.trim();
  if (!title) { document.getElementById('ntTitle').focus(); return; }
  var secId = document.getElementById('ntSection').value;
  createTask(secId, {
    text:     title,
    desc:     document.getElementById('ntDesc').value,
    notes:    document.getElementById('ntNotes').value,
    status:   document.getElementById('ntStatus').value,
    priority: document.getElementById('ntPriority').value || null,
    dueDate:  document.getElementById('ntDueDate').value  || null,
    subtasks: ntPendingSubtasks.slice()
  });
  hideNewTaskModal();
});

/* Sub-task add button in modal */
document.getElementById('ntSubAdd').addEventListener('click', function() {
  var inp = document.getElementById('ntSubInput');
  var v   = inp.value.trim();
  if (v) {
    ntPendingSubtasks.push({ text: v, done: false });
    renderNtSubtasks();
    inp.value = '';
    inp.focus();
  }
});
document.getElementById('ntSubInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('ntSubAdd').click();
  }
});
document.getElementById('ntTitle').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('ntCreate').click();
  }
});

/* ================================================================
   EDITABLE FOCUS HEADER
   ================================================================ */
(function() {
  var FOCUS_KEY = 'bozzone-focus';
  var focusDiv  = document.getElementById('focusDiv');
  var focusTxt  = document.getElementById('focusText');

  /* Restore saved focus text */
  var saved = localStorage.getItem(FOCUS_KEY);
  if (saved) focusTxt.textContent = saved;

  focusDiv.addEventListener('click', function() {
    if (focusDiv.querySelector('input')) return; /* already editing */
    var inp = document.createElement('input');
    inp.type = 'text';
    inp.className = 'focus-input';
    inp.value = focusTxt.textContent;
    focusTxt.style.display = 'none';
    focusDiv.appendChild(inp);
    inp.focus(); inp.select();
    function commit() {
      var v = inp.value.trim();
      if (v) {
        focusTxt.textContent = v;
        localStorage.setItem(FOCUS_KEY, v);
      }
      inp.remove();
      focusTxt.style.display = '';
    }
    inp.addEventListener('blur', commit);
    inp.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') { e.preventDefault(); inp.blur(); }
      if (e.key === 'Escape') {
        inp.removeEventListener('blur', commit);
        inp.remove(); focusTxt.style.display = '';
      }
    });
  });
})();

/* ================================================================
   HIDE COMPLETED TOGGLE
   ================================================================ */
(function() {
  var btn = document.getElementById('hideDoneBtn');
  btn.addEventListener('click', function() {
    hideCompleted = !hideCompleted;
    btn.classList.toggle('active', hideCompleted);
    btn.textContent = hideCompleted ? '✓ Show Done' : '✓ Hide Done';
    render();
  });
})();

/* ================================================================
   DARK MODE
   ================================================================ */
(function() {
  var isDark = localStorage.getItem('bozzone-dark') === '1';
  function applyDark(d) {
    document.documentElement.setAttribute('data-theme', d ? 'dark' : '');
    document.getElementById('darkToggle').textContent = d ? '☀️' : '🌙';
    localStorage.setItem('bozzone-dark', d ? '1' : '0');
    isDark = d;
  }
  applyDark(isDark);
  document.getElementById('darkToggle').addEventListener('click', function() {
    applyDark(!isDark);
  });
  /* expose for keyboard shortcut */
  window._toggleDark = function() { applyDark(!isDark); };
})();

/* ================================================================
   UNDO / REDO
   ================================================================ */
var undoStack = [];
var redoStack = [];
var _origSave = save;

/* Wrap save() to push state to undo stack before every change */
save = function() {
  var snapshot = JSON.stringify(appData);
  /* Only push if different from last snapshot */
  if (!undoStack.length || undoStack[undoStack.length-1] !== snapshot) {
    undoStack.push(snapshot);
    if (undoStack.length > 50) undoStack.shift();
    redoStack = []; /* new action clears redo */
  }
  _origSave();
  updateUndoButtons();
};

function undoAction() {
  if (undoStack.length < 2) return;
  redoStack.push(undoStack.pop());           /* current state → redo */
  appData = ensureArrays(JSON.parse(undoStack[undoStack.length - 1]));
  saveLS();
  if (fbReady && dbRef) dbRef.set(appData);
  else render();
  updateUndoButtons();
  showToast('Undone');
}

function redoAction() {
  if (!redoStack.length) return;
  var next = redoStack.pop();
  undoStack.push(next);
  appData = ensureArrays(JSON.parse(next));
  saveLS();
  if (fbReady && dbRef) dbRef.set(appData);
  else render();
  updateUndoButtons();
  showToast('Redone');
}

function updateUndoButtons() {
  document.getElementById('undoBtn').disabled = undoStack.length < 2;
  document.getElementById('redoBtn').disabled = redoStack.length === 0;
}

document.getElementById('undoBtn').addEventListener('click', undoAction);
document.getElementById('redoBtn').addEventListener('click', redoAction);

/* Seed initial snapshot after first render */
setTimeout(function() {
  undoStack = [JSON.stringify(appData)];
  updateUndoButtons();
}, 800);

/* ================================================================
   BULK ACTIONS
   ================================================================ */
function enterBulkMode() {
  bulkMode = true;
  document.body.classList.add('bulk-mode');
  render();
  updateBulkBar();
}

function exitBulkMode() {
  bulkMode = false;
  bulkSelected = {};
  document.body.classList.remove('bulk-mode');
  document.getElementById('bulkBar').classList.remove('show');
  render();
}

function updateBulkBar() {
  var ids = Object.keys(bulkSelected);
  var bar = document.getElementById('bulkBar');
  var cnt = document.getElementById('bulkCount');
  cnt.textContent = ids.length + ' selected';

  /* Populate move-to dropdown */
  var sel = document.getElementById('bulkMoveSel');
  sel.innerHTML = '<option value="">Move to…</option>';
  (appData.sections || []).forEach(function(sec) {
    var opt = document.createElement('option');
    opt.value = sec.id;
    opt.textContent = (sec.icon || '') + ' ' + sec.title.slice(0,20);
    sel.appendChild(opt);
  });

  bar.classList.toggle('show', ids.length > 0);
}

document.getElementById('bulkMoveBtn').addEventListener('click', function() {
  var toSecId = document.getElementById('bulkMoveSel').value;
  if (!toSecId) return;
  var ids = Object.keys(bulkSelected);
  if (!ids.length) return;
  var toSec = findSec(toSecId);
  if (!toSec) return;
  ids.forEach(function(tid) {
    (appData.sections || []).forEach(function(sec) {
      var idx = -1;
      (sec.tasks || []).forEach(function(t, i) { if (t.id === tid) idx = i; });
      if (idx !== -1) {
        var t = sec.tasks.splice(idx, 1)[0];
        if (sec.id !== toSecId) toSec.tasks.push(t);
        else sec.tasks.splice(idx, 0, t); /* same section — put back */
      }
    });
  });
  bulkSelected = {};
  save();
  showToast('Moved ' + ids.length + ' task' + (ids.length!==1?'s':''));
  exitBulkMode();
});

document.getElementById('bulkHighBtn').addEventListener('click', function() {
  var ids = Object.keys(bulkSelected);
  ids.forEach(function(tid) {
    (appData.sections||[]).forEach(function(sec){
      (sec.tasks||[]).forEach(function(t){ if(t.id===tid) t.priority='high'; });
    });
  });
  save(); showToast('Set High priority on ' + ids.length + ' task' + (ids.length!==1?'s':''));
  exitBulkMode();
});

document.getElementById('bulkMedBtn').addEventListener('click', function() {
  var ids = Object.keys(bulkSelected);
  ids.forEach(function(tid) {
    (appData.sections||[]).forEach(function(sec){
      (sec.tasks||[]).forEach(function(t){ if(t.id===tid) t.priority='medium'; });
    });
  });
  save(); showToast('Set Medium priority on ' + ids.length + ' task' + (ids.length!==1?'s':''));
  exitBulkMode();
});

document.getElementById('bulkDoneBtn').addEventListener('click', function() {
  var ids = Object.keys(bulkSelected);
  ids.forEach(function(tid) {
    (appData.sections||[]).forEach(function(sec){
      (sec.tasks||[]).forEach(function(t){
        if(t.id===tid){ t.status='done'; t.done=true; }
      });
    });
  });
  save(); showToast('Marked ' + ids.length + ' task' + (ids.length!==1?'s':'') + ' done');
  exitBulkMode();
});

document.getElementById('bulkDelBtn').addEventListener('click', function() {
  var ids = Object.keys(bulkSelected);
  if (!ids.length) return;
  /* Snapshot for undo */
  var snap = JSON.stringify(appData);
  ids.forEach(function(tid) {
    (appData.sections||[]).forEach(function(sec){
      sec.tasks = (sec.tasks||[]).filter(function(t){ return t.id !== tid; });
    });
  });
  save();
  showToast('Deleted ' + ids.length + ' task' + (ids.length!==1?'s':''), function() {
    appData = ensureArrays(JSON.parse(snap));
    saveLS();
    if (fbReady && dbRef) dbRef.set(appData);
    else render();
  });
  exitBulkMode();
});

document.getElementById('bulkCancelBtn').addEventListener('click', exitBulkMode);

/* ================================================================
   TASK TEMPLATES
   ================================================================ */
function loadTemplates() {
  try { return JSON.parse(localStorage.getItem('bozzone-templates') || '[]'); } catch(e) { return []; }
}
function saveTemplates(tpls) {
  try { localStorage.setItem('bozzone-templates', JSON.stringify(tpls)); } catch(e) {}
}

function saveTaskAsTemplate(task) {
  var name = prompt('Template name:', task.text.slice(0, 40));
  if (!name || !name.trim()) return;
  var tpls = loadTemplates();
  tpls.push({
    id:       uid(),
    name:     name.trim(),
    text:     task.text,
    desc:     task.desc  || '',
    notes:    task.notes || '',
    priority: task.priority || null,
    subtasks: (task.subtasks || []).map(function(s) { return { text: s.text }; })
  });
  saveTemplates(tpls);
  showToast('Template "' + name.trim() + '" saved');
}

function showTemplateModal(targetSecId) {
  renderTemplateModal(targetSecId);
  document.getElementById('tplOv').classList.add('show');
}
function hideTemplateModal() {
  document.getElementById('tplOv').classList.remove('show');
}

function renderTemplateModal(targetSecId) {
  var box = document.getElementById('tplBox');
  var tpls = loadTemplates();
  var secs = appData.sections || [];

  var html = '<h2>📋 Task Templates</h2>';

  /* Saved templates list */
  if (!tpls.length) {
    html += '<div class="tpl-empty">No templates saved yet.<br>Click 📋 on any task to save it as a template.</div>';
  } else {
    html += '<div class="tpl-section-lbl">Saved Templates</div>';
    html += '<div class="tpl-list" id="tplList">';
    tpls.forEach(function(tpl) {
      var subCount = (tpl.subtasks || []).length;
      html +=
        '<div class="tpl-item" data-tpl-id="' + tpl.id + '">' +
          '<div class="tpl-item-body">' +
            '<div class="tpl-item-title">' + escHtml(tpl.name) + '</div>' +
            '<div class="tpl-item-meta">' +
              (tpl.priority ? '⬆ ' + tpl.priority + ' · ' : '') +
              (subCount ? subCount + ' subtask' + (subCount!==1?'s':'') : 'No subtasks') +
            '</div>' +
          '</div>' +
          '<button class="tpl-item-del" data-tpl-del="' + tpl.id + '" title="Delete template">&times;</button>' +
        '</div>';
    });
    html += '</div>';
    html += '<div class="tpl-divider"></div>';
    html += '<div class="tpl-section-lbl">Use in section</div>';
    html += '<select class="tpl-pick-sel" id="tplSecSel">';
    secs.forEach(function(sec) {
      html += '<option value="' + sec.id + '"' + (sec.id === targetSecId ? ' selected' : '') + '>' +
              (sec.icon||'') + ' ' + escHtml(sec.title) + '</option>';
    });
    html += '</select>';
    html += '<div class="tpl-pick-hint">Click a template above to create a task from it.</div>';
  }

  html += '<div class="tpl-divider"></div>';
  html += '<button class="tpl-close" id="tplCloseBtn">Done</button>';
  box.innerHTML = html;

  /* Delete handlers */
  box.querySelectorAll('[data-tpl-del]').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      var delId = btn.dataset.tplDel;
      var tpls2 = loadTemplates().filter(function(t) { return t.id !== delId; });
      saveTemplates(tpls2);
      renderTemplateModal(targetSecId);
      showToast('Template deleted');
    });
  });

  /* Apply template handlers */
  box.querySelectorAll('.tpl-item-body').forEach(function(body) {
    body.addEventListener('click', function() {
      var tplId = body.closest('.tpl-item').dataset.tplId;
      var tpl   = loadTemplates().filter(function(t) { return t.id === tplId; })[0];
      if (!tpl) return;
      var secId = document.getElementById('tplSecSel') ?
                  document.getElementById('tplSecSel').value : (targetSecId || (secs[0]||{}).id);
      createTask(secId, {
        text:     tpl.text,
        desc:     tpl.desc,
        notes:    tpl.notes,
        priority: tpl.priority,
        subtasks: (tpl.subtasks||[]).map(function(s){ return { text: s.text, done: false }; })
      });
      hideTemplateModal();
      showToast('Task created from template "' + tpl.name + '"');
    });
  });

  document.getElementById('tplCloseBtn').addEventListener('click', hideTemplateModal);
}

document.getElementById('tplOv').addEventListener('click', function(e) {
  if (e.target === this) hideTemplateModal();
});

/* ================================================================
   KEYBOARD SHORTCUTS
   ================================================================ */
(function() {
  var kbdOpen = false;
  var kbdBtn  = document.getElementById('kbdBtn');
  var kbdPanel = document.getElementById('kbdPanel');

  kbdBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    kbdOpen = !kbdOpen;
    kbdPanel.classList.toggle('show', kbdOpen);
  });
  document.addEventListener('click', function() {
    if (kbdOpen) { kbdOpen = false; kbdPanel.classList.remove('show'); }
  });

  document.addEventListener('keydown', function(e) {
    var tag  = (document.activeElement || {}).tagName || '';
    var inInput = tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT';

    /* Ctrl/Cmd+Z — Undo */
    if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
      e.preventDefault();
      undoAction();
      return;
    }
    /* Ctrl/Cmd+Y or Ctrl+Shift+Z — Redo */
    if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
      e.preventDefault();
      redoAction();
      return;
    }

    /* Escape — close any open modal */
    if (e.key === 'Escape') {
      if (document.getElementById('ntOv').classList.contains('show'))  { hideNewTaskModal(); return; }
      if (document.getElementById('tplOv').classList.contains('show')) { hideTemplateModal(); return; }
      if (document.getElementById('tpOv').classList.contains('show'))  { hideTagPicker(); return; }
      if (document.getElementById('tmOv').classList.contains('show'))  { hideTagMgmt(); return; }
      if (document.getElementById('csvOv').classList.contains('show')) { hideImportModal(); return; }
      if (bulkMode) { exitBulkMode(); return; }
      if (kbdOpen)  { kbdOpen = false; kbdPanel.classList.remove('show'); return; }
      if (activeView) { activeView = null; render(); return; }
      return;
    }

    if (inInput) return; /* don't intercept typing */

    switch (e.key.toLowerCase()) {
      case 'n':
        /* New task — open modal targeting first section */
        e.preventDefault();
        var firstSec = (appData.sections || [])[0];
        if (firstSec) showNewTaskModal(firstSec.id);
        break;
      case '/':
        e.preventDefault();
        document.getElementById('searchInput').focus();
        break;
      case 'd':
        e.preventDefault();
        window._toggleDark();
        break;
      case 't':
        e.preventDefault();
        var fs = (appData.sections || [])[0];
        showTemplateModal(fs ? fs.id : null);
        break;
      case 'b':
        e.preventDefault();
        if (bulkMode) exitBulkMode();
        else          enterBulkMode();
        break;
    }
  });
})();

/* ================================================================
   "Templates" button in the board action area
   ================================================================ */
/* Expose template modal trigger globally so render() can wire it */
window._showTpl = showTemplateModal;
</script>
</body>
</html>
